var Cr=Object.defineProperty,Lr=Object.defineProperties;var wr=Object.getOwnPropertyDescriptors;var dt=Object.getOwnPropertySymbols,_r=Object.getPrototypeOf,Fi=Object.prototype.hasOwnProperty,Gi=Object.prototype.propertyIsEnumerable,Hr=Reflect.get;var xi=(n,e,t)=>e in n?Cr(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,m=(n,e)=>{for(var t in e||(e={}))Fi.call(e,t)&&xi(n,t,e[t]);if(dt)for(var t of dt(e))Gi.call(e,t)&&xi(n,t,e[t]);return n},y=(n,e)=>Lr(n,wr(e));var oi=(n,e)=>{var t={};for(var i in n)Fi.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&dt)for(var i of dt(n))e.indexOf(i)<0&&Gi.call(n,i)&&(t[i]=n[i]);return t};var Dr=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var H=(n,e,t)=>Hr(_r(n),t,e);var d=(n,e,t)=>new Promise((i,r)=>{var s=l=>{try{o(t.next(l))}catch(p){r(p)}},a=l=>{try{o(t.throw(l))}catch(p){r(p)}},o=l=>l.done?i(l.value):Promise.resolve(l.value).then(s,a);o((t=t.apply(n,e)).next())});var gi=Dr((xa,Kr)=>{Kr.exports={name:"@100mslive/hms-video",version:"0.9.28",license:"MIT",main:"dist/index.cjs.js",typings:"dist/index.d.ts",module:"dist/index.js",files:["dist","src"],engines:{node:">=10"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",test:"jest --maxWorkers=1",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",format:"prettier --write src/**/*.ts"},author:"100ms <tech-common@100ms.live>",devDependencies:{"@types/dom-screen-wake-lock":"^1.0.1","@types/sdp-transform":"^2.4.4","@types/ua-parser-js":"^0.7.36","@types/uuid":"^8.3.0","jest-canvas-mock":"^2.3.1","jsdom-worker":"^0.3.0",tslib:"^2.2.0"},dependencies:{eventemitter2:"^6.4.7","sdp-transform":"^2.14.1","ua-parser-js":"^1.0.1",uuid:"^8.3.2","webrtc-adapter":"^8.0.0"},gitHead:"2616c7f5408ccbe73ba402514ca7b87b310d377c"}});var ce=class{constructor({sender:e,message:t,type:i="chat",recipientPeer:r,recipientRoles:s,time:a,id:o}){this.sender=e,this.message=t,this.type=i,this.recipientPeer=r,this.recipientRoles=s,this.time=a,this.id=o}toSignalParams(){var r,s;let e=(r=this.recipientRoles)==null?void 0:r.map(a=>a.name),t=(s=this.recipientPeer)==null?void 0:s.peerId,i={info:{message:this.message,type:this.type}};return e!=null&&e.length&&(i.roles=e),t&&(i.peer_id=t),i}toString(){var e;return`{
      sender: ${this.sender};
      recipientPeer: ${this.recipientPeer};
      recipientRoles: ${(e=this.recipientRoles)==null?void 0:e.map(t=>t.name)};
      message: ${this.message};
      time: ${this.time};
      type: ${this.type};
      id: ${this.id}
    }`}};var De=class{constructor(e){this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}};this.rtmp={running:!1};this.hls={running:!1,variants:[]};this.id=e}};var fe="renegotiation-callback-id",lt="ion-sfu";var Ee="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID";var Ui="https://event.100ms.live/v2/client/report",Bi="https://event-nonprod.100ms.live/v2/client/report";var C={DEVICE_CHANGE:"device-change",LOCAL_AUDIO_ENABLED:"local-audio-enabled",LOCAL_VIDEO_ENABLED:"local-video-enabled",STATS_UPDATE:"stats-update",RTC_STATS_UPDATE:"rtc-stats-update",TRACK_DEGRADED:"track-degraded",TRACK_RESTORED:"track-restored",TRACK_AUDIO_LEVEL_UPDATE:"track-audio-level-update",LOCAL_AUDIO_SILENCE:"local-audio-silence",ANALYTICS:"analytics",AUDIO_PLUGIN_FAILED:"audio-plugin-failed",POLICY_CHANGE:"policy-change",LOCAL_ROLE_UPDATE:"local-role-update",AUDIO_TRACK_UPDATE:"audio-track-update",AUDIO_TRACK_ADDED:"audio-track-added",AUDIO_TRACK_REMOVED:"audio-track-removed",AUTOPLAY_ERROR:"autoplay-error",LEAVE:"leave"},Vi="2.5",Wi="20231201",Q="_handraise",ci=1e3,di=64;var de=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:r,metadata:s,role:a,joinedAt:o,groups:l,realtime:p}){this.customerUserId="";this.metadata="";this.auxiliaryTracks=[];this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=r,this.metadata=s,this.joinedAt=o,this.groups=l,this.realtime=p,a&&(this.role=a)}get isHandRaised(){var e;return!!((e=this.groups)!=null&&e.includes(Q))}updateRole(e){this.role=e}updateName(e){this.name=e}updateNetworkQuality(e){this.networkQuality=e}updateMetadata(e){this.metadata=e}updateGroups(e){this.groups=e}toString(){var e,t,i,r;return`{
      name: ${this.name};
      role: ${(e=this.role)==null?void 0:e.name};
      peerId: ${this.peerId};
      customerUserId: ${this.customerUserId};
      ${this.audioTrack?`audioTrack: ${(t=this.audioTrack)==null?void 0:t.trackId};`:""}
      ${this.videoTrack?`videoTrack: ${(i=this.videoTrack)==null?void 0:i.trackId};`:""}
      groups: ${(r=this.groups)==null?void 0:r.join()}
    }`}};import{v4 as Or}from"uuid";var Pe=class{};Pe.makePeerId=()=>Or();var Oe=class extends de{constructor(t){super(y(m({},t),{peerId:Pe.makePeerId(),isLocal:!0}));this.isLocal=!0;this.auxiliaryTracks=[];this.asRole=t.asRole}isInPreview(){return!!this.asRole}toString(){var t,i,r;return`{
      name: ${this.name};
      role: ${(t=this.role)==null?void 0:t.name};
      peerId: ${this.peerId};
      customerUserId: ${this.customerUserId};
      ${this.asRole?`asRole: ${this.asRole.name};`:""}
      ${this.audioTrack?`audioTrack: ${(i=this.audioTrack)==null?void 0:i.trackId};`:""}
      ${this.videoTrack?`videoTrack: ${(r=this.videoTrack)==null?void 0:r.trackId};`:""}
    }`}};var Ne=class extends de{constructor(t){super(y(m({},t),{isLocal:!1}));this.isLocal=!1;this.auxiliaryTracks=[];this.fromRoomState=!1;this.fromRoomState=!!t.fromRoomState}};var B=(n,e)=>new Ne({peerId:n.peer_id,name:n.info.name,role:e.getPolicyForRole(n.role),customerUserId:n.info.user_id,metadata:n.info.data,groups:n.groups});var ut=class{constructor(e,t,i){this.transport=e;this.store=t;this.options=i;this.isEnd=!1;this.iterator=null;this.total=0;this.defaultPaginationLimit=10}validateConnection(){if(!this.transport||!this.store)throw Error("Use usePaginatedParticipants or hmsActions.getPeerListIterator after preview or join has happened")}hasNext(){return!this.isEnd}getTotal(){return this.total}findPeers(){return d(this,null,function*(){var t;this.validateConnection();let e=yield this.transport.findPeers(y(m({},this.options||{}),{limit:((t=this.options)==null?void 0:t.limit)||this.defaultPaginationLimit}));return this.updateState(e),this.processPeers(e.peers)})}next(){return d(this,null,function*(){var t;this.validateConnection();let e;return!this.iterator&&!this.isEnd?yield this.findPeers():this.iterator?(e=yield this.transport.peerIterNext({iterator:this.iterator,limit:((t=this.options)==null?void 0:t.limit)||this.defaultPaginationLimit}),this.updateState(e),this.processPeers(e.peers)):[]})}processPeers(e){let t=[];return e.forEach(i=>{let r=B(i,this.store);t.push(r)}),t}updateState(e){this.isEnd=e.eof,this.total=e.total,e.iterator&&(this.iterator=e.iterator)}};import{v4 as gs}from"uuid";import{v4 as qr}from"uuid";import{UAParser as Nr}from"ua-parser-js";var le=new Nr,L=typeof window!="undefined",$i,ue=typeof window=="undefined"&&!(($i=le.getBrowser().name)!=null&&$i.toLowerCase().includes("electron")),pt=(i=>(i.PROD="prod",i.QA="qa",i.DEV="dev",i))(pt||{}),xr=()=>!ue,na=xr(),ht=()=>le.getDevice().type==="mobile",Ki=()=>typeof document!="undefined"&&document.hidden,li=()=>{var n;return((n=le.getOS().name)==null?void 0:n.toLowerCase())==="ios"};function Gr(){if(L&&window){let n=window.location.hostname;return n==="localhost"||n==="127.0.0.1"?"LOCAL":n.includes("app.100ms.live")?"HMS":"CUSTOM"}return"CUSTOM"}var ye=Gr();import{v4 as $r}from"uuid";var Ur=(l=>(l[l.VERBOSE=0]="VERBOSE",l[l.DEBUG=1]="DEBUG",l[l.INFO=2]="INFO",l[l.WARN=3]="WARN",l[l.TIME=4]="TIME",l[l.TIMEEND=5]="TIMEEND",l[l.ERROR=6]="ERROR",l[l.NONE=7]="NONE",l))(Ur||{}),Br=typeof window!="undefined"&&typeof window.expect!="undefined",c=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:{console.log(t,...i);break}case 1:{console.debug(t,...i);break}case 2:{console.info(t,...i);break}case 3:{console.warn(t,...i);break}case 6:{console.error(t,...i);break}case 4:{performance.mark(i[0]);break}case 5:{let r=i[0];try{let s=performance.measure(r,r);this.log(1,t,r,s==null?void 0:s.duration),performance.clearMarks(r),performance.clearMeasures(r)}catch(s){this.log(1,t,r,s)}break}}}};c.level=Br?7:0;var E={WebSocketConnectionErrors:{FAILED_TO_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003,ABNORMAL_CLOSE:1006},APIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3004,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010,SYSTEM_DENIED_PERMISSION:3011,CURRENT_TAB_NOT_SHARED:3012,AUDIO_PLAYBACK_ERROR:3013,SELECTED_DEVICE_MISSING:3014},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005,ICE_DISCONNECTED:4006,STATS_FAILED:4007},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011,LOCAL_STORAGE_ACCESS_DENIED:6012,VALIDATION_FAILED:6013},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}};var S=class n extends Error{constructor(t,i,r,s,a,o=!1){super(s);this.code=t;this.name=i;this.message=s;this.description=a;this.isTerminal=o;Object.setPrototypeOf(this,n.prototype),this.action=r.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(t){this.nativeError=t}toString(){var t;return`{
      code: ${this.code};
      name: ${this.name};
      action: ${this.action};
      message: ${this.message};
      description: ${this.description};
      isTerminal: ${this.isTerminal};
      nativeError: ${(t=this.nativeError)==null?void 0:t.message};
    }`}};function ui(n){switch(n){case"join":return"JOIN";case"offer":return"PUBLISH";case"answer":return"SUBSCRIBE";case"track-update":return"TRACK";default:return"NONE"}}var Wr=["join","offer","answer","trickle","on-error","JOIN"],h={WebSocketConnectionErrors:{FailedToConnect(n,e=""){return new S(E.WebSocketConnectionErrors.FAILED_TO_CONNECT,"WebsocketFailedToConnect",n,`[WS]: ${e}`,`[WS]: ${e}`)},WebSocketConnectionLost(n,e=""){return new S(E.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",n,"Network connection lost ",e)},AbnormalClose(n,e=""){return new S(E.WebSocketConnectionErrors.ABNORMAL_CLOSE,"WebSocketAbnormalClose",n,"Websocket closed abnormally",e)}},APIErrors:{ServerErrors(n,e,t="",i=!0){return new S(n,"ServerErrors",e,`[${e}]: Server error ${t}`,t,i)},EndpointUnreachable(n,e=""){return new S(E.APIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",n,`Endpoint is not reachable - ${e}`,e)},InvalidTokenFormat(n,e=""){return new S(E.APIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",n,`Token is not in proper JWT format - ${e}`,e,!0)},InitConfigNotAvailable(n,e=""){return new S(E.APIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",n,`[INIT]: ${e}`,`[INIT]: ${e}`)}},TracksErrors:{GenericTrack(n,e=""){return new S(E.TracksErrors.GENERIC_TRACK,"GenericTrack",n,`[TRACK]: ${e}`,`[TRACK]: ${e}`)},CantAccessCaptureDevice(n,e,t=""){return new S(E.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",n,`User denied permission to access capture device - ${e}`,t)},DeviceNotAvailable(n,e,t=""){return new S(E.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",n,`[TRACK]: Capture device is no longer available - ${e}`,t)},DeviceInUse(n,e,t=""){return new S(E.TracksErrors.DEVICE_IN_USE,"DeviceInUse",n,`[TRACK]: Capture device is in use by another application - ${e}`,t)},DeviceLostMidway(n,e,t=""){return new S(E.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",n,`Lost access to capture device midway - ${e}`,t)},NothingToReturn(n,e="",t="There is no media to return. Please select either video or audio or both."){return new S(E.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",n,t,e)},InvalidVideoSettings(n,e=""){return new S(E.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",n,"Cannot enable simulcast when no video settings are provided",e)},AutoplayBlocked(n,e=""){return new S(E.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",n,"Autoplay blocked because the user didn't interact with the document first",e)},CodecChangeNotPermitted(n,e=""){return new S(E.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",n,"Codec can't be changed mid call.",e)},OverConstrained(n,e,t=""){return new S(E.TracksErrors.OVER_CONSTRAINED,"OverConstrained",n,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${e}`,t)},NoAudioDetected(n,e="Please check the mic or use another audio input"){return new S(E.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",n,"No audio input detected from microphone",e)},SystemDeniedPermission(n,e,t=""){return new S(E.TracksErrors.SYSTEM_DENIED_PERMISSION,"SystemDeniedPermission",n,`Operating System denied permission to access capture device - ${e}`,t)},CurrentTabNotShared(){return new S(E.TracksErrors.CURRENT_TAB_NOT_SHARED,"CurrentTabNotShared","TRACK","The app requires you to share the current tab","You must screen share the current tab in order to proceed")},AudioPlaybackError(n){return new S(E.TracksErrors.AUDIO_PLAYBACK_ERROR,"Audio playback error","TRACK",n,n)},SelectedDeviceMissing(n){return new S(E.TracksErrors.SELECTED_DEVICE_MISSING,"SelectedDeviceMissing","TRACK",`Could not detect selected ${n} device`,`Please check connection to the ${n} device`,!1)}},WebrtcErrors:{CreateOfferFailed(n,e=""){return new S(E.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",n,`[${n.toString()}]: Failed to create offer. `,e)},CreateAnswerFailed(n,e=""){return new S(E.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",n,`[${n.toString()}]: Failed to create answer. `,e)},SetLocalDescriptionFailed(n,e=""){return new S(E.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",n,`[${n.toString()}]: Failed to set offer. `,e)},SetRemoteDescriptionFailed(n,e=""){return new S(E.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",n,`[${n.toString()}]: Failed to set answer. `,e,!0)},ICEFailure(n,e="",t=!1){return new S(E.WebrtcErrors.ICE_FAILURE,"ICEFailure",n,`[${n.toString()}]: Ice connection state FAILED`,e,t)},ICEDisconnected(n,e=""){return new S(E.WebrtcErrors.ICE_DISCONNECTED,"ICEDisconnected",n,`[${n.toString()}]: Ice connection state DISCONNECTED`,e)},StatsFailed(n,e=""){return new S(E.WebrtcErrors.STATS_FAILED,"StatsFailed",n,`Failed to WebRTC get stats - ${e}`,e)}},WebsocketMethodErrors:{ServerErrors(n,e,t){return new S(n,"ServerErrors",e,t,t,Wr.includes(e))},AlreadyJoined(n,e=""){return new S(E.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",n,"[JOIN]: You have already joined this room.",e)},CannotJoinPreviewInProgress(n,e=""){return new S(E.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",n,"[JOIN]: Cannot join if preview is in progress",e)}},GenericErrors:{NotConnected(n,e=""){return new S(E.GenericErrors.NOT_CONNECTED,"NotConnected",n,"Client is not connected",e)},Signalling(n,e){return new S(E.GenericErrors.SIGNALLING,"Signalling",n,`Unknown signalling error: ${n.toString()} ${e} `,e)},Unknown(n,e){return new S(E.GenericErrors.UNKNOWN,"Unknown",n,`Unknown exception: ${e}`,e)},NotReady(n,e=""){return new S(E.GenericErrors.NOT_READY,"NotReady",n,e,e)},JsonParsingFailed(n,e,t=""){return new S(E.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",n,`Failed to parse JSON message - ${e}`,t)},TrackMetadataMissing(n,e=""){return new S(E.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",n,"Track Metadata Missing",e)},RTCTrackMissing(n,e=""){return new S(E.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",n,"RTC Track missing",e)},PeerMetadataMissing(n,e=""){return new S(E.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",n,"Peer Metadata Missing",e)},ValidationFailed(n,e){return new S(E.GenericErrors.VALIDATION_FAILED,"ValidationFailed","VALIDATION",n,e?JSON.stringify(e):"")},InvalidRole(n,e){return new S(E.GenericErrors.INVALID_ROLE,"InvalidRole",n,"Invalid role. Join with valid role",e,!0)},PreviewAlreadyInProgress(n,e=""){return new S(E.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",n,"[Preview]: Cannot join if preview is in progress",e)},LocalStorageAccessDenied(n="Access to localStorage has been denied"){return new S(E.GenericErrors.LOCAL_STORAGE_ACCESS_DENIED,"LocalStorageAccessDenied","NONE","LocalStorageAccessDenied",n)},MissingMediaDevices(){return new S(E.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices","JOIN","navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0)},MissingRTCPeerConnection(){return new S(E.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection","JOIN","RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)}},MediaPluginErrors:{PlatformNotSupported(n,e=""){return new S(7001,"PlatformNotSupported",n,"Check HMS Docs to see the list of supported platforms",e)},InitFailed(n,e=""){return new S(7002,"InitFailed",n,"Plugin init failed",e)},ProcessingFailed(n,e=""){return new S(7003,"ProcessingFailed",n,"Plugin processing failed",e)},AddAlreadyInProgress(n,e=""){return new S(7004,"AddAlreadyInProgress",n,"Plugin add already in progress",e)},DeviceNotSupported(n,e=""){return new S(7005,"DeviceNotSupported",n,"Check HMS Docs to see the list of supported devices",e)}},PlaylistErrors:{NoEntryToPlay(n,e){return new S(E.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",n,"Reached end of playlist",e)},NoEntryPlaying(n,e){return new S(E.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",n,"No entry is playing at this time",e)}}};var pi=class{constructor(){this.valuesMap=new Map}getItem(e){return this.valuesMap.has(e)?String(this.valuesMap.get(e)):null}setItem(e,t){this.valuesMap.set(e,t)}removeItem(e){this.valuesMap.delete(e)}clear(){this.valuesMap.clear()}key(e){if(arguments.length===0)throw new TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.");return Array.from(this.valuesMap.keys())[e]}get length(){return this.valuesMap.size}},qi=()=>{try{L&&!localStorage&&(window.localStorage=new pi)}catch(n){c.e("Error initialising localStorage",h.GenericErrors.LocalStorageAccessDenied())}};var V=class{constructor(e){this.key=e;this.storage=null}getStorage(){try{return L&&!this.storage&&(qi(),this.storage=window.localStorage),this.storage}catch(e){return c.e("Error initialising localStorage",h.GenericErrors.LocalStorageAccessDenied()),null}}get(){var i;let e=(i=this.getStorage())==null?void 0:i.getItem(this.key);return e?JSON.parse(e):void 0}set(e){var i;let t=JSON.stringify(e);(i=this.getStorage())==null||i.setItem(this.key,t)}clear(){var e;(e=this.getStorage())==null||e.removeItem(this.key)}};var ji=()=>{let n,e=new V("hms-analytics-deviceId"),t=e.get();return t?n=t:(n=$r(),e.set(n)),n};var Qi="[VALIDATIONS]";function U(n){return n!=null}var hi=()=>{if(!U(RTCPeerConnection)){let n=h.GenericErrors.MissingRTCPeerConnection();throw c.e(Qi,n),n}},mi=()=>{if(!U(navigator.mediaDevices)){let n=h.GenericErrors.MissingMediaDevices();throw c.e(Qi,n),n}};var Ji=gi().version;function xe(n="prod",e){let t="web",i=ye!=="LOCAL"&&n==="prod"?"prod":"debug";if(ue)return zi({os:"web_nodejs",os_version:process.version,sdk:t,sdk_version:Ji,env:i,domain:ye,is_prebuilt:!!(e!=null&&e.isPrebuilt),framework:"node",framework_version:process.version,framework_sdk_version:e==null?void 0:e.sdkVersion});let r=le.getOS(),s=le.getDevice(),a=le.getBrowser(),o=Si(`web_${r.name}`),l=r.version||"",p=Si(`${a.name}_${a.version}`),u=p;return s.type&&(u=`${Si(`${s.vendor}_${s.type}`)}/${p}`),zi({os:o,os_version:l,sdk:t,sdk_version:Ji,device_model:u,env:i,domain:ye,is_prebuilt:!!(e!=null&&e.isPrebuilt),framework:e==null?void 0:e.type,framework_version:e==null?void 0:e.version,framework_sdk_version:e==null?void 0:e.sdkVersion})}function Si(n){return n.replace(/ /g,"_")}var zi=(n,e=",")=>Object.keys(n).filter(t=>U(n[t])).map(t=>`${t}:${n[t]}`).join(e);var k=class{constructor({name:e,level:t,properties:i,includesPII:r,timestamp:s}){this.metadata={peer:{},userAgent:xe()};this.name=e,this.level=t,this.includesPII=r||!1,this.properties=i||{},this.timestamp=s||new Date().getTime(),this.event_id=qr(),this.device_id=ji()}toSignalParams(){return{name:this.name,info:y(m({},this.properties),{timestamp:this.timestamp,domain:ye}),timestamp:new Date().getTime()}}};var P=class{static connect(e,t,i=new Date,r=new Date,s){let a=this.eventNameFor("connect",e===void 0),o=e?2:1,l=this.getPropertiesWithError(y(m({},t),{[this.KEY_REQUESTED_AT]:i==null?void 0:i.getTime(),[this.KEY_RESPONDED_AT]:r==null?void 0:r.getTime(),endpoint:s}),e);return new k({name:a,level:o,properties:l})}static disconnect(e,t){let i="disconnected",r=e?2:1,s=this.getPropertiesWithError(t,e);return new k({name:i,level:r,properties:s})}static preview(i){var r=i,{error:e}=r,t=oi(r,["error"]);let s=this.eventNameFor("preview",e===void 0),a=e?2:1,o=this.getPropertiesWithError(t,e);return new k({name:s,level:a,properties:o})}static join(i){var r=i,{error:e}=r,t=oi(r,["error"]);let s=this.eventNameFor("join",e===void 0),a=e?2:1,o=this.getPropertiesWithError(y(m({},t),{is_preview_called:!!t.is_preview_called}),e);return new k({name:s,level:a,properties:o})}static publish({devices:e,settings:t,error:i}){let r=this.eventNameFor("publish",i===void 0),s=i?2:1,a=this.getPropertiesWithError({devices:e,audio:t==null?void 0:t.audio,video:t==null?void 0:t.video},i);return new k({name:r,level:s,properties:a})}static hlsPlayerError(e){return new k({name:"hlsPlayerError",level:2,properties:this.getErrorProperties(e)})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),i=2,r=this.getErrorProperties(e);return new k({name:t,level:i,properties:r})}static leave(){return new k({name:"leave",level:1})}static autoplayError(){return new k({name:"autoplayError",level:2})}static audioPlaybackError(e){return new k({name:"audioPlaybackError",level:2,properties:this.getErrorProperties(e)})}static deviceChange({selection:e,type:t,devices:i,error:r}){let s=this.eventNameFor(r?"publish":`device.${t}`,r===void 0),a=r?2:1,o=this.getPropertiesWithError({selection:e,devices:i},r);return new k({name:s,level:a,properties:o})}static performance(e){let t="perf.stats",i=1,r=e.toAnalyticsProperties();return new k({name:t,level:i,properties:r})}static rtcStats(e){let t="rtc.stats",i=1,r=e.toAnalyticsProperties();return new k({name:t,level:i,properties:r})}static rtcStatsFailed(e){let t="rtc.stats.failed",i=2;return new k({name:t,level:i,properties:this.getErrorProperties(e)})}static degradationStats(e,t){let i="video.degradation.stats",r=1,s={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let a=new Date,o=a.valueOf()-e.degradedAt.valueOf();s=y(m({},s),{duration:o,restoredAt:a})}return new k({name:i,level:r,properties:s})}static audioDetectionFail(e,t){let i=this.getPropertiesWithError({device:t},e),r=2,s="audiopresence.failed";return new k({name:s,level:r,properties:i})}static previewNetworkQuality(e){return new k({name:"perf.networkquality.preview",level:e.error?2:1,properties:e})}static publishStats(e){return new k({name:"publisher.stats",level:1,properties:e})}static subscribeStats(e){return new k({name:"subscriber.stats",level:1,properties:e})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){let i=this.getErrorProperties(t);return e=m(m({},i),e),e}static getErrorProperties(e){return e?e instanceof S?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message,error_description:e.cause}:{}}};P.KEY_REQUESTED_AT="requested_at",P.KEY_RESPONDED_AT="responded_at";var Qr=["init_response_time","ws_connect_time","on_policy_change_time","local_audio_track_time","local_video_track_time","peer_list_time","room_state_time","join_response_time"],mt=class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),c.d("[HMSPerformanceTiming]",e,(t=this.eventPerformanceMeasures[e])==null?void 0:t.duration)}catch(i){c.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:i})}}getTimeTaken(e){var t;return(t=this.eventPerformanceMeasures[e])==null?void 0:t.duration}getTimes(...e){return[...Qr,...e].reduce((t,i)=>y(m({},t),{[i]:this.getTimeTaken(i)}),{})}cleanup(){this.eventPerformanceMeasures={}}};import Yi from"webrtc-adapter";function Jr(n,e){let t=n.toLowerCase();return t.includes("device not found")?h.TracksErrors.DeviceNotAvailable("TRACK",e,n):t.includes("permission denied")?h.TracksErrors.CantAccessCaptureDevice("TRACK",e,n):h.TracksErrors.GenericTrack("TRACK",n)}function zr(n,e=""){if(Yi.browserDetails.browser==="chrome"&&n.name==="NotAllowedError"&&n.message.includes("denied by system"))return h.TracksErrors.SystemDeniedPermission("TRACK",e,n.message);if(Yi.browserDetails.browser==="firefox"&&n.name==="NotFoundError"){let i=h.TracksErrors.SystemDeniedPermission("TRACK",e,n.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${e}`,i}switch(n.name){case"OverconstrainedError":return h.TracksErrors.OverConstrained("TRACK",e,n.constraint);case"NotAllowedError":return h.TracksErrors.CantAccessCaptureDevice("TRACK",e,n.message);case"NotFoundError":return h.TracksErrors.DeviceNotAvailable("TRACK",e,n.message);case"NotReadableError":return h.TracksErrors.DeviceInUse("TRACK",e,n.message);case"TypeError":return h.TracksErrors.NothingToReturn("TRACK",n.message);default:return Jr(n.message,e)}}function W(n,e){let t=zr(n,e);return t.addNativeError(n),t}import Tr from"webrtc-adapter";var pe=class{constructor(e){this.tracks=new Array;this.nativeStream=e,this.id=e.id}updateId(e){this.id=e}};var ee=n=>n?`{
    trackId: ${n.id};
    kind: ${n.kind};
    enabled: ${n.enabled};
    muted: ${n.muted};
    readyState: ${n.readyState};
  }`:"";var te=class{constructor(e,t,i){this.logIdentifier="";this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return d(this,null,function*(){this.nativeTrack.enabled=e})}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}cleanup(){var e;c.d("[HMSTrack]","Stopping track",this.toString()),(e=this.nativeTrack)==null||e.stop()}toString(){var e;return`{
      streamId: ${this.stream.id};
      peerId: ${this.peerId};
      trackId: ${this.trackId};
      mid: ${((e=this.transceiver)==null?void 0:e.mid)||"-"};
      logIdentifier: ${this.logIdentifier};
      source: ${this.source};
      enabled: ${this.enabled};
      nativeTrack: ${ee(this.nativeTrack)};
    }`}};var he=(t=>(t.AUDIO="audio",t.VIDEO="video",t))(he||{});var Me=class extends te{constructor(t,i,r){super(t,i,r);this.type="audio";this.audioElement=null;if(i.kind!=="audio")throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?this.audioElement.volume*100:null}setVolume(t){return d(this,null,function*(){if(t<0||t>100)throw Error("Please pass a valid number between 0-100");yield this.subscribeToAudio(t===0?!1:this.enabled),this.audioElement&&(this.audioElement.volume=t/100)})}setAudioElement(t){c.d("[HMSAudioTrack]",this.logIdentifier,"adding audio element",`${this}`,t),this.audioElement=t}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(t){return d(this,null,function*(){var i;if(!t){c.d("[HMSAudioTrack]",this.logIdentifier,"device is null",`${this}`);return}if(!this.audioElement){c.d("[HMSAudioTrack]",this.logIdentifier,"no audio element to set output",`${this}`),this.outputDevice=t;return}try{typeof this.audioElement.setSinkId=="function"&&(yield(i=this.audioElement)==null?void 0:i.setSinkId(t.deviceId),this.outputDevice=t)}catch(r){c.d("[HMSAudioTrack]","error in setSinkId",r)}})}subscribeToAudio(t){return d(this,null,function*(){this.stream instanceof J&&(yield this.stream.setAudio(t,this.trackId,this.logIdentifier))})}};var Ti=class{constructor(){this.storage=new V("hms-device-selection");this.remember=!1;this.TAG="[HMSDeviceStorage]"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let r=this.devices[e].find(a=>this.isSame({deviceId:t,groupId:i},a));if(!r){c.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);return}let s=this.storage.get()||{};s[e]=r,this.storage.set(s)}getSelection(){if(this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},D=new Ti;var Xi=(t=>(t.TRANSFORM="TRANSFORM",t.ANALYZE="ANALYZE",t))(Xi||{}),gt=(t=>(t.PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",t.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED",t))(gt||{});var z=class{static failure(e,t){let i="mediaPlugin.failed",r=2,s=m({plugin_name:e},t.toAnalyticsProperties());return new k({name:i,level:r,properties:s})}static audioPluginFailure(e,t,i){let r="mediaPlugin.failed",s=2,a=m({plugin_name:e,sampleRate:t},i.toAnalyticsProperties());return new k({name:r,level:s,properties:a})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:r}){let s="mediaPlugin.stats",a=1,o={plugin_name:e,duration:t,load_time:i,sampleRate:r};return new k({name:s,level:a,properties:o})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:r,avgProcessingTime:s,inputFrameRate:a,pluginFrameRate:o}){let l="mediaPlugin.stats",p=1,u={plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:r,avg_processing_time:s,input_frame_rate:a,plugin_frame_rate:o};return new k({name:l,level:p,properties:u})}};var St=class{constructor(e){this.eventBus=e;this.TAG="[AudioPluginsAnalytics]";this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(z.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(z.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return d(this,null,function*(){if(this.initTime[e]){c.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let i;try{i=yield this.timeInMs(t),c.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(r){let s=h.MediaPluginErrors.InitFailed("AUDIO_PLUGINS",`failed during initialization of plugin${r.message||r}`);throw c.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)})}timeInMs(e){return d(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}};var Yr=48e3,Xr=()=>navigator.userAgent.indexOf("Firefox")!==-1,Fe=class{constructor(e,t){this.TAG="[AudioPluginsManager]";this.pluginAddInProgress=!1;this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new St(t),this.createAudioContext()}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return d(this,null,function*(){var i;let t=(i=e.getName)==null?void 0:i.call(e);if(!t){c.w("no name provided by the plugin");return}if(this.pluginAddInProgress){let r=h.MediaPluginErrors.AddAlreadyInProgress("AUDIO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.added(t,this.audioContext.sampleRate),this.analytics.failure(t,r),c.w("can't add another plugin when previous add is in progress"),r}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e){return d(this,null,function*(){var i;let t=(i=e.getName)==null?void 0:i.call(e);if(this.pluginsMap.get(t)){c.w(this.TAG,`plugin - ${t} already added.`);return}yield this.validateAndThrow(t,e);try{this.pluginsMap.size===0?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(t,this.audioContext.sampleRate),yield this.analytics.initWithTime(t,()=>d(this,null,function*(){return e.init()})),this.pluginsMap.set(t,e),yield this.processPlugin(e),yield this.connectToDestination()}catch(r){throw c.e(this.TAG,"failed to add plugin",r),r}})}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return d(this,null,function*(){let i=this.validatePlugin(t);if(i.isSupported)c.i(this.TAG,`plugin is supported,- ${t.getName()}`);else if(this.analytics.added(e,this.audioContext.sampleRate),i.errType==="PLATFORM_NOT_SUPPORTED"){let r=h.MediaPluginErrors.PlatformNotSupported("AUDIO_PLUGINS","platform not supported, see docs");throw this.analytics.failure(e,r),yield this.cleanup(),r}else if(i.errType==="DEVICE_NOT_SUPPORTED"){let r=h.MediaPluginErrors.DeviceNotSupported("AUDIO_PLUGINS","audio device not supported, see docs");throw this.analytics.failure(e,r),yield this.cleanup(),r}})}removePlugin(e){return d(this,null,function*(){yield this.removePluginInternal(e),this.pluginsMap.size===0?(yield this.cleanup(),c.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()})}cleanup(){return d(this,null,function*(){var e,t,i;for(let r of this.pluginsMap.values())yield this.removePluginInternal(r);yield this.hmsTrack.setProcessedTrack(void 0),(e=this.sourceNode)==null||e.disconnect(),(t=this.prevAudioNode)==null||t.disconnect(),(i=this.outputTrack)==null||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0})}closeContext(){return d(this,null,function*(){var e;(e=this.audioContext)==null||e.close(),this.audioContext=void 0})}reprocessPlugins(){return d(this,null,function*(){if(this.pluginsMap.size===0||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initAudioNodes();for(let t of e)yield this.addPlugin(t)})}initAudioNodes(){return d(this,null,function*(){if(this.audioContext){if(!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}if(!this.destinationNode){this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0];try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw c.e(this.TAG,"error in setting processed track",e),e}}}})}processPlugin(e){return d(this,null,function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(t){let i=e.getName();c.e(this.TAG,`error in processing plugin ${i}`,t),yield this.removePluginInternal(e)}})}connectToDestination(){return d(this,null,function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){c.e(this.TAG,"error in connecting to destination node",e)}})}removePluginInternal(e){return d(this,null,function*(){var i;let t=(i=e.getName)==null?void 0:i.call(e);if(!this.pluginsMap.get(t)){c.w(this.TAG,`plugin - ${t} not found to remove.`);return}c.i(this.TAG,`removing plugin ${t}`),this.pluginsMap.delete(t),e.stop(),this.analytics.removed(t)})}createAudioContext(){this.audioContext||(Xr()?this.audioContext=new AudioContext:this.audioContext=new AudioContext({sampleRate:Yr}))}};function Tt(n){return d(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:n?n.toConstraints():!1})).getAudioTracks()[0]}catch(e){throw W(e,"audio")}})}function vt(n){return d(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:n?n.toConstraints():!1})).getVideoTracks()[0]}catch(e){throw W(e,"video")}})}function $(n){return"canvas"in n||n.label==="MediaStreamAudioDestinationNode"||n.label===""}function er(n){return d(this,null,function*(){try{return yield navigator.mediaDevices.getUserMedia(n)}catch(e){throw W(e,"audio, video")}})}function eo(n){return d(this,null,function*(){try{return yield navigator.mediaDevices.getDisplayMedia({video:n,audio:!1})}catch(e){throw W(e,"screen")}})}function to(){return d(this,null,function*(){try{let n=yield navigator.mediaDevices.enumerateDevices(),e={audioinput:[],audiooutput:[],videoinput:[]};return n.forEach(t=>e[t.kind].push(t)),e}catch(n){throw W(n,"audio, video")}})}var ie={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},resumeContext(){return d(this,null,function*(){try{return yield this.getAudioContext().resume()}catch(n){c.e("AudioContext",n)}})}};var re=class{constructor(e=1/0){this.capacity=e;this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}};var Zr=`(function metronomeWorkerSetup() {
  function ticker() {
    self.postMessage('tick');
  }
  self.onmessage = function (event) {
    const [data, time] = event.data;
    switch (data) {
      case 'start':
        setTimeout(ticker, time);
        break;
      default:
        break;
    }
  };
})()`;function N(n){if(n<0)throw Error("`ms` should be a positive integer");return new Promise(e=>{setTimeout(e,n)})}function K(n){if(n<0)throw Error("`ms` should be a positive integer");if(typeof Worker=="undefined")return N(n);let e=new Worker(URL.createObjectURL(new Blob([Zr],{type:"application/javascript"})));return e.postMessage(["start",n]),new Promise(t=>{e.onmessage=i=>{i.data==="tick"&&(t(),e.terminate())}})}function ft(n,e=300){let t;return function(...i){clearTimeout(t),t=void 0;let r=this;t=setTimeout(()=>{n.apply(r,i)},e)}}var es=35,ts=5,Et=class{constructor(e,t,i){this.track=e;this.audioLevelEvent=t;this.silenceEvent=i;this.TAG="[TrackAudioLevelMonitor]";this.audioLevel=0;this.isMonitored=!1;this.interval=100;this.historyInterval=700;this.history=new re(this.historyInterval/this.interval);this.detectSilence=()=>d(this,null,function*(){let i=0;for(;this.isMonitored;){if(this.track.enabled)if(this.isSilentThisInstant()){if(i++,i>50){this.silenceEvent.publish({track:this.track});break}}else break;yield N(20)}});try{let r=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(r)}catch(r){c.w(this.TAG,"Unable to initialize AudioContext",r)}}start(){this.stop(),this.isMonitored=!0,c.d(this.TAG,"Starting track Monitor",`${this.track}`),this.loop().then(()=>c.d(this.TAG,"Stopping track Monitor",`${this.track}`))}stop(){if(!this.analyserNode){c.d(this.TAG,"AudioContext not initialized");return}this.sendAudioLevel(0),this.isMonitored=!1}loop(){return d(this,null,function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield N(this.interval)})}sendAudioLevel(e=0){if(e=e>es?e:0,Math.abs(this.audioLevel-e)>ts){this.audioLevel=e;let i={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(i)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode){c.d(this.TAG,"AudioContext not initialized");return}let e=this.calculateAudioLevel();return e!==void 0&&this.history.enqueue(e),this.history.aggregate(t=>Math.max(...t))}calculateAudioLevel(){if(!this.analyserNode){c.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let t=.009,i=t;for(let a of e)i=Math.max(i,(a-128)/128);let r=(Math.log(t)-Math.log(i))/Math.log(t);return Math.ceil(Math.min(Math.max(r*100,0),100))}isSilentThisInstant(){if(!this.analyserNode){c.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);return this.analyserNode.getByteTimeDomainData(e),!e.some(t=>t!==128&&t!==0)}createAnalyserNodeForStream(e){let t=ie.getAudioContext(),i=t.createAnalyser();return t.createMediaStreamSource(e).connect(i),i}};var tr=(a=>(a.RECORDING_STATE_UPDATED="RECORDING_STATE_UPDATED",a.BROWSER_RECORDING_STATE_UPDATED="BROWSER_RECORDING_STATE_UPDATED",a.SERVER_RECORDING_STATE_UPDATED="SERVER_RECORDING_STATE_UPDATED",a.RTMP_STREAMING_STATE_UPDATED="RTMP_STREAMING_STATE_UPDATED",a.HLS_STREAMING_STATE_UPDATED="HLS_STREAMING_STATE_UPDATED",a.ROOM_PEER_COUNT_UPDATED="ROOM_PEER_COUNT_UPDATED",a))(tr||{}),Ge=(f=>(f[f.PEER_JOINED=0]="PEER_JOINED",f[f.PEER_LEFT=1]="PEER_LEFT",f[f.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",f[f.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",f[f.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",f[f.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",f[f.STARTED_SPEAKING=6]="STARTED_SPEAKING",f[f.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",f[f.ROLE_UPDATED=8]="ROLE_UPDATED",f[f.PEER_LIST=9]="PEER_LIST",f[f.NAME_UPDATED=10]="NAME_UPDATED",f[f.METADATA_UPDATED=11]="METADATA_UPDATED",f[f.HAND_RAISE_CHANGED=12]="HAND_RAISE_CHANGED",f[f.PEER_REMOVED=13]="PEER_REMOVED",f[f.PEER_ADDED=14]="PEER_ADDED",f))(Ge||{}),se=(o=>(o[o.TRACK_ADDED=0]="TRACK_ADDED",o[o.TRACK_REMOVED=1]="TRACK_REMOVED",o[o.TRACK_MUTED=2]="TRACK_MUTED",o[o.TRACK_UNMUTED=3]="TRACK_UNMUTED",o[o.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",o[o.TRACK_DEGRADED=5]="TRACK_DEGRADED",o[o.TRACK_RESTORED=6]="TRACK_RESTORED",o))(se||{}),vi=(r=>(r[r.POLL_CREATED=0]="POLL_CREATED",r[r.POLL_STARTED=1]="POLL_STARTED",r[r.POLL_STOPPED=2]="POLL_STOPPED",r[r.POLL_STATS_UPDATED=3]="POLL_STATS_UPDATED",r))(vi||{});var is=(o=>(o.NONE="none",o.INITIALISED="initialised",o.STARTED="started",o.PAUSED="paused",o.RESUMED="resumed",o.STOPPED="stopped",o.FAILED="failed",o))(is||{}),rs=(s=>(s.NONE="none",s.INITIALISED="initialised",s.STARTED="started",s.STOPPED="stopped",s.FAILED="failed",s))(rs||{});var ke=(r=>(r.NONE="none",r.LOW="low",r.MEDIUM="medium",r.HIGH="high",r))(ke||{}),fi={f:"high",h:"medium",q:"low"};var ir=(i=>(i.VP8="vp8",i.VP9="vp9",i.H264="h264",i))(ir||{}),rr=(e=>(e.OPUS="opus",e))(rr||{}),sr=(r=>(r.USER="user",r.ENVIRONMENT="environment",r.LEFT="left",r.RIGHT="right",r))(sr||{});var ss=(i=>(i.videoInput="videoInput",i.audioInput="audioInput",i.audioOutput="audioOutput",i))(ss||{});var Ei=(t=>(t.audio="audio",t.video="video",t))(Ei||{});var ar=(r=>(r.SINGLE_CHOICE="single-choice",r.MULTIPLE_CHOICE="multiple-choice",r.SHORT_ANSWER="short-answer",r.LONG_ANSWER="long-answer",r))(ar||{}),nr=(i=>(i.CREATED="created",i.STARTED="started",i.STOPPED="stopped",i))(nr||{});var x=class{constructor(){this._volume=1;this._codec="opus";this._maxBitrate=32;this._deviceId="default";this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new me(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)}},me=class{constructor(e,t,i,r,s){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=r,this.advanced=s}toConstraints(){return{deviceId:this.deviceId,advanced:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}};var O=class{constructor(){this._width=320;this._height=180;this._codec="vp8";this._maxFramerate=30;this._maxBitrate=150;this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if(typeof e=="number"&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}facingMode(e){return this._facingMode=e,this}build(){return new ge(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate,this._facingMode)}},ge=class{constructor(e,t,i,r,s,a,o,l){this.width=e,this.height=t,this.codec=i,this.maxFramerate=r,this.maxBitrate=o,this.deviceId=s,this.advanced=a,this.facingMode=l}toConstraints(e){let t="ideal";e&&(t="max");let i=this.improviseConstraintsAspect();return{width:{[t]:i.width},height:{[t]:i.height},frameRate:this.maxFramerate,deviceId:this.deviceId,facingMode:this.facingMode}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec,facingMode:this.facingMode}}improviseConstraintsAspect(){return ht()&&this.height&&this.width&&this.height>this.width?{width:this.height,height:this.width}:{width:this.width,height:this.height}}};var Ue=class{constructor(){this._video=new O().build();this._audio=new x().build();this._screen=new O().build();this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(this._audio===null&&this._video===null)throw h.TracksErrors.NothingToReturn("TRACK");if(this._video===null&&this._simulcast)throw h.TracksErrors.InvalidVideoSettings("TRACK","Cannot enable simulcast when no video settings are provided");return new Ae(this._video,this._audio,this._simulcast,this._screen||void 0)}},Ae=class{constructor(e,t,i,r=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=r}toAnalyticsProperties(){let e={audio_enabled:this.audio!==null,video_enabled:this.video!==null};return this.audio&&(e=m(m({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=m(m({},this.video.toAnalyticsProperties()),e)),e}};function or(n,e){return function(i){return i in n&&n[i]!==e[i]}}var Se=class n extends Me{constructor(t,i,r,s,a=new x().build()){super(t,i,r);this.eventBus=s;this.TAG="[HMSLocalAudioTrack]";this.isPublished=!1;this.handleVisibilityChange=()=>d(this,null,function*(){document.visibilityState==="visible"&&(yield this.replaceTrackWith(this.settings))});this.handleSettingsChange=t=>d(this,null,function*(){let i=this.stream,r=or(t,this.settings);r("maxBitrate")&&t.maxBitrate&&(yield i.setMaxBitrateAndFramerate(this)),r("advanced")&&(yield this.replaceTrackWith(t))});this.handleDeviceChange=(t,i=!1)=>d(this,null,function*(){or(t,this.settings)("deviceId")&&(this.manuallySelectedDeviceId=i?this.manuallySelectedDeviceId:t.deviceId,yield this.replaceTrackWith(t),i||D.updateSelection("audioInput",{deviceId:t.deviceId,groupId:this.nativeTrack.getSettings().groupId}))});t.tracks.push(this),this.settings=a,a.deviceId!==i.getSettings().deviceId&&!$(i)&&(this.settings=this.buildNewSettings({deviceId:i.getSettings().deviceId})),this.pluginsManager=new Fe(this,s),this.setFirstTrackId(i.id),li()&&L&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}getManuallySelectedDeviceId(){return this.manuallySelectedDeviceId}resetManuallySelectedDeviceId(){this.manuallySelectedDeviceId=void 0}replaceTrackWith(t){return d(this,null,function*(){let i=this.nativeTrack;i==null||i.stop();let r=!!this.audioLevelMonitor;try{let s=yield Tt(t);s.enabled=this.enabled,c.d(this.TAG,"replaceTrack, Previous track stopped",i,"newTrack",s);let a=this.stream;yield a.replaceSenderTrack(i,this.processedTrack||s),yield a.replaceStreamTrack(i,s),this.nativeTrack=s,r&&this.initAudioLevelMonitor()}catch(s){throw this.isPublished&&this.eventBus.analytics.publish(P.publish({error:s})),s}try{yield this.pluginsManager.reprocessPlugins()}catch(s){this.eventBus.audioPluginFailed.publish(s)}})}setEnabled(t){return d(this,null,function*(){t!==this.enabled&&(t&&$(this.nativeTrack)&&(yield this.replaceTrackWith(this.settings)),yield H(n.prototype,this,"setEnabled").call(this,t),t&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:t,track:this}))})}isPublishedTrackId(t){return this.publishedTrackId===t}setSettings(t,i=!1){return d(this,null,function*(){let r=this.buildNewSettings(t);if($(this.nativeTrack)){this.settings=r;return}yield this.handleDeviceChange(r,i),yield this.handleSettingsChange(r),this.settings=r})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(t){return d(this,null,function*(){return this.pluginsManager.addPlugin(t)})}removePlugin(t){return d(this,null,function*(){return this.pluginsManager.removePlugin(t)})}validatePlugin(t){return this.pluginsManager.validatePlugin(t)}setProcessedTrack(t){return d(this,null,function*(){if(!t){this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0;return}t!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,t):yield this.stream.replaceSenderTrack(this.nativeTrack,t),this.processedTrack=t)})}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),c.d(this.TAG,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new Et(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var t;(t=this.audioLevelMonitor)==null||t.stop(),this.audioLevelMonitor=void 0}cleanup(){return d(this,null,function*(){var t;H(n.prototype,this,"cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),this.transceiver=void 0,(t=this.processedTrack)==null||t.stop(),this.isPublished=!1,this.destroyAudioLevelMonitor(),li()&&L&&document.removeEventListener("visibilitychange",this.handleVisibilityChange)})}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}buildNewSettings(t){let{volume:i,codec:r,maxBitrate:s,deviceId:a,advanced:o}=m(m({},this.settings),t);return new me(i,r,s,a,o)}};var ae=class n extends Me{setEnabled(e){return d(this,null,function*(){e!==this.enabled&&(yield H(n.prototype,this,"setEnabled").call(this,e),yield this.subscribeToAudio(e))})}};var be=class extends te{constructor(t,i,r){super(t,i,r);this.type="video";this.sinkCount=0;if(i.kind!=="video")throw new Error("Expected 'track' kind = 'video'")}setVideoHandler(t){this.videoHandler=t}hasSinks(){return this.sinkCount>0}getSinks(){return this.videoHandler.getVideoElements()||[]}attach(t){this.videoHandler.addVideoElement(t)}detach(t){this.videoHandler.removeVideoElement(t)}addSink(t){this.addSinkInternal(t,this.nativeTrack)}removeSink(t){t.srcObject!==null&&(t.srcObject=null,this.reduceSinkCount())}cleanup(){super.cleanup(),this.videoHandler.cleanup()}addSinkInternal(t,i){let r=t.srcObject;if(r!==null&&r instanceof MediaStream){let s=r.getVideoTracks()[0];if((s==null?void 0:s.id)===i.id){if(!s.muted&&s.readyState==="live")return;this.reduceSinkCount()}else this.reduceSinkCount()}t.srcObject=new MediaStream([i]),this.sinkCount++}reduceSinkCount(){this.sinkCount>0&&this.sinkCount--}};import{v4 as ns}from"uuid";var Be={none:-1,low:0,medium:1,high:2},as=.5,cr=(n,e)=>{let t="high",i=e.width>e.height?"width":"height",r=[...n].sort((a,o)=>Be[a.layer]-Be[o.layer]),s=e[i]*((window==null?void 0:window.devicePixelRatio)||1);for(let a=0;a<r.length;a++){let{resolution:o,layer:l}=r[a],p=o[i];if(s<=p){t=l;break}else{let u=r[a+1],g=u?u.resolution[i]:Number.POSITIVE_INFINITY;if((s-p)/(g-p)<as){t=l;break}}}return t};var Pi=class{constructor(){this.TAG="[HMSIntersectionObserverWrapper]";this.listeners=new WeakMap;this.observe=(e,t)=>{var i;this.createObserver(),this.unobserve(e),(i=this.intersectionObserver)==null||i.observe(e),this.listeners.set(e,t)};this.unobserve=e=>{var t;(t=this.intersectionObserver)==null||t.unobserve(e),this.listeners.delete(e)};this.createObserver=()=>{this.isSupported()&&!this.intersectionObserver&&(this.intersectionObserver=new IntersectionObserver(this.handleIntersection))};this.handleIntersection=e=>{var t;for(let i of e)(t=this.listeners.get(i.target))==null||t(i)};this.createObserver()}isSupported(){let e=L&&typeof window.IntersectionObserver!="undefined";return e||c.w(this.TAG,"IntersectionObserver is not supported, fallback will be used instead"),e}},dr=new Pi;var yi=class{constructor(){this.TAG="[HMSResizeObserverWrapper]";this.listeners=new WeakMap;this.observe=(e,t,i={box:"border-box"})=>{var r;this.createObserver(),this.unobserve(e),(r=this.resizeObserver)==null||r.observe(e,i),this.listeners.set(e,t)};this.unobserve=e=>{var t;(t=this.resizeObserver)==null||t.unobserve(e),this.listeners.delete(e)};this.createObserver=()=>{this.isSupported()&&!this.resizeObserver&&(this.resizeObserver=new ResizeObserver(ft(this.handleResize,300)))};this.handleResize=e=>{var t;for(let i of e)(t=this.listeners.get(i.target))==null||t(i)};this.createObserver()}isSupported(){let e=L&&typeof window.ResizeObserver!="undefined";return e||c.w(this.TAG,"Resize Observer is not supported"),e}},lr=new yi;var Ie=class{constructor(e){this.track=e;this.TAG="[VideoElementManager]";this.videoElements=new Set;this.entries=new WeakMap;this.handleIntersection=e=>d(this,null,function*(){let t=getComputedStyle(e.target).visibility==="visible";this.track.enabled&&(e.isIntersecting&&t||!document.contains(e.target))?(c.d(this.TAG,"add sink intersection",`${this.track}`,this.id),this.entries.set(e.target,e.boundingClientRect),yield this.selectMaxLayer(),yield this.track.addSink(e.target)):(c.d(this.TAG,"remove sink intersection",`${this.track}`,this.id),yield this.track.removeSink(e.target))});this.handleResize=e=>d(this,null,function*(){!this.track.enabled||!(this.track instanceof w)||(this.entries.set(e.target,e.contentRect),yield this.selectMaxLayer())});this.cleanup=()=>{this.videoElements.forEach(e=>{var t,i;e.srcObject=null,(t=this.resizeObserver)==null||t.unobserve(e),(i=this.intersectionObserver)==null||i.unobserve(e)}),this.videoElements.clear(),this.resizeObserver=void 0,this.intersectionObserver=void 0};this.init(),this.id=ns()}updateSinks(e=!1){for(let t of this.videoElements)this.track.enabled?this.track.addSink(t,e):this.track.removeSink(t,e)}addVideoElement(e){return d(this,null,function*(){var t;this.videoElements.has(e)||(this.init(),c.d(this.TAG,`Adding video element for ${this.track}`,this.id),this.videoElements.add(e),this.videoElements.size>=10&&c.w(this.TAG,`${this.track}`,`the track is added to ${this.videoElements.size} video elements, while this may be intentional, it's likely that there is a bug leading to unnecessary creation of video elements in the UI`),(t=this.intersectionObserver)!=null&&t.isSupported()?this.intersectionObserver.observe(e,this.handleIntersection):L&&(this.isElementInViewport(e)?this.track.addSink(e):this.track.removeSink(e)),this.resizeObserver?this.resizeObserver.observe(e,this.handleResize):this.track instanceof w&&(yield this.track.setPreferredLayer(this.track.getPreferredLayer())))})}removeVideoElement(e){var t,i;this.track.removeSink(e),this.videoElements.delete(e),this.entries.delete(e),(t=this.resizeObserver)==null||t.unobserve(e),(i=this.intersectionObserver)==null||i.unobserve(e),c.d(this.TAG,`Removing video element for ${this.track}`)}getVideoElements(){return Array.from(this.videoElements)}init(){L&&(this.resizeObserver=lr,this.intersectionObserver=dr)}isElementInViewport(e){let t=e.offsetTop,i=e.offsetLeft,r=e.offsetWidth,s=e.offsetHeight,{hidden:a}=e,{opacity:o,display:l}=getComputedStyle(e);for(;e.offsetParent;)e=e.offsetParent,t+=e.offsetTop,i+=e.offsetLeft;return t<window.pageYOffset+window.innerHeight&&i<window.pageXOffset+window.innerWidth&&t+s>window.pageYOffset&&i+r>window.pageXOffset&&!a&&(o!==""?parseFloat(o)>0:!0)&&l!=="none"}selectMaxLayer(){return d(this,null,function*(){if(!(this.track instanceof w)||this.videoElements.size===0)return;let e;for(let t of this.videoElements){let i=this.entries.get(t);if(!i)continue;let{width:r,height:s}=i;if(r===0||s===0)continue;let a=cr(this.track.getSimulcastDefinitions(),{width:r,height:s});e?e=Be[a]>Be[e]?a:e:e=a}e&&(c.d(this.TAG,`selecting max layer ${e} for the track`,`${this.track}`),yield this.track.setPreferredLayer(e))})}};var Mi=(t=>(t.TRANSFORM="TRANSFORM",t.ANALYZE="ANALYZE",t))(Mi||{}),ki=(t=>(t["2D"]="2d",t.WEBGL="webgl",t.WEBGL2="webgl2",t))(ki||{});var Ve=class{constructor(){this.total=0;this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}};var Pt=class{constructor(e){this.eventBus=e;this.TAG="[VideoPluginsAnalytics]";this.initTime={},this.preProcessingAvgs=new Ve,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new Ve,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:(t=this.processingAvgs[e])==null?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(z.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(z.failure(e,t)),this.clean(e))}initWithTime(e,t){return d(this,null,function*(){if(this.initTime[e]){c.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let i;try{i=yield this.timeInMs(t),c.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(r){let s=h.MediaPluginErrors.InitFailed("VIDEO_PLUGINS",`failed during initialization of plugin${r.message||r}`);throw c.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)})}preProcessWithTime(e){return d(this,null,function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)})}processWithTime(e,t){return d(this,null,function*(){var r;let i;try{i=yield this.timeInMs(t)}catch(s){let a=h.MediaPluginErrors.ProcessingFailed("VIDEO_PLUGINS",`Failed during processing of plugin${s.message||s}`);throw c.e(this.TAG,a),this.failure(e,a),a}i&&((r=this.processingAvgs[e])==null||r.add(i))})}timeInMs(e){return d(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}};var ur=24,os=320,cs=240,We=class{constructor(e,t){this.TAG="[VideoPluginsManager]";this.pluginsLoopRunning=!1;this.pluginsLoopState="paused";this.pluginAddInProgress=!1;this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new Pt(t),this.canvases=new Array}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return d(this,null,function*(){var i;if(this.pluginAddInProgress){let r=(i=e.getName)==null?void 0:i.call(e);if(!r||r===""){c.w("no name provided by the plugin");return}let s=h.MediaPluginErrors.AddAlreadyInProgress("VIDEO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.failure(r,s),c.w("can't add another plugin when previous add is in progress"),s}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e,t){return d(this,null,function*(){var a,o;let i=(a=e.getName)==null?void 0:a.call(e);if(!i||i===""){c.w("no name provided by the plugin");return}if(this.pluginsMap.has(i)){c.w(this.TAG,`plugin - ${e.getName()} already added.`);return}let r=this.hmsTrack.getMediaTrackSettings().frameRate||ur,s=0;t&&t>0?(c.i(this.TAG,`adding plugin ${e.getName()} with framerate ${t}`),t<r&&(s=Math.ceil(r/t)-1),this.analytics.added(i,r,t)):(c.i(this.TAG,`adding plugin ${e.getName()}`),this.analytics.added(i,r)),c.i(this.TAG,"numFrames to skip processing",s),this.pluginNumFramesToSkip[i]=s,this.pluginNumFramesSkipped[i]=s,this.validateAndThrow(i,e);try{if(yield this.analytics.initWithTime(i,()=>d(this,null,function*(){return yield e.init()})),this.pluginsMap.set(i,e),this.pluginsMap.size+1>this.canvases.length)for(let l=this.canvases.length;l<=this.pluginsMap.size;l++)this.canvases[l]=document.createElement("canvas");yield this.startPluginsLoop((o=e.getContextType)==null?void 0:o.call(e))}catch(l){throw c.e(this.TAG,"failed to add plugin",l),yield this.removePlugin(e),l}})}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)c.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{let r;switch(i.errType){case"PLATFORM_NOT_SUPPORTED":throw r=h.MediaPluginErrors.PlatformNotSupported("VIDEO_PLUGINS","platform not supported, see docs"),this.analytics.failure(e,r),r;case"DEVICE_NOT_SUPPORTED":throw r=h.MediaPluginErrors.DeviceNotSupported("VIDEO_PLUGINS","video device not supported, see docs"),this.analytics.failure(e,r),r}}}removePlugin(e){return d(this,null,function*(){let t=e.getName();if(!this.pluginsMap.get(t)){c.w(this.TAG,`plugin - ${t} not found to remove.`);return}c.i(this.TAG,`removing plugin ${t}`),this.removePluginEntry(t),this.pluginsMap.size===0&&(c.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)})}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return d(this,null,function*(){if(!(!this.pluginsLoopRunning||this.pluginsLoopState==="running"))for(;this.pluginsLoopState==="paused";)yield K(100)})}cleanup(){return d(this,null,function*(){var e;for(let t of this.pluginsMap.values())yield this.removePlugin(t);(e=this.outputTrack)==null||e.stop()})}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||"2d");let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return d(this,null,function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(t){throw this.pluginsLoopRunning=!1,c.e(this.TAG,"error in setting processed track",t),t}this.pluginsLoop().then(()=>{c.d(this.TAG,"processLoop stopped")})}})}stopPluginsLoop(){return d(this,null,function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),(e=this.outputTrack)==null||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)})}pluginsLoop(){return d(this,null,function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||ur,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||this.hmsTrack.nativeTrack.readyState==="ended"){this.pluginsLoopState==="running"&&this.resetCanvases(),this.pluginsLoopState="paused",yield K(t);continue}let i=0;try{yield this.analytics.preProcessWithTime(()=>d(this,null,function*(){return yield this.doPreProcessing()}));let r=Date.now();yield this.processFramesThroughPlugins(),i=Math.floor(Date.now()-r),i>t&&(i=t)}catch(r){c.e(this.TAG,"error in plugins loop",r)}this.pluginsLoopState="running",yield K(t-i)}})}doPreProcessing(){return d(this,null,function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()})}processFramesThroughPlugins(){return d(this,null,function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(t){try{let r=this.checkIfSkipRequired(i);if(t.getPluginType()==="TRANSFORM"){let s=(a,o)=>d(this,null,function*(){try{yield t.processVideoFrame(a,o,r)}catch(l){c.e(this.TAG,`error in processing plugin ${i}`,l)}});if(r)e===this.pluginsMap.size-1?yield s(this.canvases[e],this.outputCanvas):yield s(this.canvases[e],this.canvases[e+1]);else{let a=this.canvases[e],o=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,()=>d(this,null,function*(){return s(a,this.outputCanvas)})):yield this.analytics.processWithTime(i,()=>d(this,null,function*(){return s(a,o)}))}}else t.getPluginType()==="ANALYZE"&&!r&&(yield this.analytics.processWithTime(i,()=>d(this,null,function*(){return yield t.processVideoFrame(this.inputCanvas)})))}catch(r){c.e(this.TAG,`error in processing plugin ${i}`,r),yield this.removePlugin(t)}e++}}})}addTrackToVideo(){return d(this,null,function*(){var t;if(!this.inputVideo)return;let e=this.inputVideo.srcObject;e!==null&&e instanceof MediaStream&&((t=e.getVideoTracks()[0])==null?void 0:t.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,yield this.inputVideo.play())})}updateInputCanvas(){return d(this,null,function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=os,height:t=cs}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)})}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}};var yt=class{constructor(){this.plugins=new Set}addPlugins(e){e.forEach(t=>this.plugins.add(t))}removePlugins(e){e.forEach(t=>{this.plugins.delete(t)})}applyPlugins(e){let t=e;for(let i of this.plugins)try{t=i.apply(t)}catch(r){c.e("Could not apply plugin",r,i)}return t}getPlugins(){return Array.from(this.plugins).map(e=>e.getName())}};function pr(n,e){return function(i){return i in n&&n[i]!==e[i]}}var F=class n extends be{constructor(t,i,r,s,a=new O().build()){super(t,i,r);this.eventBus=s;this._layerDefinitions=[];this.TAG="[HMSLocalVideoTrack]";this.isCurrentTab=!1;this.isPublished=!1;this.buildNewSettings=t=>{let{width:i,height:r,codec:s,maxFramerate:a,maxBitrate:o,deviceId:l,advanced:p,facingMode:u}=m(m({},this.settings),t);return new ge(i,r,s,a,l,p,o,u)};this.handleSettingsChange=t=>d(this,null,function*(){let i=this.stream,r=pr(t,this.settings);if(r("maxBitrate")&&t.maxBitrate&&(yield i.setMaxBitrateAndFramerate(this)),r("width")||r("height")||r("advanced"))if(this.source==="video"){let s=yield this.replaceTrackWith(t);yield this.replaceSender(s,this.enabled),this.nativeTrack=s,this.videoHandler.updateSinks()}else yield this.nativeTrack.applyConstraints(t.toConstraints())});this.handleDeviceChange=(t,i=!1)=>d(this,null,function*(){if(pr(t,this.settings)("deviceId")&&this.source==="regular"){if(this.enabled){delete t.facingMode;let s=yield this.replaceTrackWith(t);yield this.replaceSender(s,this.enabled),this.nativeTrack=s,this.videoHandler.updateSinks()}i||D.updateSelection("videoInput",{deviceId:t.deviceId,groupId:this.nativeTrack.getSettings().groupId})}});this.removeOrReplaceProcessedTrack=t=>d(this,null,function*(){t?t!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,t):yield this.stream.replaceSenderTrack(this.nativeTrack,t),this.processedTrack=t):(this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0)});t.tracks.push(this),this.setVideoHandler(new Ie(this)),this.settings=a,a.deviceId!==i.getSettings().deviceId&&i.enabled&&(this.settings=this.buildNewSettings({deviceId:i.getSettings().deviceId})),this.pluginsManager=new We(this,s),this.mediaStreamPluginsManager=new yt,this.setFirstTrackId(this.trackId)}setSimulcastDefinitons(t){this._layerDefinitions=t}getSimulcastDefinitions(){return this._layerDefinitions}setEnabled(t){return d(this,null,function*(){var i;if(t!==this.enabled){if(this.source==="regular"){let r;t?r=yield this.replaceTrackWith(this.settings):r=yield this.replaceTrackWithBlank(),yield this.replaceSender(r,t),(i=this.nativeTrack)==null||i.stop(),this.nativeTrack=r,yield H(n.prototype,this,"setEnabled").call(this,t),t&&(yield this.pluginsManager.waitForRestart(),yield this.processPlugins(),this.settings=this.buildNewSettings({deviceId:r.getSettings().deviceId})),this.videoHandler.updateSinks()}this.eventBus.localVideoEnabled.publish({enabled:t,track:this})}})}processPlugins(){return d(this,null,function*(){try{if(this.mediaStreamPluginsManager.getPlugins().length>0){let r=this.mediaStreamPluginsManager.applyPlugins(new MediaStream([this.nativeTrack])).getVideoTracks()[0];yield this.setProcessedTrack(r)}else yield this.setProcessedTrack()}catch(t){console.error("error in processing plugin(s)",t)}})}addStreamPlugins(t){return d(this,null,function*(){if(this.pluginsManager.getPlugins().length>0)throw Error("Plugins of type HMSMediaStreamPlugin and HMSVideoPlugin cannot be used together");this.mediaStreamPluginsManager.addPlugins(t),yield this.processPlugins()})}removeStreamPlugins(t){return d(this,null,function*(){this.mediaStreamPluginsManager.removePlugins(t),yield this.processPlugins()})}isPublishedTrackId(t){return this.publishedTrackId===t}addSink(t){this.addSinkInternal(t,this.processedTrack||this.nativeTrack)}setSettings(t,i=!1){return d(this,null,function*(){let r=this.buildNewSettings(t);if(yield this.handleDeviceChange(r,i),!this.enabled||$(this.nativeTrack)){this.settings=r;return}yield this.handleSettingsChange(r),this.settings=r})}getPlugins(){return this.mediaStreamPluginsManager.getPlugins().length>0?this.mediaStreamPluginsManager.getPlugins():this.pluginsManager.getPlugins()}addPlugin(t,i){return d(this,null,function*(){if(this.mediaStreamPluginsManager.getPlugins().length>0)throw Error("Plugins of type HMSVideoPlugin and HMSMediaStreamPlugin cannot be used together");return this.pluginsManager.addPlugin(t,i)})}removePlugin(t){return d(this,null,function*(){return this.pluginsManager.removePlugin(t)})}validatePlugin(t){return this.pluginsManager.validatePlugin(t)}cleanup(){return d(this,null,function*(){var t;H(n.prototype,this,"cleanup").call(this),this.transceiver=void 0,yield this.pluginsManager.cleanup(),(t=this.processedTrack)==null||t.stop(),this.isPublished=!1})}cropTo(t){return d(this,null,function*(){if(t&&this.source==="screen")try{this.nativeTrack.cropTo&&(yield this.nativeTrack.cropTo(t))}catch(i){throw c.e(this.TAG,"failed to crop screenshare capture - ",i),h.TracksErrors.GenericTrack("TRACK","failed to crop screenshare capture")}})}getCaptureHandle(){if(this.nativeTrack.getCaptureHandle)return this.nativeTrack.getCaptureHandle()}setProcessedTrack(t){return d(this,null,function*(){if(!this.nativeTrack.enabled){this.processedTrack=t;return}yield this.removeOrReplaceProcessedTrack(t),this.videoHandler.updateSinks()})}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled?this.processedTrack||this.nativeTrack:this.nativeTrack}switchCamera(){return d(this,null,function*(){var s;let t=this.getMediaTrackSettings().facingMode;if(!t||this.source!=="regular"){c.d(this.TAG,"facingMode not supported");return}let i=t==="environment"?"user":"environment";(s=this.nativeTrack)==null||s.stop();let r=yield this.replaceTrackWith(this.buildNewSettings({facingMode:i,deviceId:void 0}));yield this.replaceSender(r,this.enabled),this.nativeTrack=r,this.videoHandler.updateSinks(),this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId,facingMode:i}),D.updateSelection("videoInput",{deviceId:this.settings.deviceId,groupId:this.nativeTrack.getSettings().groupId})})}replaceTrackWith(t){return d(this,null,function*(){let i=this.nativeTrack;i==null||i.stop();try{let r=yield vt(t);return c.d(this.TAG,"replaceTrack, Previous track stopped",i,"newTrack",r),this.settings.deviceId==="default"&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),r}catch(r){throw this.isPublished&&this.eventBus.analytics.publish(P.publish({error:r})),r}})}replaceTrackWithBlank(){return d(this,null,function*(){let t=this.nativeTrack,i=Y.getEmptyVideoTrack(t);return t==null||t.stop(),c.d(this.TAG,"replaceTrackWithBlank, Previous track stopped",t,"newTrack",i),i})}replaceSender(t,i){return d(this,null,function*(){let r=this.stream;i?yield r.replaceSenderTrack(this.nativeTrack,this.processedTrack||t):yield r.replaceSenderTrack(this.processedTrack||this.nativeTrack,t),r.replaceStreamTrack(this.nativeTrack,t)})}};var w=class n extends be{constructor(t,i,r){super(t,i,r);this._degraded=!1;this._degradedAt=null;this._layerDefinitions=[];this.history=new Ai;this.preferredLayer="high";this.setVideoHandler(new Ie(this))}setTrackId(t){this.bizTrackId=t}get trackId(){return this.bizTrackId||super.trackId}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(t){return d(this,null,function*(){t!==this.enabled&&(H(n.prototype,this,"setEnabled").call(this,t),this.videoHandler.updateSinks(!0))})}setPreferredLayer(t){return d(this,null,function*(){if(t==="none"){c.w("layer none will be ignored");return}if(this.preferredLayer=t,!!this.shouldSendVideoLayer(t,"preferLayer")){if(!this.hasSinks()){c.d(`[Remote Track] ${this.logIdentifier}
        streamId=${this.stream.id} 
        trackId=${this.trackId}
        saving ${t}, source=${this.source}
        Track does not have any sink`);return}yield this.requestLayer(t,"preferLayer"),this.pushInHistory(`uiPreferLayer-${t}`)}})}getSimulcastLayer(){return this.stream.getSimulcastLayer()}getLayer(){return this.stream.getVideoLayer()}getPreferredLayer(){return this.preferredLayer}replaceTrack(t){this.nativeTrack=t.nativeTrack,t.transceiver&&(this.transceiver=t.transceiver,this.stream.updateId(t.stream.id)),this.videoHandler.updateSinks()}addSink(t,i=!0){return d(this,null,function*(){$(this.nativeTrack)?yield this.requestLayer(this.preferredLayer,"addSink"):(H(n.prototype,this,"addSink").call(this,t),i&&(yield this.updateLayer("addSink"))),this.pushInHistory("uiSetLayer-high")})}removeSink(t,i=!0){return d(this,null,function*(){H(n.prototype,this,"removeSink").call(this,t),i&&(yield this.updateLayer("removeSink")),this._degraded=!1,this.pushInHistory("uiSetLayer-none")})}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(t){this._layerDefinitions=t}setLayerFromServer(t){this._degraded=this.enabled&&(t.publisher_degraded||t.subscriber_degraded)&&t.current_layer==="none",this._degradedAt=this._degraded?new Date:this._degradedAt;let i=t.current_layer;return c.d(`[Remote Track] ${this.logIdentifier} 
      streamId=${this.stream.id} 
      trackId=${this.trackId}
      layer update from sfu
      currLayer=${t.current_layer}
      preferredLayer=${t.expected_layer}
      sub_degraded=${t.subscriber_degraded}
      pub_degraded=${t.publisher_degraded}
      isDegraded=${this._degraded}`),this.stream.setVideoLayerLocally(i,this.logIdentifier,"setLayerFromServer"),this.pushInHistory(`sfuLayerUpdate-${i}`),this._degraded}updateLayer(t){return d(this,null,function*(){let i=this.degraded||!this.enabled||!this.hasSinks()?"none":this.preferredLayer;this.shouldSendVideoLayer(i,t)&&(yield this.requestLayer(i,t))})}pushInHistory(t){!1&&this.history.push({name:t,layer:this.getLayer(),degraded:this.degraded})}requestLayer(t,i){return d(this,null,function*(){try{let r=yield this.stream.setVideoLayer(t,this.trackId,this.logIdentifier,i);return c.d(`[Remote Track] ${this.logIdentifier} 
      streamId=${this.stream.id}
      trackId=${this.trackId}
      Requested layer ${t}, source=${i}`),r}catch(r){throw c.d(`[Remote Track] ${this.logIdentifier} 
      streamId=${this.stream.id}
      trackId=${this.trackId}
      Failed to set layer ${t}, source=${i}
      error=${r.message}`),r}})}shouldSendVideoLayer(t,i){let r=this.getLayer();return this.degraded&&t==="none"?!0:r===t?(c.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${t}, source=${i}`),!1):!0}},Ai=class{constructor(){this.history=[]}push(e){e.time=new Date().toISOString().split("T")[1],this.history.push(e)}};var ne=class extends pe{constructor(){super(...arguments);this.TAG="[HMSLocalStream]";this.connection=null}setConnection(t){this.connection=t}addTransceiver(t,i){let r=this.connection.addTransceiver(t.getTrackBeingSent(),{streams:[this.nativeStream],direction:"sendonly",sendEncodings:this.getTrackEncodings(t,i)});return this.setPreferredCodec(r,t.nativeTrack.kind),t.transceiver=r,r}setMaxBitrateAndFramerate(t){return d(this,null,function*(){var i;yield(i=this.connection)==null?void 0:i.setMaxBitrateAndFramerate(t)})}setPreferredCodec(t,i){}replaceStreamTrack(t,i){this.nativeStream.addTrack(i),this.nativeStream.removeTrack(t),c.d(this.TAG,"Native stream tracks after replace",this.nativeStream.getAudioTracks().map(ee),`prev Track - ${ee(t)}`,`new Track - ${ee(i)}`)}replaceSenderTrack(t,i){return d(this,null,function*(){if(!this.connection||this.connection.connectionState==="closed"){c.d(this.TAG,"publish connection is not initialised or closed");return}let r=this.connection.getSenders().find(s=>s.track&&s.track.id===t.id);if(r===void 0){c.w(this.TAG,`No sender found for trackId=${t.id}`);return}yield r.replaceTrack(i)})}removeSender(t){var s,a;if(!this.connection||this.connection.connectionState==="closed"){c.d(this.TAG,"publish connection is not initialised or closed");return}let i=(s=t.transceiver)==null?void 0:s.sender;if(!i){c.w(this.TAG,`No sender found for trackId=${t.trackId}`);return}(a=this.connection)==null||a.removeTrack(i);let r=this.tracks.indexOf(t);r!==-1?this.tracks.splice(r,1):c.w(this.TAG,`Cannot find ${t.trackId} in locally stored tracks`)}getTrackEncodings(t,i){let r=[];if(t instanceof F)if(i.length>0)c.d(this.TAG,"Simulcast enabled with layers",i),r.push(...i);else{let s={active:this.nativeStream.active};t.settings.maxBitrate&&!ue&&(s.maxBitrate=t.settings.maxBitrate),r.push(s)}return r}};var J=class extends pe{constructor(t,i){super(t);this.audio=!0;this.video="none";this.connection=i}setAudio(t,i,r){return d(this,null,function*(){this.audio!==t&&(this.audio=t,c.d(`[Remote stream] ${r||""} 
    streamId=${this.id}
    trackId=${i}
    subscribing audio - ${this.audio}`),yield this.connection.sendOverApiDataChannelWithResponse({params:{subscribed:this.audio,track_id:i},method:"prefer-audio-track-state"}))})}setVideoLayerLocally(t,i,r){this.video=t,c.d(`[Remote stream] ${i}
    streamId=${this.id}
    source: ${r}
    Setting layer field to=${t}`)}setVideoLayer(t,i,r,s){return c.d(`[Remote stream] ${r} 
      streamId=${this.id}
      trackId=${i} 
      source: ${s} request ${t} layer`),this.setVideoLayerLocally(t,r,s),this.connection.sendOverApiDataChannelWithResponse({params:{max_spatial_layer:this.video,track_id:i},method:"prefer-video-track-state"})}getSimulcastLayer(){return this.video}getVideoLayer(){return this.video}isAudioSubscribed(){return this.audio}};function Il(){return d(this,null,function*(){let n=new O().build(),e=new x().build();try{(yield Tt(e)).stop()}catch(i){if(ls(i))throw(yield er({audio:!1,video:!0})).getTracks().forEach(s=>s.stop()),i}return(yield vt(n)).stop(),!1})}function ls(n){return n instanceof S&&n.action==="TRACK"}var hr=(n,e,t,i)=>d(void 0,null,function*(){var a;let r,s={};if((a=e.transceiver)!=null&&a.sender.track){try{r=yield e.transceiver.sender.getStats();let o={},l={},p={};r==null||r.forEach(u=>{switch(u.type){case"outbound-rtp":l[u.id]=u;break;case"remote-inbound-rtp":p[u.ssrc]=u;break;case"codec":o[u.id]=u.mimeType;break;default:break}}),Object.keys(m({},l)).forEach(u=>{var G,He;let g=(G=l[u])==null?void 0:G.codecId,T=g?o[g]:void 0,v;T&&(v=T.substring(T.indexOf("/")+1));let A=y(m({},l[u]),{rid:(He=l[u])==null?void 0:He.rid}),f=p[A.ssrc];s[u]=y(m({},A),{bitrate:Ri("bytesSent",A,i==null?void 0:i[u]),packetsLost:f==null?void 0:f.packetsLost,jitter:f==null?void 0:f.jitter,roundTripTime:f==null?void 0:f.roundTripTime,totalRoundTripTime:f==null?void 0:f.totalRoundTripTime,peerName:t,peerID:e.peerId,enabled:e.enabled,codec:v})})}catch(o){n.analytics.publish(P.rtcStatsFailed(h.WebrtcErrors.StatsFailed("TRACK",`Error getting local track stats ${e.trackId} - ${o.message}`))),c.w("[HMSWebrtcStats]","Error in getting local track stats",e,o,o.name)}return s}}),mr=(n,e,t,i)=>d(void 0,null,function*(){var l;let r;try{r=yield(l=e.transceiver)==null?void 0:l.receiver.getStats()}catch(p){n.analytics.publish(P.rtcStatsFailed(h.WebrtcErrors.StatsFailed("TRACK",`Error getting remote track stats ${e.trackId} - ${p.message}`))),c.w("[HMSWebrtcStats]","Error in getting remote track stats",e,p)}let s=us(r),a=Ri("bytesReceived",s,i),o=bi("packetsLost",s,i);return s!=null&&s.remote&&Object.assign(s.remote,{packetsLostRate:bi("packetsLost",s.remote,i==null?void 0:i.remote)}),s&&Object.assign(s,{bitrate:a,packetsLostRate:o,peerId:e.peerId,enabled:e.enabled,peerName:t,codec:s.codec})}),us=n=>{let e,t,i={};n==null||n.forEach(a=>{switch(a.type){case"inbound-rtp":e=a;break;case"outbound-rtp":e=a;break;case"remote-inbound-rtp":t=a;break;case"codec":i[a.id]=a.mimeType;break;default:break}});let r=e!=null&&e.codecId?i[e.codecId]:void 0,s;return r&&(s=r.substring(r.indexOf("/")+1)),e&&Object.assign(e,{remote:t,codec:s})},Ii=(n,e,t)=>{let i=ps(e),r=Ri(n==="publish"?"bytesSent":"bytesReceived",i,t&&t[n]);return i&&Object.assign(i,{bitrate:r})},ps=n=>{let e;return n==null||n.forEach(t=>{t.type==="transport"&&(e=n==null?void 0:n.get(t.selectedCandidatePairId))}),e||n==null||n.forEach(t=>{t.type==="candidate-pair"&&t.selected&&(e=t)}),e},gr=n=>{let e={packetsLost:0,jitter:0};return n==null||n.forEach(t=>{t.packetsLost&&(e.packetsLost+=t.packetsLost),t.jitter>e.jitter&&(e.jitter=t.jitter)}),e},Sr=(n,e)=>Array.from(new Set(n.concat(e))),Ri=(n,e,t)=>bi(n,e,t)*8,bi=(n,e,t)=>{let i=e&&e[n],r=t?t[n]:null;return[e,t,U(i),U(r)].every(a=>!!a)?Ci(i,r,e==null?void 0:e.timestamp,t==null?void 0:t.timestamp)*1e3:0},Ci=(n,e,t,i)=>U(n)&&U(e)&&t&&i?(n-e)/(t-i):0;var $e=class{constructor(e,t,i){this.getStats=e;this.store=t;this.eventBus=i;this.TAG="[HMSWebrtcStats]";this.peerStats={};this.remoteTrackStats={};this.localTrackStats={};this.getLocalPeerStats=()=>this.peerStats[this.localPeerID];this.getRemoteTrackStats=e=>this.remoteTrackStats[e];this.getAllRemoteTracksStats=()=>this.remoteTrackStats;this.getLocalTrackStats=()=>this.localTrackStats;this.updateStats=()=>d(this,null,function*(){yield this.updateLocalPeerStats(),yield this.updateLocalTrackStats(),yield this.updateRemoteTrackStats()});this.updateLocalPeerStats=()=>d(this,null,function*(){var u,g,T,v,A,f;let e=this.getLocalPeerStats(),t;try{t=yield(g=(u=this.getStats).publish)==null?void 0:g.call(u)}catch(G){this.eventBus.analytics.publish(P.rtcStatsFailed(h.WebrtcErrors.StatsFailed("PUBLISH",G.message))),c.w(this.TAG,"Error in getting publish stats",G)}let i=t&&Ii("publish",t,e),r;try{r=yield(v=(T=this.getStats).subscribe)==null?void 0:v.call(T)}catch(G){this.eventBus.analytics.publish(P.rtcStatsFailed(h.WebrtcErrors.StatsFailed("SUBSCRIBE",G.message))),c.w(this.TAG,"Error in getting subscribe stats",G)}let s=r&&Ii("subscribe",r,e),{packetsLost:a,jitter:o}=gr(r),l=Ci(a,(A=e==null?void 0:e.subscribe)==null?void 0:A.packetsLost,s==null?void 0:s.timestamp,(f=e==null?void 0:e.subscribe)==null?void 0:f.timestamp),p=s&&Object.assign(s,{packetsLostRate:l,jitter:o,packetsLost:a});this.peerStats[this.localPeerID]={publish:i,subscribe:p}});this.updateRemoteTrackStats=()=>d(this,null,function*(){var i;let e=Array.from(this.store.getTracksMap().values()).filter(r=>r instanceof w||r instanceof ae),t=e.map(r=>r.trackId);Object.keys(this.remoteTrackStats).forEach(r=>{t.includes(r)||delete this.remoteTrackStats[r]});for(let r of e){let s=r.peerId&&((i=this.store.getPeerById(r.peerId))==null?void 0:i.name),a=this.getRemoteTrackStats(r.trackId),o=yield mr(this.eventBus,r,s,a);o&&(this.remoteTrackStats[r.trackId]=o)}});this.updateLocalTrackStats=()=>d(this,null,function*(){var i;let e=this.store.getLocalPeerTracks().reduce((r,s)=>(r[s.getTrackIDBeingSent()]=s,r),{}),t=Sr(Object.keys(this.localTrackStats),Object.keys(e));for(let r of t){let s=e[r];if(s){let a=(i=this.store.getLocalPeer())==null?void 0:i.name,o=yield hr(this.eventBus,s,a,this.localTrackStats[r]);o&&(this.localTrackStats[r]=o)}else delete this.localTrackStats[r]}});var r;this.localPeerID=(r=this.store.getLocalPeer())==null?void 0:r.peerId}};var Ke=class{constructor(e,t,i,r){this.store=e;this.eventBus=t;this.publishConnection=i;this.subscribeConnection=r;this.TAG="[HMSWebrtcInternals]";this.interval=1e3;this.isMonitored=!1;this.handleStatsUpdate=()=>d(this,null,function*(){var e;yield(e=this.hmsStats)==null?void 0:e.updateStats(),this.eventBus.statsUpdate.publish(this.hmsStats)})}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}getCurrentStats(){return this.hmsStats}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){var i,r;this.publishConnection=e,this.subscribeConnection=t,this.hmsStats=new $e({publish:(i=this.publishConnection)==null?void 0:i.getStats.bind(this.publishConnection),subscribe:(r=this.subscribeConnection)==null?void 0:r.getStats.bind(this.subscribeConnection)},this.store,this.eventBus)}start(){return d(this,null,function*(){if(this.isMonitored){c.d(this.TAG,"Already started");return}this.stop(),this.isMonitored=!0,c.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then(()=>c.d(this.TAG,"Stopping Webrtc Stats Monitor")).catch(e=>{this.eventBus.analytics.publish(P.rtcStatsFailed(h.WebrtcErrors.StatsFailed("PUBLISH",e.message))),c.e(this.TAG,e.message)})})}stop(){this.isMonitored=!1}startLoop(){return d(this,null,function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield N(this.interval)})}cleanup(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}};var ms=gi().version;c.d("adapter",`${Tr.browserDetails.browser} v${Tr.browserDetails.version}`);c.d("sdk version",ms);var Li={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},q,Mt,Y=class n{constructor(e,t,i,r,s){this.store=e;this.observer=t;this.deviceManager=i;this.eventBus=r;this.analyticsTimer=s;this.TAG="[LocalTrackManager]";this.setScreenCaptureHandleConfig()}getTracksToPublish(){return d(this,arguments,function*(e=Li){let t=this.getAVTrackSettings(e);if(!t)return[];let i=!!t.audio,r=!!t.video,s=[],{videoTrack:a,audioTrack:o}=yield this.updateCurrentLocalTrackSettings(t),l=(a==null?void 0:a.stream)||(o==null?void 0:o.stream),p=!!(a&&this.store.getTrackById(a.trackId)),u=!!(o&&this.store.getTrackById(o.trackId));if(p&&u)return[];let g={audio:i&&!o&&(e.isAudioMuted?"empty":!0),video:r&&!a&&(e.isVideoMuted?"empty":!0)};g.audio&&this.analyticsTimer.start("local_audio_track_time"),g.video&&this.analyticsTimer.start("local_video_track_time");try{c.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:g}),s=yield this.getLocalTracks(g,t,l)}catch(T){s=yield this.retryGetLocalTracks(T,t,g,l)}return g.audio&&this.analyticsTimer.end("local_audio_track_time"),g.video&&this.analyticsTimer.end("local_video_track_time"),a&&r&&!p&&s.push(a),o&&i&&!u&&s.push(o),s})}getLocalTracks(){return d(this,arguments,function*(e={audio:!0,video:!0},t,i){try{let r=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(r,t,i)}catch(r){throw this.eventBus.analytics.publish(P.publish({devices:this.deviceManager.getDevices(),error:r,settings:t})),r}})}getNativeLocalTracks(){return d(this,arguments,function*(e={audio:!1,video:!1},t){let i=new Ae(e.video===!0?t.video:null,e.audio===!0?t.audio:null,t.simulcast),r=[];return(i.audio||i.video)&&r.push(...yield this.getAVTracks(i)),r.push(...this.getEmptyTracks(e)),r})}getLocalScreen(e){return d(this,null,function*(){var g;let t=yield this.getOrDefaultScreenshareConfig(e),i=this.getScreenshareSettings(t.videoOnly),r={video:y(m({},i==null?void 0:i.video.toConstraints(!0)),{displaySurface:t.displaySurface}),preferCurrentTab:t.preferCurrentTab,selfBrowserSurface:t.selfBrowserSurface,surfaceSwitching:t.surfaceSwitching,systemAudio:t.systemAudio};if(i!=null&&i.audio){let T=(g=i==null?void 0:i.audio)==null?void 0:g.toConstraints();delete T.advanced,r.audio=y(m({},T),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}let s;try{c.d("retrieving screenshare with ",{config:t},{constraints:r}),s=yield navigator.mediaDevices.getDisplayMedia(r)}catch(T){c.w(this.TAG,"error in getting screenshare - ",T);let v=W(T,"screen");throw this.eventBus.analytics.publish(P.publish({error:v,devices:this.deviceManager.getDevices(),settings:new Ae(i==null?void 0:i.video,i==null?void 0:i.audio,!1)})),v}let a=[],o=new ne(s),l=s.getVideoTracks()[0],p=new F(o,l,"screen",this.eventBus,i==null?void 0:i.video);p.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"screen"));try{let T=this.validateCurrentTabCapture(p,t.forceCurrentTab);p.isCurrentTab=T,yield p.cropTo(t.cropTarget)}catch(T){throw s.getTracks().forEach(v=>v.stop()),T}a.push(p);let u=s.getAudioTracks()[0];if(u){let T=new Se(o,u,"screen",this.eventBus,i==null?void 0:i.audio);a.push(T)}return c.v(this.TAG,"getLocalScreen",a),a})}setScreenCaptureHandleConfig(e){var t;!((t=navigator.mediaDevices)!=null&&t.setCaptureHandleConfig)||this.isInIframe()||(e=e||{},Object.assign(e,{handle:gs(),exposeOrigin:!1,permittedOrigins:[window.location.origin]}),c.d("setting capture handle - ",e.handle),navigator.mediaDevices.setCaptureHandleConfig(e),this.captureHandleIdentifier=e.handle)}validateCurrentTabCapture(e,t){let i=e.getCaptureHandle(),r=!!(this.captureHandleIdentifier&&(i==null?void 0:i.handle)===this.captureHandleIdentifier);if(t&&!r)throw c.e(this.TAG,"current tab was not shared with forceCurrentTab as true"),h.TracksErrors.CurrentTabNotShared();return r}requestPermissions(){return d(this,null,function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach(t=>t.stop())}catch(e){c.e(this.TAG,e)}})}static getEmptyVideoTrack(e){var o,l,p;let t=((o=e==null?void 0:e.getSettings())==null?void 0:o.width)||320,i=((l=e==null?void 0:e.getSettings())==null?void 0:l.height)||240,r=1;q||(q=document.createElement("canvas"),q.width=t,q.height=i,(p=q.getContext("2d"))==null||p.fillRect(0,0,t,i)),Mt||(Mt=setInterval(()=>{let u=q==null?void 0:q.getContext("2d");u&&u.fillRect(0,0,1,1)},1e3/r));let a=q.captureStream(r).getVideoTracks()[0];return a.enabled=!1,a}static getEmptyAudioTrack(){let e=ie.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let r=i.stream.getAudioTracks()[0];return r.enabled=!1,r}static cleanup(){clearInterval(Mt),Mt=void 0,q=void 0}getAVTracks(e){return d(this,null,function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:e.audio?e.audio.toConstraints():!1,video:e.video?e.video.toConstraints():!1});return t.getVideoTracks().concat(t.getAudioTracks())}catch(t){yield this.deviceManager.init();let i=!!(!this.deviceManager.hasWebcamPermission&&e.video),r=!!(!this.deviceManager.hasMicrophonePermission&&e.audio),s=this.getErrorType(i,r);throw W(t,s)}})}getAVTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);return!t&&!i?null:new Ue().video(i).audio(t).build()}isInIframe(){try{return window.self!==window.top}catch(e){return!0}}retryGetLocalTracks(e,t,i,r){return d(this,null,function*(){if(e instanceof S&&e.action==="TRACK"){this.observer.onFailure(e);let s=e.code===E.TracksErrors.OVER_CONSTRAINED,a=e.message.includes("audio"),o=e.message.includes("video");if(s){let l=new Ue().video(new ge).audio(new me).build();c.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,l,r)}catch(p){let u=p instanceof S?p.nativeError:p,g=p;if((u==null?void 0:u.name)==="OverconstrainedError"){let T=h.TracksErrors.GenericTrack("TRACK","Overconstrained error after dropping all constraints");T.addNativeError(u),g=T}return yield this.retryGetLocalTracks(g,t,i,r)}}i.audio=a?"empty":i.audio,i.video=o?"empty":i.video,c.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,r)}catch(l){return c.w(this.TAG,"Fetch empty tacks failed",l),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(l),yield this.getLocalTracks(i,t,r)}}else return c.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[]})}getErrorType(e,t){return e&&t?"audio, video":e?"video":t?"audio":"unknown(video or audio)"}getEmptyTracks(e){let t=[];return e.audio==="empty"&&t.push(n.getEmptyAudioTrack()),e.video==="empty"&&t.push(n.getEmptyVideoTrack()),t}updateCurrentLocalTrackSettings(e){return d(this,null,function*(){let t=this.store.getLocalPeerTracks(),i=t.find(o=>o.type==="video"&&o.source==="regular"),r=t.find(o=>o.type==="audio"&&o.source==="regular"),s=t.find(o=>o.type==="video"&&o.source==="screen");e!=null&&e.video&&(yield i==null?void 0:i.setSettings(e.video)),e!=null&&e.audio&&(yield r==null?void 0:r.setSettings(e.audio));let a=this.getScreenshareSettings(!0);return a!=null&&a.video&&(yield s==null?void 0:s.setSettings(a==null?void 0:a.video)),{videoTrack:i,audioTrack:r}})}getAudioSettings(e){var a;let t=this.store.getPublishParams();if(!t||!((a=t.allowed)!=null&&a.includes("audio")))return null;let i=this.store.getLocalPeer(),r=i==null?void 0:i.audioTrack,s=(r==null?void 0:r.settings.deviceId)||e.audioInputDeviceId;return new x().codec(t.audio.codec).maxBitrate(t.audio.bitRate).deviceId(s||Li.audioInputDeviceId).build()}getVideoSettings(e){var o;let t=this.store.getPublishParams();if(!t||!((o=t.allowed)!=null&&o.includes("video")))return null;let i=this.store.getLocalPeer(),r=i==null?void 0:i.videoTrack,s=(r==null?void 0:r.settings.deviceId)||e.videoDeviceId,a=t.video;return new O().codec(a.codec).maxBitrate(a.bitRate).maxFramerate(a.frameRate).setWidth(a.width).setHeight(a.height).deviceId(s||Li.videoDeviceId).build()}getScreenshareSettings(e=!1){var r;let t=this.store.getPublishParams();if(!t||!((r=t.allowed)!=null&&r.includes("screen")))return null;let i=t.screen;return{video:new O().maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth(i.width).setHeight(i.height).build(),audio:e?void 0:new x().build()}}getOrDefaultScreenshareConfig(e){return d(this,null,function*(){var i;let t=Object.assign({videoOnly:!1,audioOnly:!1,forceCurrentTab:!1,preferCurrentTab:!1,selfBrowserSurface:"exclude",surfaceSwitching:"include",systemAudio:"exclude",displaySurface:"monitor"},e||{});return t.forceCurrentTab&&(t.videoOnly=!0,t.preferCurrentTab=!0,t.selfBrowserSurface="include",t.surfaceSwitching="exclude"),t.preferCurrentTab&&(t.selfBrowserSurface="include",t.displaySurface=void 0),t.cropElement&&((i=window.CropTarget)!=null&&i.fromElement)&&(t.cropTarget=yield window.CropTarget.fromElement(t.cropElement)),t})}createHMSLocalTracks(e,t,i){let r=e.find(o=>o.kind==="video"),s=e.find(o=>o.kind==="audio");i?e.forEach(o=>i==null?void 0:i.nativeStream.addTrack(o)):i=new ne(new MediaStream(e));let a=[];if(s&&(t!=null&&t.audio)){let o=new Se(i,s,"regular",this.eventBus,t.audio);a.push(o)}if(r&&(t!=null&&t.video)){let o=new F(i,r,"regular",this.eventBus,t.video);o.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"regular")),a.push(o)}return a}};var kt=class{constructor(e,t){this.eventBus=e;this.listener=t;this.TAG="[NetworkTestManager]";this.controller=new AbortController;this.start=e=>d(this,null,function*(){var p;if(!e)return;let{url:t,timeout:i,scoreMap:r}=e,s=this.controller.signal,a=Date.now(),o=0,l=N(i).then(()=>{this.controller.abort()});try{let g=(p=(yield fetch(`${t}?${Date.now()}`,{signal:s})).body)==null?void 0:p.getReader();if(!g)throw Error("unable to process request");let T=()=>d(this,null,function*(){if(g)try{let v=!1;for(;!v;){let{value:A,done:f}=yield g.read();v=f,A&&(o+=A.byteLength,this.sendScore({scoreMap:r,downloadedSize:o,startTime:a}))}}catch(v){v.name!=="AbortError"&&c.d(this.TAG,v)}});return Promise.race([T(),l]).then(()=>{this.sendScore({scoreMap:r,downloadedSize:o,startTime:a,finished:!0})}).catch(v=>{c.d(this.TAG,v),this.updateScoreToListener(0),this.eventBus.analytics.publish(P.previewNetworkQuality({error:v.message}))})}catch(u){u.name!=="AbortError"?(c.d(this.TAG,u),this.updateScoreToListener(0),this.eventBus.analytics.publish(P.previewNetworkQuality({error:u.message}))):c.d(this.TAG,u)}});this.stop=()=>{this.controller.signal.aborted||this.controller.abort()};this.sendScore=({scoreMap:e,downloadedSize:t,startTime:i,finished:r=!1})=>{let s=(Date.now()-i)/1e3,o=t/1024/s*8,l=-1;for(let p in e){let u=e[p];o>=u.low&&(!u.high||o<=u.high)&&(l=Number(p))}this.updateScoreToListener(l),r&&this.eventBus.analytics.publish(P.previewNetworkQuality({score:l,downLink:o.toFixed(2)}))}}updateScoreToListener(e){var t,i;e!==this.score&&(this.score=e,(i=(t=this.listener)==null?void 0:t.onNetworkQuality)==null||i.call(t,e))}};var qe=class{constructor(e,t,i,r,s,a){this.store=e;this.transport=t;this.deviceManager=i;this.publish=r;this.removeAuxiliaryTrack=s;this.listener=a;this.handleLocalPeerRoleUpdate=i=>d(this,[i],function*({oldRole:e,newRole:t}){var s;let r=this.store.getLocalPeer();r&&(yield this.diffRolesAndPublishTracks({oldRole:e,newRole:t}),(s=this.listener)==null||s.onPeerUpdate(8,r))});this.diffRolesAndPublishTracks=i=>d(this,[i],function*({oldRole:e,newRole:t}){var v,A,f,G,He,Ni;let r=new Set(e.publishParams.allowed),s=new Set(t.publishParams.allowed),a=this.removeTrack(r,s,"video"),o=this.removeTrack(r,s,"audio"),l=this.removeTrack(r,s,"screen"),p=this.hasSimulcastDifference((v=e.publishParams.simulcast)==null?void 0:v.video,(A=t.publishParams.simulcast)==null?void 0:A.video),u=this.hasSimulcastDifference((f=e.publishParams.simulcast)==null?void 0:f.screen,(G=t.publishParams.simulcast)==null?void 0:G.screen),g=(Ni=(He=this.store.getLocalPeer())==null?void 0:He.videoTrack)==null?void 0:Ni.enabled;yield this.removeAudioTrack(o),yield this.removeVideoTracks(a||p),yield this.removeScreenTracks(l||u);let T=this.getSettings();p&&(T.isVideoMuted=!g),yield this.publish(T),yield this.syncDevices(T,t)})}syncDevices(e,t){return d(this,null,function*(){(!e.isAudioMuted||!e.isVideoMuted)&&t.publishParams.allowed.length>0&&(yield this.deviceManager.init(!0))})}removeVideoTracks(e){return d(this,null,function*(){var i;if(!e)return;let t=this.store.getLocalPeer();t!=null&&t.videoTrack&&(t.videoTrack.isPublished?yield this.transport.unpublish([t.videoTrack]):yield t.videoTrack.cleanup(),(i=this.listener)==null||i.onTrackUpdate(1,t.videoTrack,t),t.videoTrack=void 0),yield this.removeAuxTracks(r=>r.source!=="screen"&&r.type==="video")})}removeAudioTrack(e){return d(this,null,function*(){var i;if(!e)return;let t=this.store.getLocalPeer();t!=null&&t.audioTrack&&(t.audioTrack.isPublished?yield this.transport.unpublish([t.audioTrack]):yield t.audioTrack.cleanup(),(i=this.listener)==null||i.onTrackUpdate(1,t.audioTrack,t),t.audioTrack=void 0),yield this.removeAuxTracks(r=>r.source!=="screen"&&r.type==="audio")})}removeScreenTracks(e){return d(this,null,function*(){e&&(yield this.removeAuxTracks(t=>t.source==="screen"))})}removeAuxTracks(e){return d(this,null,function*(){let t=this.store.getLocalPeer();if(t!=null&&t.auxiliaryTracks){let i=[...t.auxiliaryTracks];for(let r of i)e(r)&&(yield this.removeAuxiliaryTrack(r.trackId))}})}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}hasSimulcastDifference(e,t){var i,r,s;return!e&&!t?!1:((i=e==null?void 0:e.layers)==null?void 0:i.length)!==((r=t==null?void 0:t.layers)==null?void 0:r.length)?!0:!!((s=e==null?void 0:e.layers)!=null&&s.some(a=>{var l;let o=(l=t==null?void 0:t.layers)==null?void 0:l.find(p=>p.rid===a.rid);return(o==null?void 0:o.maxBitrate)!==a.maxBitrate||(o==null?void 0:o.maxFramerate)!==a.maxFramerate}))}getSettings(){var t,i,r;let e=(t=this.store.getConfig())==null?void 0:t.settings;return{isAudioMuted:(i=e==null?void 0:e.isAudioMuted)!=null?i:!0,isVideoMuted:(r=e==null?void 0:e.isVideoMuted)!=null?r:!0,audioInputDeviceId:(e==null?void 0:e.audioInputDeviceId)||"default",audioOutputDeviceId:(e==null?void 0:e.audioOutputDeviceId)||"default",videoDeviceId:(e==null?void 0:e.videoDeviceId)||"default"}}};var wi=class{constructor(){this.TAG="[HTTPAnalyticsTransport]";this.failedEvents=new V("client-events");this.isConnected=!0;this.env=null;this.websocketURL=""}setEnv(e){this.env=e,this.flushFailedEvents()}setWebsocketEndpoint(e){this.websocketURL=e}sendEvent(e){if(!this.env){this.addEventToStorage(e);return}let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,device_id:e.device_id,cluster:{websocket_url:this.websocketURL}},i=this.env==="prod"?Ui:Bi;fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`,user_agent_v2:e.metadata.userAgent},body:JSON.stringify(t)}).then(r=>{if(r.status===401){this.removeFromStorage(e);return}if(r.status!==200)throw Error(r.statusText);this.removeFromStorage(e)}).catch(r=>{c.v(this.TAG,"Failed to send event",r,e),this.addEventToStorage(e)})}flushFailedEvents(){let e=this.failedEvents.get();e==null||e.forEach(t=>this.sendEvent(t))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find(i=>i.timestamp===e.timestamp)||(t.length===100&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex(r=>r.timestamp===e.timestamp);i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},X=new wi;var je=class{constructor(){this.knownRoles={};this.peers={};this.tracks=new Map;this.peerTrackStates={};this.speakers=[];this.roleDetailsArrived=!1;this.env="prod";this.simulcastEnabled=!1;this.userAgent=xe(this.env);this.polls=new Map;this.whiteboards=new Map}getConfig(){return this.config}setSimulcastEnabled(e){this.simulcastEnabled=e}getEnv(){return this.env}getPublishParams(){let e=this.getLocalPeer(),t=(e==null?void 0:e.asRole)||(e==null?void 0:e.role);return t==null?void 0:t.publishParams}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getTemplateAppData(){return this.templateAppData}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter(e=>!e.isLocal)}getPeers(){return Object.values(this.peers)}getPeerMap(){return this.peers}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Array.from(this.tracks.values())}getVideoTracks(){return this.getTracks().filter(e=>e.type==="video")}getRemoteVideoTracks(){return this.getTracks().filter(e=>e instanceof w)}getAudioTracks(){return this.getTracks().filter(e=>e.type==="audio")}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return t!=null&&t.videoTrack&&i.push(t.videoTrack),t!=null&&t.audioTrack&&i.push(t.audioTrack),i.concat((t==null?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}hasTrack(e){return this.tracks.has(e)}getTrackById(e){var r,s;let t=Array.from(this.tracks.values()).find(a=>a.trackId===e);if(t)return t;let i=this.getLocalPeer();if(i){if((r=i.audioTrack)!=null&&r.isPublishedTrackId(e))return i.audioTrack;if((s=i.videoTrack)!=null&&s.isPublishedTrackId(e))return i.videoTrack}}getPeerByTrackId(e){let t=Array.from(this.tracks.values()).find(i=>i.trackId===e);return t!=null&&t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map(e=>e.peer)}getUserAgent(){return this.userAgent}createAndSetUserAgent(e){this.userAgent=xe(this.env,e)}setRoom(e){this.room=e}setKnownRoles(e){var i,r;if(this.knownRoles=e.known_roles,this.addPluginsToRoles(e.plugins),this.roleDetailsArrived=!0,this.templateAppData=e.app_data,!this.simulcastEnabled)return;let t=(i=this.knownRoles[e.name])==null?void 0:i.publishParams;this.videoLayers=this.convertSimulcastLayers((r=t.simulcast)==null?void 0:r.video),this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,r;if(D.rememberDevices(!!e.rememberDeviceSelection),e.rememberDeviceSelection){let s=D.getSelection();s&&(e.settings||(e.settings={}),(t=s.audioInput)!=null&&t.deviceId&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||s.audioInput.deviceId),(i=s.audioOutput)!=null&&i.deviceId&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||s.audioOutput.deviceId),(r=s.videoInput)!=null&&r.deviceId&&(e.settings.videoDeviceId=e.settings.videoDeviceId||s.videoInput.deviceId))}e.autoManageVideo=e.autoManageVideo!==!1,e.autoManageWakeLock=e.autoManageWakeLock!==!1,this.config=e,this.setEnv()}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks.set(e,e)}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){this.tracks.delete(e)}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){return d(this,null,function*(){for(let t of this.getAudioTracks())yield t.setVolume(e)})}updateAudioOutputDevice(e){return d(this,null,function*(){let t=[];this.getAudioTracks().forEach(i=>{i instanceof ae&&t.push(i.setOutputDevice(e))}),yield Promise.all(t)})}getSimulcastLayers(e){var t;return!this.simulcastEnabled||!["screen","regular"].includes(e)?[]:e==="screen"?[]:((t=this.videoLayers)==null?void 0:t.layers)||[]}convertSimulcastLayers(e){if(e)return y(m({},e),{layers:(e.layers||[]).map(t=>y(m({},t),{maxBitrate:t.maxBitrate*1e3}))})}getSimulcastDefinitionsForPeer(e,t){var o,l,p;if([!e||!e.role,t==="screen",!this.simulcastEnabled].some(u=>!!u))return[];let i=this.getPolicyForRole(e.role.name).publishParams,r,s,a;return t==="regular"?(r=(o=i.simulcast)==null?void 0:o.video,s=i.video.width,a=i.video.height):t==="screen"&&(r=(l=i.simulcast)==null?void 0:l.screen,s=i.screen.width,a=i.screen.height),((p=r==null?void 0:r.layers)==null?void 0:p.map(u=>{let g=fi[u.rid],T={width:Math.floor(s/u.scaleResolutionDownBy),height:Math.floor(a/u.scaleResolutionDownBy)};return{layer:g,resolution:T}}))||[]}setPoll(e){this.polls.set(e.id,e)}getPoll(e){return this.polls.get(e)}setWhiteboard(e){this.whiteboards.set(e.id,e)}getWhiteboard(e){return e?this.whiteboards.get(e):this.whiteboards.values().next().value}getErrorListener(){return this.errorListener}cleanup(){let e=this.getTracks();for(let t of e)t.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach(e=>{var t;if(!e.role){(t=this.errorListener)==null||t.onError(h.GenericErrors.InvalidRole("VALIDATION",""));return}e.role=this.getPolicyForRole(e.role.name)})}addPluginsToRoles(e){if(!e)return;let t=(i,r,s)=>{var o;let a=this.knownRoles[i].permissions;a[r]||(a[r]=[]),(o=a[r])==null||o.push(s)};Object.keys(e).forEach(i=>{var a,o,l;let r=i;if(!e[r])return;let s=e[r].permissions;(a=s==null?void 0:s.admin)==null||a.forEach(p=>t(p,r,"admin")),(o=s==null?void 0:s.reader)==null||o.forEach(p=>t(p,r,"read")),(l=s==null?void 0:s.writer)==null||l.forEach(p=>t(p,r,"write"))})}setEnv(){var r;let t=((r=this.config)==null?void 0:r.initEndpoint).split("https://")[1],i="prod";t.startsWith("prod")?i="prod":t.startsWith("qa")?i="qa":t.startsWith("dev")&&(i="dev"),this.env=i,X.setEnv(i)}};var At=class{constructor(){this.TAG="[WakeLockManager]";this.wakeLock=null;this.acquireLock=()=>d(this,null,function*(){yield this.requestWakeLock(),document==null||document.addEventListener("visibilitychange",this.visibilityHandler)});this.cleanup=()=>d(this,null,function*(){if(this.wakeLock&&!this.wakeLock.released)try{yield this.wakeLock.release(),c.d(this.TAG,"Wake lock released")}catch(e){let t=e;c.w(this.TAG,"Error while releasing wake lock",`name=${t.name}, message=${t.message}`)}this.wakeLock=null});this.visibilityHandler=()=>d(this,null,function*(){(document==null?void 0:document.visibilityState)==="visible"&&(!this.wakeLock||this.wakeLock.released)&&(c.d(this.TAG,"Re-acquiring wake lock due to visibility change"),yield this.requestWakeLock())});this.requestWakeLock=()=>d(this,null,function*(){try{if(!("wakeLock"in navigator)){c.d(this.TAG,"Wake lock feature not supported");return}this.wakeLock=yield navigator.wakeLock.request("screen"),c.d(this.TAG,"Wake lock acquired")}catch(e){let t=e;c.w(this.TAG,"Error acquiring wake lock",`name=${t.name}, message=${t.message}`)}})}};var bt=class{constructor(e){this.store=e;this.bufferSize=100;this.TAG="[AnalyticsEventsService]";this.transport=null;this.pendingEvents=[];this.level=1}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let t=this.pendingEvents.shift();c.d(this.TAG,"Max buffer size reached","Removed event to accommodate new events",t)}return this}flushFailedClientEvents(){X.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=(e=this.store.getLocalPeer())==null?void 0:e.peerId,t.metadata.userAgent=this.store.getUserAgent(),this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(t){c.w(this.TAG,"Flush Failed",t)}}sendClientEventOnHTTP(e){var r,s,a,o;let t=this.store.getRoom(),i=this.store.getLocalPeer();e.metadata.token=(r=this.store.getConfig())==null?void 0:r.authToken,e.metadata.peer={session_id:t==null?void 0:t.sessionId,room_id:t==null?void 0:t.id,room_name:t==null?void 0:t.name,template_id:t==null?void 0:t.templateId,joined_at:(s=t==null?void 0:t.joinedAt)==null?void 0:s.getTime(),session_started_at:(a=t==null?void 0:t.startedAt)==null?void 0:a.getTime(),role:(o=i==null?void 0:i.role)==null?void 0:o.name,user_name:i==null?void 0:i.name,user_data:i==null?void 0:i.metadata,peer_id:i==null?void 0:i.peerId},X.sendEvent(e)}};import{v4 as Ts}from"uuid";var fr={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},Qe=class{constructor(e,t,i){this.store=e;this.deviceManager=t;this.eventBus=i;this.autoPausedTracks=new Set;this.TAG="[AudioSinkManager]:";this.volume=100;this.state=m({},fr);this.handleAudioPaused=e=>d(this,null,function*(){var s;let i=(s=e.target.srcObject)==null?void 0:s.getAudioTracks()[0];if(!(i!=null&&i.enabled))return;c.d(this.TAG,"Audio Paused",e.target.id);let r=this.store.getTrackById(e.target.id);r&&(ht()?(yield N(500),this.playAudioFor(r)):this.autoPausedTracks.add(r))});this.handleTrackUpdate=({track:e})=>{c.d(this.TAG,"Track updated",`${e}`)};this.handleTrackAdd=r=>d(this,[r],function*({track:e,peer:t,callListener:i=!0}){var a,o;let s=document.createElement("audio");s.style.display="none",s.id=e.trackId,s.addEventListener("pause",this.handleAudioPaused),s.onerror=()=>d(this,null,function*(){var p,u;c.e(this.TAG,"error on audio element",s.error);let l=h.TracksErrors.AudioPlaybackError(`Audio playback error for track - ${e.trackId} code - ${(p=s==null?void 0:s.error)==null?void 0:p.code}`);this.eventBus.analytics.publish(P.audioPlaybackError(l)),((u=s==null?void 0:s.error)==null?void 0:u.code)===MediaError.MEDIA_ERR_DECODE&&(this.removeAudioElement(s,e),yield N(500),yield this.handleTrackAdd({track:e,peer:t,callListener:!1}))}),e.setAudioElement(s),e.setVolume(this.volume),c.d(this.TAG,"Audio track added",`${e}`),this.init(),yield this.autoSelectAudioOutput(),(a=this.audioSink)==null||a.append(s),this.outputDevice&&(yield e.setOutputDevice(this.outputDevice)),s.srcObject=new MediaStream([e.nativeTrack]),i&&((o=this.listener)==null||o.onTrackUpdate(0,e,t)),yield this.handleAutoplayError(e)});this.handleAutoplayError=e=>d(this,null,function*(){if(this.state.autoplayFailed===void 0&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise(t=>{this.playAudioFor(e).then(t)})),yield this.state.autoplayCheckPromise),this.state.autoplayFailed){this.autoPausedTracks.add(e);return}yield this.playAudioFor(e)});this.handleAudioDeviceChange=e=>{e.error||!e.selection||e.type==="video"||this.unpauseAudioTracks()};this.handleTrackRemove=e=>{this.autoPausedTracks.delete(e);let t=document.getElementById(e.trackId);t&&this.removeAudioElement(t,e),this.audioSink&&this.audioSink.childElementCount===0&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),c.d(this.TAG,"Audio track removed",`${e}`)};this.unpauseAudioTracks=()=>d(this,null,function*(){let e=[];this.autoPausedTracks.forEach(t=>{e.push(this.playAudioFor(t))}),yield Promise.all(e)});this.removeAudioElement=(e,t)=>{e&&(c.d(this.TAG,"removing audio element",`${t}`),e.removeEventListener("pause",this.handleAudioPaused),e.srcObject=null,e.remove(),t.setAudioElement(null))};this.autoSelectAudioOutput=()=>d(this,null,function*(){var e,t,i;if(((e=this.audioSink)==null?void 0:e.children.length)===0){let r=(t=this.deviceManager.audioInput)==null?void 0:t.find(a=>a.label.includes("earpiece")),s=(i=this.store.getLocalPeer())==null?void 0:i.audioTrack;s&&r&&(yield s.setSettings({deviceId:r==null?void 0:r.deviceId}),yield s.setSettings({deviceId:"default"}))}});this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){return d(this,null,function*(){yield this.store.updateAudioOutputVolume(e),this.volume=e})}unblockAutoplay(){return d(this,null,function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()})}init(e){if(this.state.initialized||this.audioSink)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${Ts()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t,c.d(this.TAG,"audio sink created",this.audioSink)}cleanup(){var e;(e=this.audioSink)==null||e.remove(),this.audioSink=void 0,this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=m({},fr)}playAudioFor(e){return d(this,null,function*(){let t=e.getAudioElement();if(!t){c.w(this.TAG,"No audio element found on track",e.trackId);return}try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),c.d(this.TAG,"Played track",`${e}`)}catch(i){this.autoPausedTracks.add(e),c.w(this.TAG,"Failed to play track",`${e}`,i);let r=i;if(!this.state.autoplayFailed&&r.name==="NotAllowedError"){this.state.autoplayFailed=!0;let s=h.TracksErrors.AutoplayBlocked("AUTOPLAY","");s.addNativeError(r),this.eventBus.analytics.publish(P.autoplayError()),this.eventBus.autoplayError.publish(s)}}})}};var Je=class{constructor(e,t){this.store=e;this.eventBus=t;this.audioInput=[];this.audioOutput=[];this.videoInput=[];this.hasWebcamPermission=!1;this.hasMicrophonePermission=!1;this.TAG="[Device Manager]:";this.initialized=!1;this.videoInputChanged=!1;this.audioInputChanged=!1;this.updateOutputDevice=e=>d(this,null,function*(){let t=this.audioOutput.find(i=>i.deviceId===e);return t&&(this.outputDevice=t,yield this.store.updateAudioOutputDevice(t),D.updateSelection("audioOutput",{deviceId:t.deviceId,groupId:t.groupId})),t});this.getCurrentSelection=()=>{var a,o;let e=this.store.getLocalPeer(),t=this.createIdentifier((a=e==null?void 0:e.audioTrack)==null?void 0:a.getMediaTrackSettings()),i=this.createIdentifier((o=e==null?void 0:e.videoTrack)==null?void 0:o.getMediaTrackSettings()),r=this.audioInput.find(l=>this.createIdentifier(l)===t),s=this.videoInput.find(l=>this.createIdentifier(l)===i);return{audioInput:r,videoInput:s,audioOutput:this.outputDevice}};this.computeChange=(e,t)=>e.length!==t.length?!0:t.some(i=>!e.includes(this.createIdentifier(i)));this.enumerateDevices=()=>d(this,null,function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),i=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach(r=>{r.kind==="audioinput"&&r.label?(this.hasMicrophonePermission=!0,this.audioInput.push(r)):r.kind==="audiooutput"?this.audioOutput.push(r):r.kind==="videoinput"&&r.label&&(this.hasWebcamPermission=!0,this.videoInput.push(r))}),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(i,this.audioInput),D.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){c.e(this.TAG,"Failed enumerating devices",e)}});this.handleDeviceChange=ft(()=>d(this,null,function*(){yield this.enumerateDevices(),this.logDevices("After Device Change");let e=this.store.getLocalPeer(),t=e==null?void 0:e.audioTrack;yield this.setOutputDevice(!0),t&&(yield this.handleAudioInputDeviceChange(e==null?void 0:e.audioTrack)),yield this.handleVideoInputDeviceChange(e==null?void 0:e.videoTrack),this.eventBus.analytics.publish(P.deviceChange({selection:this.getCurrentSelection(),type:"change",devices:this.getDevices()}))}),500).bind(this);this.handleAudioInputDeviceChange=e=>d(this,null,function*(){if(!e){c.d(this.TAG,"No Audio track on local peer");return}if(!this.audioInputChanged){c.d(this.TAG,"No Change in AudioInput Device");return}let t=this.getNewAudioInputDevice();if(!t||!t.deviceId){this.eventBus.analytics.publish(P.deviceChange({selection:{audioInput:t},error:h.TracksErrors.SelectedDeviceMissing("audio"),devices:this.getDevices(),type:"audioInput"})),c.e(this.TAG,"Audio device not found");return}let{settings:i}=e,r=new x().codec(i.codec).maxBitrate(i.maxBitrate).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(s){c.e(this.TAG,"[Audio Device Change]",s),this.eventBus.analytics.publish(P.deviceChange({selection:{audioInput:t},devices:this.getDevices(),type:"audioInput",error:s})),this.eventBus.deviceChange.publish({error:s,selection:t,type:"audioInput",devices:this.getDevices()})}});this.handleVideoInputDeviceChange=e=>d(this,null,function*(){if(!e){c.d(this.TAG,"No video track on local peer");return}if(!this.videoInputChanged){c.d(this.TAG,"No Change in VideoInput Device");return}let t=this.videoInput[0];if(!t||!t.deviceId){this.eventBus.analytics.publish(P.deviceChange({selection:{videoInput:t},error:h.TracksErrors.SelectedDeviceMissing("video"),devices:this.getDevices(),type:"video"})),c.e(this.TAG,"Video device not found");return}let{settings:i}=e,r=new O().codec(i.codec).maxBitrate(i.maxBitrate).maxFramerate(i.maxFramerate).setWidth(i.width).setHeight(i.height).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(s){c.e(this.TAG,"[Video Device Change]",s),this.eventBus.analytics.publish(P.deviceChange({selection:{videoInput:t},devices:this.getDevices(),type:"video",error:s})),this.eventBus.deviceChange.publish({error:s,type:"video",selection:t,devices:this.getDevices()})}});let i=({enabled:r,track:s})=>r&&s.source==="regular";this.eventBus.localVideoEnabled.waitFor(i).then(()=>d(this,null,function*(){yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})),this.eventBus.localAudioEnabled.waitFor(i).then(()=>d(this,null,function*(){yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})}))}init(e=!1){return d(this,null,function*(){this.initialized&&!e||(!this.initialized&&navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),this.logDevices("Init"),yield this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),this.eventBus.analytics.publish(P.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))})}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanup(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){let e=this.store.getLocalPeer(),t=e==null?void 0:e.audioTrack,i=this.audioInput.find(s=>s.deviceId===(t==null?void 0:t.getManuallySelectedDeviceId()));if(i)return i;t==null||t.resetManuallySelectedDeviceId();let r=this.audioInput.find(s=>s.deviceId==="default");return r?this.audioInput.find(a=>a.deviceId!=="default"&&r.label.includes(a.label)):this.audioInput[0]}setOutputDevice(e=!1){return d(this,null,function*(){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=this.getAudioOutputDeviceMatchingInput(t),this.outputDevice||(this.outputDevice=this.audioOutput.find(r=>this.createIdentifier(r)===i),this.outputDevice||(this.outputDevice=this.audioOutput.find(r=>r.deviceId==="default")||this.audioOutput[0])),yield this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&(this.eventBus.analytics.publish(P.deviceChange({selection:{audioOutput:this.outputDevice},devices:this.getDevices(),type:"audioOutput"})),this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()}))})}getAudioOutputDeviceMatchingInput(e){var a,o;let t=((o=(a=this.store.getConfig())==null?void 0:a.settings)==null?void 0:o.speakerAutoSelectionBlacklist)||[];if(t==="all"||!e)return;let i=e.label.toLowerCase()||"";if(t.some(l=>i.includes(l.toLowerCase())))return;let r=this.audioOutput.find(l=>e.deviceId!=="default"&&l.label===e.label);if(r)return r;let s=this.audioOutput.find(l=>l.groupId===e.groupId);if(s&&this.audioOutput[0].deviceId==="default"&&s.groupId===this.audioOutput[0].groupId)return s}logDevices(e=""){c.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}};var It=class{constructor(e,t){this.deviceManager=e;this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e)}unblockAutoplay(){return d(this,null,function*(){yield this.audioSinkManager.unblockAutoplay(),yield ie.resumeContext()})}};import{EventEmitter2 as vs}from"eventemitter2";var R=class{constructor(e,t){this.eventName=e;this.eventEmitter=t;this.publish=e=>{this.eventEmitter.emit(this.eventName,e)};this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)};this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)};this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)};this.waitFor=e=>this.eventEmitter.waitFor(this.eventName,{filter:e});this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}};var Rt=class{constructor(){this.eventEmitter=new vs;this.deviceChange=new R(C.DEVICE_CHANGE,this.eventEmitter);this.localAudioEnabled=new R(C.LOCAL_AUDIO_ENABLED,this.eventEmitter);this.localVideoEnabled=new R(C.LOCAL_VIDEO_ENABLED,this.eventEmitter);this.statsUpdate=new R(C.STATS_UPDATE,this.eventEmitter);this.trackDegraded=new R(C.TRACK_DEGRADED,this.eventEmitter);this.trackRestored=new R(C.TRACK_RESTORED,this.eventEmitter);this.trackAudioLevelUpdate=new R(C.TRACK_AUDIO_LEVEL_UPDATE,this.eventEmitter);this.audioPluginFailed=new R(C.AUDIO_PLUGIN_FAILED,this.eventEmitter);this.localAudioSilence=new R(C.LOCAL_AUDIO_SILENCE,this.eventEmitter);this.analytics=new R(C.ANALYTICS,this.eventEmitter);this.policyChange=new R(C.POLICY_CHANGE,this.eventEmitter);this.localRoleUpdate=new R(C.LOCAL_ROLE_UPDATE,this.eventEmitter);this.audioTrackUpdate=new R(C.AUDIO_TRACK_UPDATE,this.eventEmitter);this.audioTrackAdded=new R(C.AUDIO_TRACK_ADDED,this.eventEmitter);this.audioTrackRemoved=new R(C.AUDIO_TRACK_REMOVED,this.eventEmitter);this.autoplayError=new R(C.AUTOPLAY_ERROR,this.eventEmitter);this.leave=new R(C.LEAVE,this.eventEmitter)}};var ze=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof te?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}};var Ct=class{constructor(e,t,i){this.store=e;this.listener=t;this.audioListener=i}handleActiveSpeakers(e){var s,a,o;let t=e["speaker-list"],i=t.map(l=>({audioLevel:l.level,peer:this.store.getPeerById(l.peer_id),track:this.store.getTrackById(l.track_id)}));(s=this.audioListener)==null||s.onAudioLevelUpdate(i),this.store.updateSpeakers(i);let r=t[0];if(r){let l=this.store.getPeerById(r.peer_id);(a=this.listener)==null||a.onPeerUpdate(4,l)}else(o=this.listener)==null||o.onPeerUpdate(5,null)}};var Lt=class{constructor(e,t){this.store=e;this.listener=t;this.TAG="[BroadcastManager]"}handleNotification(e,t){e==="on-broadcast"&&this.handleBroadcast(t)}handleBroadcast(e){var p;let t=e.peer,i=e.info,r=e.roles,s=this.getSender(t),a=e.private?this.store.getLocalPeer():void 0,o=[];if(r!=null&&r.length){let u=this.store.getKnownRoles();for(let g of r)u[g]&&o.push(u[g])}let l=new ce(y(m({},i),{sender:s,recipientRoles:o,recipientPeer:a,time:new Date(e.timestamp),id:e.message_id}));c.d(this.TAG,`Received Message from sender=${t==null?void 0:t.peer_id}: ${l}`),(p=this.listener)==null||p.onMessageReceived(l)}getSender(e){let t=e?this.store.getPeerById(e.peer_id):void 0;return!t&&e&&(t=B(e,this.store)),t}};var wt=class{constructor(e,t){this.store=e;this.listener=t}handleQualityUpdate(e){var r;let i=e.peers.map(s=>{let a=this.store.getPeerById(s.peer_id);return a&&a.updateNetworkQuality(s.downlink_score),{peerID:s.peer_id,downlinkQuality:s.downlink_score}});(r=this.listener)==null||r.onConnectionQualityUpdate(i)}};var Re=class{constructor(e,t,i){this.store=e;this.eventBus=t;this.listener=i;this.TAG="[TrackManager]";this.tracksToProcess=new Map;this.handleTrackAdd=e=>{c.d(this.TAG,"ONTRACKADD",`${e}`),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()};this.handleTrackRemovedPermanently=e=>{c.d(this.TAG,"ONTRACKREMOVE",e),Object.keys(e.tracks).forEach(i=>{var o;let r=this.store.getTrackState(i);if(!r)return;let s=this.store.getTrackById(i);if(!s){c.d(this.TAG,"Track not found in store");return}s.type==="audio"&&this.eventBus.audioTrackRemoved.publish(s),this.store.removeTrack(s);let a=this.store.getPeerById(r.peerId);a&&(this.removePeerTracks(a,s),(o=this.listener)==null||o.onTrackUpdate(1,s,a))})};this.handleTrackLayerUpdate=e=>{for(let t in e.tracks){let i=e.tracks[t],r=this.store.getTrackById(t);!r||!this.store.getPeerByTrackId(t)||r instanceof w&&this.setLayer(r,i)}};this.handleTrackUpdate=(e,t=!0)=>{var s,a;let i=this.store.getPeerById(e.peer.peer_id),r=e.peer;if(!i&&!r){c.d(this.TAG,"Track Update ignored - Peer not added to store");return}i||(i=B(r,this.store),this.store.addPeer(i));for(let o in e.tracks){let l=Object.assign({},(s=this.store.getTrackState(o))==null?void 0:s.trackInfo),p=e.tracks[o],u=this.store.getTrackById(o);if(this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:m(m({},l),p)}),!u||this.tracksToProcess.has(o))this.processTrackInfo(p,e.peer.peer_id,t),this.processPendingTracks();else{u.setEnabled(!p.mute);let g=this.processTrackUpdate(u,l,p);g&&((a=this.listener)==null||a.onTrackUpdate(g,u,i))}}};this.processTrackInfo=(e,t,i)=>{};this.processPendingTracks=()=>{new Map(this.tracksToProcess).forEach(t=>{var s;let i=this.store.getTrackState(t.trackId);if(!i){c.d(this.TAG,"TrackState not added to store",`peerId - ${t.peerId}`,`trackId -${t.trackId}`);return}let r=this.store.getPeerById(i.peerId);if(!r){c.d(this.TAG,"Peer not added to store, peerId",i.peerId);return}t.source=i.trackInfo.source,t.peerId=r.peerId,t.logIdentifier=r.name,t.setEnabled(!i.trackInfo.mute),this.addAudioTrack(r,t),this.addVideoTrack(r,t),t.type==="audio"?this.eventBus.audioTrackAdded.publish({track:t,peer:r}):(s=this.listener)==null||s.onTrackUpdate(0,t,r),this.tracksToProcess.delete(t.trackId)})}}handleTrackMetadataAdd(e){c.d(this.TAG,"TRACK_METADATA_ADD",JSON.stringify(e,null,2));for(let t in e.tracks){let i=e.tracks[t];this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:i})}this.processPendingTracks()}handleTrackRemove(e,t=!0){var s;c.d(this.TAG,"ONTRACKREMOVE",`${e}`);let i=this.store.getTrackState(e.trackId);if(!i)return;if(!this.store.hasTrack(e)){c.d(this.TAG,"Track not found in store");return}if(t){this.store.removeTrack(e);let a=this.store.getPeerById(i.peerId);if(!a)return;this.removePeerTracks(a,e),(s=this.listener)==null||s.onTrackUpdate(1,e,a),e.type==="audio"&&this.eventBus.audioTrackRemoved.publish(e)}}setLayer(e,t){var s,a;let i=this.store.getPeerByTrackId(e.trackId);if(!i)return;e.setLayerFromServer(t)?(s=this.listener)==null||s.onTrackUpdate(5,e,i):(a=this.listener)==null||a.onTrackUpdate(6,e,i)}removePeerTracks(e,t){let i=e.auxiliaryTracks.indexOf(t);i>-1?(e.auxiliaryTracks.splice(i,1),c.d(this.TAG,"auxiliary track removed",`${t}`)):t.type==="audio"&&e.audioTrack===t?(e.audioTrack=void 0,c.d(this.TAG,"audio track removed",`${t}`)):t.type==="video"&&e.videoTrack===t&&(e.videoTrack=void 0,c.d(this.TAG,"video track removed",`${t}`))}addAudioTrack(e,t){var i;t.type==="audio"&&(t.source==="regular"&&(!e.audioTrack||((i=e.audioTrack)==null?void 0:i.trackId)===t.trackId)?e.audioTrack=t:e.auxiliaryTracks.push(t),this.store.addTrack(t),c.d(this.TAG,"audio track added",`${t}`))}addVideoTrack(e,t){if(t.type!=="video")return;let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);if(i.setSimulcastDefinitons(r),this.addAsPrimaryVideoTrack(e,i))e.videoTrack?e.videoTrack.replaceTrack(i):e.videoTrack=i,this.store.addTrack(e.videoTrack);else{let s=e.auxiliaryTracks.findIndex(a=>a.trackId===i.trackId);s===-1?(e.auxiliaryTracks.push(i),this.store.addTrack(i)):(e.auxiliaryTracks[s].replaceTrack(i),this.store.addTrack(e.auxiliaryTracks[s]))}c.d(this.TAG,"video track added",`${t}`)}addAsPrimaryVideoTrack(e,t){var i;return t.source==="regular"&&(!e.videoTrack||((i=e.videoTrack)==null?void 0:i.trackId)===t.trackId)}processTrackUpdate(e,t,i){let r;return t.mute!==i.mute?(r=i.mute?2:3,e.type==="audio"&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(r=4),r}};var _t=class extends Re{constructor(t,i,r,s){super(t,i,s);this.transport=r;this.TAG="[OnDemandTrackManager]";this.processTrackInfo=(t,i,r=!0)=>{var p;if(t.type!=="video")return;let s=this.store.getPeerById(i);if(!s||!this.isPeerRoleSubscribed(i)){c.d(this.TAG,`no peer in store for peerId: ${i}`);return}let a=new J(new MediaStream,this.transport.getSubscribeConnection()),o=Y.getEmptyVideoTrack();o.enabled=!t.mute;let l=new w(a,o,t.source);l.setTrackId(t.track_id),l.peerId=s.peerId,l.logIdentifier=s.name,this.addVideoTrack(s,l),r&&((p=this.listener)==null||p.onTrackUpdate(0,s.videoTrack,s))}}handleTrackMetadataAdd(t){super.handleTrackMetadataAdd(t);for(let i in t.tracks)t.tracks[i].type==="video"&&this.processTrackInfo(t.tracks[i],t.peer.peer_id)}handleTrackRemove(t){let i=t.type==="video"&&t.source==="regular";super.handleTrackRemove(t,!i),i&&this.processTrackInfo({track_id:t.trackId,mute:!t.enabled,type:t.type,source:t.source,stream_id:t.stream.id},t.peerId,!1)}addAsPrimaryVideoTrack(t,i){return i.source!=="regular"?!1:!t.videoTrack||t.videoTrack.trackId===i.trackId?!0:t.videoTrack.enabled&&$(t.videoTrack.nativeTrack)}isPeerRoleSubscribed(t){var s,a,o,l;if(!t)return!0;let i=this.store.getLocalPeer(),r=this.store.getPeerById(t);return r&&((l=(a=(s=i==null?void 0:i.role)==null?void 0:s.subscribeParams)==null?void 0:a.subscribeToRoles)==null?void 0:l.includes((o=r.role)==null?void 0:o.name))}};var Ht=class{constructor(e,t,i,r){this.store=e;this.peerManager=t;this.trackManager=i;this.listener=r;this.TAG="[PeerListManager]";this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)};this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)};this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers;if(t==null){e.peer_count===0&&this.handleRepeatedPeerList({});return}Object.keys(t).forEach(i=>{t[i].tracks={},t[i].is_from_room_state=!0}),this.handleRepeatedPeerList(t)};this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),i=Object.values(e),r=t.filter(a=>!e[a.peerId]);r.length>0&&c.d(this.TAG,`${r}`),r.forEach(a=>{var l;let o={peer_id:a.peerId,role:((l=a.role)==null?void 0:l.name)||"",info:{name:a.name,data:a.metadata||"",user_id:a.customerUserId||""},tracks:{},groups:[],realtime:a.realtime};this.peerManager.handlePeerLeave(o)});let s=[];i.forEach(a=>{let o=this.store.getPeerById(a.peer_id),l=Object.values(a.tracks);o&&(this.store.getPeerTracks(o.peerId).forEach(u=>{var g;a.tracks[u.trackId]||(this.removePeerTrack(o,u.trackId),(g=this.listener)==null||g.onTrackUpdate(1,u,o))}),l.forEach(u=>{this.store.getTrackById(u.track_id)||this.store.setTrackState({peerId:o.peerId,trackInfo:u})}),this.trackManager.handleTrackUpdate({peer:a,tracks:a.tracks},!1),this.peerManager.handlePeerUpdate(a)),s.push(a)}),s.length>0&&this.peerManager.handlePeerList(s)}}handleNotification(e,t,i){if(e==="peer-list"){let r=t;i?(c.d(this.TAG,"RECONNECT_PEER_LIST event",JSON.stringify(r,null,2)),this.handleReconnectPeerList(r)):(c.d(this.TAG,"PEER_LIST event",JSON.stringify(r,null,2)),this.handleInitialPeerList(r))}else if(e==="room-state"){let r=t;this.handlePreviewRoomState(r)}}removePeerTrack(e,t){var i,r;if(c.d(this.TAG,`removing track - ${t} from ${e}`),((i=e.audioTrack)==null?void 0:i.trackId)===t)e.audioTrack=void 0;else if(((r=e.videoTrack)==null?void 0:r.trackId)===t)e.videoTrack=void 0;else{let s=e.auxiliaryTracks.findIndex(a=>a.trackId===t);s>=0&&e.auxiliaryTracks.splice(s,1)}}};var b=n=>n?new Date(n):void 0;var Dt=class{constructor(e,t,i){this.store=e;this.trackManager=t;this.listener=i;this.TAG="[PeerManager]";this.handlePeerList=e=>{var r,s;if(e.length===0){(r=this.listener)==null||r.onPeerUpdate(9,[]);return}let t=[],i=new Set(e.map(a=>a.peer_id));this.store.getRemotePeers().forEach(({peerId:a,fromRoomState:o})=>{!i.has(a)&&o&&this.store.removePeer(a)});for(let a of e)t.push(this.makePeer(a));(s=this.listener)==null||s.onPeerUpdate(9,t),this.trackManager.processPendingTracks()};this.handlePeerJoin=e=>{var i;let t=this.makePeer(e);(i=this.listener)==null||i.onPeerUpdate(0,t),this.trackManager.processPendingTracks()};this.handlePeerLeave=e=>{var i,r,s,a;let t=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),c.d(this.TAG,"PEER_LEAVE",e.peer_id,`remainingPeers=${this.store.getPeers().length}`),t&&(t.audioTrack&&((i=this.listener)==null||i.onTrackUpdate(1,t.audioTrack,t)),t.videoTrack&&((r=this.listener)==null||r.onTrackUpdate(1,t.videoTrack,t)),(s=t.auxiliaryTracks)==null||s.forEach(o=>{var l;(l=this.listener)==null||l.onTrackUpdate(1,o,t)}),(a=this.listener)==null||a.onPeerUpdate(1,t))}}handleNotification(e,t){switch(e){case"on-peer-join":{let i=t;this.handlePeerJoin(i);break}case"on-peer-leave":{let i=t;this.handlePeerLeave(i);break}case"on-peer-update":this.handlePeerUpdate(t);break;default:break}}handlePeerUpdate(e){var s,a,o,l,p;let t=this.store.getPeerById(e.peer_id);if(!t&&e.realtime){t=this.makePeer(e),(s=this.listener)==null||s.onPeerUpdate(t.isHandRaised?12:14,t);return}if(t&&!t.isLocal&&!e.realtime){this.store.removePeer(t.peerId),(a=this.listener)==null||a.onPeerUpdate(13,t);return}if(!t){c.d(this.TAG,`peer ${e.peer_id} not found`);return}if(t.role&&t.role.name!==e.role){let u=this.store.getPolicyForRole(e.role);t.updateRole(u),this.updateSimulcastLayersForPeer(t),(o=this.listener)==null||o.onPeerUpdate(8,t)}let i=t.isHandRaised;t.updateGroups(e.groups);let r=(l=e.groups)==null?void 0:l.includes(Q);i!==r&&((p=this.listener)==null||p.onPeerUpdate(12,t)),this.handlePeerInfoUpdate(m({peer:t},e.info))}handlePeerInfoUpdate({peer:e,name:t,data:i}){var r,s;e&&(t&&e.name!==t&&(e.updateName(t),(r=this.listener)==null||r.onPeerUpdate(10,e)),i&&e.metadata!==i&&(e.updateMetadata(i),(s=this.listener)==null||s.onPeerUpdate(11,e)))}makePeer(e){let t=this.store.getPeerById(e.peer_id);t||(t=B(e,this.store),t.realtime=e.realtime,t.joinedAt=b(e.joined_at),t.fromRoomState=!!e.is_from_room_state,this.store.addPeer(t),c.d(this.TAG,"adding to the peerList",`${t}`));for(let i in e.tracks){let r=e.tracks[i];this.store.setTrackState({peerId:e.peer_id,trackInfo:r}),r.type==="video"&&this.trackManager.processTrackInfo(r,e.peer_id,!1)}return t}updateSimulcastLayersForPeer(e){this.store.getPeerTracks(e.peerId).forEach(t=>{if(t.type==="video"&&["regular","screen"].includes(t.source)){let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);i.setSimulcastDefinitons(r)}})}};var Ot=class{constructor(e,t){this.store=e;this.eventBus=t}handlePolicyChange(e){let t=this.store.getLocalPeer();if(t&&!t.role){let r=e.known_roles[e.name];t.updateRole(r)}this.store.setKnownRoles(e);let i=this.store.getRoom();i?i.templateId=e.template_id:c.w("[PolicyChangeManager]","on policy change - room not present"),this.updateLocalPeerRole(e),this.eventBus.policyChange.publish(e)}updateLocalPeerRole(e){var i;let t=this.store.getLocalPeer();if(t!=null&&t.role&&t.role.name!==e.name){let r=this.store.getPolicyForRole(e.name),s=t.role;t.updateRole(r),r.name===((i=t.asRole)==null?void 0:i.name)&&delete t.asRole,this.eventBus.localRoleUpdate.publish({oldRole:s,newRole:r})}}};var Nt=class{constructor(e,t,i){this.transport=e;this.store=t;this.listener=i;this.TAG="[HMSWhiteboardInteractivityCenter]"}get isEnabled(){return this.transport.isFlagEnabled("whiteboardEnabled")}open(e){return d(this,null,function*(){var a;if(!this.isEnabled)return c.w(this.TAG,"Whiteboard is not enabled for customer");let t=this.store.getWhiteboard(e==null?void 0:e.id),i=t==null?void 0:t.id;if(t||(i=(yield this.transport.createWhiteboard(this.getCreateOptionsWithDefaults(e))).id),!i)throw new Error(`Whiteboard ID: ${i} not found`);let r=yield this.transport.getWhiteboard({id:i}),s=y(m({},t),{title:e==null?void 0:e.title,attributes:e==null?void 0:e.attributes,id:r.id,token:r.token,addr:r.addr,owner:r.owner,permissions:r.permissions||[],open:!0});this.store.setWhiteboard(s),(a=this.listener)==null||a.onWhiteboardUpdate(s)})}close(e){return d(this,null,function*(){var r;if(!this.isEnabled)return c.w(this.TAG,"Whiteboard is not enabled for customer");let t=this.store.getWhiteboard(e);if(!t)throw new Error(`Whiteboard ID: ${e} not found`);let i={id:t.id,title:t.title,open:!1};this.store.setWhiteboard(i),(r=this.listener)==null||r.onWhiteboardUpdate(i)})}setListener(e){this.listener=e}getCreateOptionsWithDefaults(e){var a;let t=Object.values(this.store.getKnownRoles()),i=[],r=[],s=[];return t.forEach(o=>{var l,p,u;(l=o.permissions.whiteboard)!=null&&l.includes("read")&&i.push(o.name),(p=o.permissions.whiteboard)!=null&&p.includes("write")&&r.push(o.name),(u=o.permissions.whiteboard)!=null&&u.includes("admin")&&s.push(o.name)}),{title:(e==null?void 0:e.title)||`${(a=this.store.getRoom())==null?void 0:a.id} Whiteboard`,reader:(e==null?void 0:e.reader)||i,writer:(e==null?void 0:e.writer)||r,admin:(e==null?void 0:e.admin)||s}}};var Ye=class{constructor(e,t,i){this.transport=e;this.store=t;this.listener=i;this.whiteboard=new Nt(e,t,i)}setListener(e){this.listener=e,this.whiteboard.setListener(e)}createPoll(e){return d(this,null,function*(){var a,o;let t={customerID:"userid",peerID:"peerid",userName:"username"},{poll_id:i}=yield this.transport.setPollInfo(y(m({},e),{mode:e.mode?t[e.mode]:void 0,poll_id:e.id,vote:e.rolesThatCanVote,responses:e.rolesThatCanViewResponses}));e.id||(e.id=i),Array.isArray(e.questions)&&(yield this.addQuestionsToPoll(e.id,e.questions));let r=yield this.transport.getPollQuestions({poll_id:e.id,index:0,count:50}),s=xt(y(m({},e),{poll_id:e.id,state:"created",created_by:(a=this.store.getLocalPeer())==null?void 0:a.peerId}));s.questions=r.questions.map(({question:l,options:p,answer:u})=>y(m({},l),{options:p,answer:u})),(o=this.listener)==null||o.onPollsUpdate(0,[s])})}startPoll(e){return d(this,null,function*(){typeof e=="string"?yield this.transport.startPoll({poll_id:e}):(yield this.createPoll(e),yield this.transport.startPoll({poll_id:e.id}))})}addQuestionsToPoll(e,t){return d(this,null,function*(){t.length>0&&(yield this.transport.setPollQuestions({poll_id:e,questions:t.map((i,r)=>this.createQuestionSetParams(i,r))}))})}stopPoll(e){return d(this,null,function*(){yield this.transport.stopPoll({poll_id:e})})}addResponsesToPoll(e,t){return d(this,null,function*(){let i=this.store.getPoll(e);if(!i)throw new Error("Invalid poll ID - Poll not found");let r=t.map(s=>{var o,l;let a=this.getQuestionInPoll(i,s.questionIndex);return a.type==="single-choice"?(s.option=s.option||((o=s.options)==null?void 0:o[0])||-1,delete s.text,delete s.options):a.type==="multiple-choice"?((l=s.options)==null||l.sort(),delete s.text,delete s.option):(delete s.option,delete s.options),s.skipped&&(delete s.option,delete s.options,delete s.text),m({duration:0,type:a.type,question:s.questionIndex},s)});yield this.transport.setPollResponses({poll_id:e,responses:r})})}getPolls(){return d(this,null,function*(){let e=yield this.transport.getPollsList({count:50}),t=[];for(let i of e.polls){let r=yield this.transport.getPollQuestions({poll_id:i.poll_id,index:0,count:50}),s=xt(i);s.questions=r.questions.map(({question:a,options:o,answer:l})=>y(m({},a),{options:o,answer:l})),t.push(s),this.store.setPoll(s)}return t})}getResponses(e){throw new Error("Method not implemented.")}createQuestionSetParams(e,t){var a;let i=y(m({},e),{index:t+1}),r,s=e.answer||{hidden:!1};return Array.isArray(e.options)&&["single-choice","multiple-choice"].includes(e.type)?(r=(a=e.options)==null?void 0:a.map((o,l)=>({index:l+1,text:o.text,weight:o.weight})),s==null||delete s.text,e.type==="single-choice"?s.option=e.options.findIndex(o=>o.isCorrectAnswer)+1||void 0:s.options=e.options.map((o,l)=>o.isCorrectAnswer?l+1:void 0).filter(o=>!!o)):(s==null||delete s.options,s==null||delete s.option),{question:i,options:r,answer:s}}getQuestionInPoll(e,t){var r;let i=(r=e==null?void 0:e.questions)==null?void 0:r.find(s=>s.index===t);if(!i)throw new Error("Invalid question index - Question not found in poll");return i}fetchLeaderboard(e,t,i){return d(this,null,function*(){var l,p;let r=((p=(l=this.store.getLocalPeer())==null?void 0:l.role)==null?void 0:p.permissions.pollRead)||!1;if(e.anonymous||e.state!=="stopped"||!r)return{entries:[],hasNext:!1};let s=yield this.transport.fetchLeaderboard({poll_id:e.id,count:i,offset:t}),a={avgScore:s.avg_score,avgTime:s.avg_time,votedUsers:s.voted_users,totalUsers:s.total_users,correctAnswers:s.correct_users};return{entries:s.questions.map(u=>({position:u.position,totalResponses:u.total_responses,correctResponses:u.correct_responses,duration:u.duration,peer:u.peer,score:u.score})),hasNext:!s.last,summary:a}})}},xt=n=>{let e={userid:"customerID",peerid:"peerID",username:"userName"};return{id:n.poll_id,title:n.title,startedBy:n.started_by,createdBy:n.created_by,anonymous:n.anonymous,type:n.type,duration:n.duration,locked:n.locked,mode:n.mode?e[n.mode]:void 0,visibility:n.visibility,rolesThatCanVote:n.vote||[],rolesThatCanViewResponses:n.responses||[],state:n.state,stoppedBy:n.stopped_by,startedAt:b(n.started_at),stoppedAt:b(n.stopped_at),createdAt:b(n.created_at)}};var Ft=class{constructor(e,t,i){this.store=e;this.transport=t;this.listener=i}handleNotification(e,t){switch(e){case"on-poll-start":{this.handlePollStart(t);break}case"on-poll-stop":{this.handlePollStop(t);break}case"on-poll-stats":this.handlePollStats(t);break;default:break}}handlePollStart(e){return d(this,null,function*(){var i;let t=[];for(let r of e.polls){if(this.store.getPoll(r.poll_id))return;let s=yield this.transport.getPollQuestions({poll_id:r.poll_id,index:0,count:50}),a=xt(r);a.questions=s.questions.map(({question:o,options:l,answer:p})=>y(m({},o),{options:l,answer:p})),yield this.updatePollResponses(a,!0),t.push(a),this.store.setPoll(a)}(i=this.listener)==null||i.onPollsUpdate(1,t)})}handlePollStop(e){return d(this,null,function*(){var i;let t=[];for(let r of e.polls){let s=this.store.getPoll(r.poll_id);if(s){s.state="stopped",s.stoppedAt=b(r.stopped_at),s.stoppedBy=r.stopped_by;let a=yield this.transport.getPollResult({poll_id:r.poll_id});this.updatePollResult(s,a),t.push(s)}}t.length>0&&((i=this.listener)==null||i.onPollsUpdate(2,t))})}handlePollStats(e){return d(this,null,function*(){var i;let t=[];for(let r of e.polls){let s=this.store.getPoll(r.poll_id);if(!s)return;this.updatePollResult(s,r),yield this.updatePollResponses(s,!1),t.push(s)}t.length>0&&((i=this.listener)==null||i.onPollsUpdate(3,t))})}updatePollResult(e,t){var i;e.result=m({},e.result),e.result.totalUsers=t.user_count,e.result.maxUsers=t.max_user,e.result.totalResponses=t.total_response,(i=t.questions)==null||i.forEach(r=>{var a,o;let s=(a=e.questions)==null?void 0:a.find(l=>l.index===r.question);s&&(s.result=m({},s.result),s.result.correctResponses=r.correct,s.result.skippedCount=r.skipped,s.result.totalResponses=r.total,(o=r.options)==null||o.forEach((l,p)=>{var g;let u=(g=s.options)==null?void 0:g[p];u&&u.voteCount!==l&&(u.voteCount=l)}))})}updatePollResponses(e,t){return d(this,null,function*(){var r;(r=(yield this.transport.getPollResponses({poll_id:e.id,index:0,count:50,self:t})).responses)==null||r.forEach(({response:s,peer:a,final:o})=>{var u;let l=(u=e==null?void 0:e.questions)==null?void 0:u.find(g=>g.index===s.question);if(!l)return;let p={id:s.response_id,questionIndex:s.question,option:s.option,options:s.options,text:s.text,responseFinal:o,peer:{peerid:a.peerid,userHash:a.hash,userid:a.userid,username:a.username},skipped:s.skipped,type:s.type,update:s.update};Array.isArray(l.responses)&&l.responses.length>0?l.responses.find(({id:g})=>g===p.id)||l.responses.push(p):l.responses=[p]})})}};var Gt=class{constructor(e,t){this.store=e;this.listener=t}handleNotification(e,t){switch(e){case"on-role-change-request":this.handleRoleChangeRequest(t);break;case"on-track-update-request":this.handleTrackUpdateRequest(t);break;case"on-change-track-mute-state-request":this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var i;let t={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};(i=this.listener)==null||i.onRoleChangeRequest(t)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:r}=e,s=t?this.store.getPeerById(t):void 0,a=this.store.getLocalPeerTracks().find(l=>l.publishedTrackId===i);if(!a)return;let o=()=>{var l;(l=this.listener)==null||l.onChangeTrackStateRequest({requestedBy:s,track:a,enabled:!r})};if(r){if(a.enabled===!r)return;a.setEnabled(!r).then(o)}else o()}handleChangeTrackStateRequest(e){var p;let{type:t,source:i,value:r,requested_by:s}=e,a=s?this.store.getPeerById(s):void 0,o=!r,l=this.getTracksToBeUpdated({type:t,source:i,enabled:o});if(l.length!==0)if(o)(p=this.listener)==null||p.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,type:t,source:i,enabled:!0});else{let u=[];for(let g of l)u.push(g.setEnabled(!1));Promise.all(u).then(()=>{var g;(g=this.listener)==null||g.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,enabled:!1})})}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let s=this.store.getLocalPeerTracks();return e&&(s=s.filter(a=>a.type===e)),t&&(s=s.filter(a=>a.source===t)),s.filter(a=>a.enabled!==i)}};var Ut=class{constructor(e,t){this.store=e;this.listener=t;this.TAG="[RoomUpdateManager]"}handleNotification(e,t){switch(e){case"peer-list":this.onRoomState(t.room);break;case"on-rtmp-update":this.updateRTMPStatus(t);break;case"on-record-update":this.updateRecordingStatus(t);break;case"room-state":this.handlePreviewRoomState(t);break;case"room-info":this.handleRoomInfo(t);break;case"session-info":this.handleSessionInfo(t);break;case"on-hls-update":this.updateHLSStatus(t);break;default:break}}handleRoomInfo(e){let t=this.store.getRoom();if(!t){c.w(this.TAG,"on session info - room not present");return}t.description=e.description,t.large_room_optimization=e.large_room_optimization,t.max_size=e.max_size,t.name=e.name}handleSessionInfo(e){var i;let t=this.store.getRoom();if(!t){c.w(this.TAG,"on session info - room not present");return}t.sessionId=e.session_id,t.peerCount!==e.peer_count&&(t.peerCount=e.peer_count,(i=this.listener)==null||i.onRoomUpdate("ROOM_PEER_COUNT_UPDATED",t))}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t)}onRoomState(e){var l,p,u,g;let{recording:t,streaming:i,session_id:r,started_at:s,name:a}=e,o=this.store.getRoom();if(!o){c.w(this.TAG,"on room state - room not present");return}o.name=a,o.rtmp.running=this.isStreamingRunning((l=i==null?void 0:i.rtmp)==null?void 0:l.state),o.rtmp.startedAt=b((p=i==null?void 0:i.rtmp)==null?void 0:p.started_at),o.rtmp.state=(u=i==null?void 0:i.rtmp)==null?void 0:u.state,o.recording.server=this.getPeerListSFURecording(t),o.recording.browser=this.getPeerListBrowserRecording(t),o.recording.hls=this.getPeerListHLSRecording(t),o.hls=this.convertHls(i==null?void 0:i.hls),o.sessionId=r,o.startedAt=b(s),(g=this.listener)==null||g.onRoomUpdate("RECORDING_STATE_UPDATED",o)}isRecordingRunning(e){return e?!["none","paused","stopped","failed"].includes(e):!1}isStreamingRunning(e){return e?!["none","stopped","failed"].includes(e):!1}initHLS(e){let t=this.store.getRoom(),i={running:!0,variants:[]};return t?(e!=null&&e.variants&&e.variants.forEach((r,s)=>{var a;i.variants.push({initialisedAt:b((a=e==null?void 0:e.variants)==null?void 0:a[s].initialised_at),url:""})}),i):(c.w(this.TAG,"on hls - room not present"),i)}updateHLSStatus(e){var r;let t=this.store.getRoom(),i=e.variants&&e.variants.length>0?this.isStreamingRunning(e.variants[0].state):!1;if(!t){c.w(this.TAG,"on hls - room not present");return}e.enabled=i,t.hls=this.convertHls(e),(r=this.listener)==null||r.onRoomUpdate("HLS_STREAMING_STATE_UPDATED",t)}convertHls(e){var r;if(e!=null&&e.variants&&e.variants.length>0?e.variants[0].state==="initialised":!1)return this.initHLS(e);let i={running:!!(e!=null&&e.enabled),variants:[],error:this.toSdkError(e==null?void 0:e.error)};return(r=e==null?void 0:e.variants)==null||r.forEach(s=>{i.variants.push({meetingURL:s==null?void 0:s.meeting_url,url:s==null?void 0:s.url,metadata:s==null?void 0:s.metadata,startedAt:b(s==null?void 0:s.started_at),initialisedAt:b(s==null?void 0:s.initialised_at),state:s.state})}),i}getHLSRecording(e){var r,s;let t={running:!1},i=this.isRecordingRunning(e==null?void 0:e.state);return(i||(e==null?void 0:e.state)==="paused")&&(t={running:i,singleFilePerLayer:!!((r=e==null?void 0:e.hls_recording)!=null&&r.single_file_per_layer),hlsVod:!!((s=e==null?void 0:e.hls_recording)!=null&&s.hls_vod),startedAt:b(e==null?void 0:e.started_at),initialisedAt:b(e==null?void 0:e.initialised_at),state:e==null?void 0:e.state,error:this.toSdkError(e==null?void 0:e.error)}),t}getPeerListHLSRecording(e){var r,s;let t=e==null?void 0:e.hls;return{running:this.isRecordingRunning(t==null?void 0:t.state),startedAt:b(t==null?void 0:t.started_at),initialisedAt:b(t==null?void 0:t.initialised_at),state:t==null?void 0:t.state,singleFilePerLayer:(r=t==null?void 0:t.config)==null?void 0:r.single_file_per_layer,hlsVod:(s=t==null?void 0:t.config)==null?void 0:s.hls_vod}}getPeerListBrowserRecording(e){let t=e==null?void 0:e.browser;return{running:this.isRecordingRunning(t==null?void 0:t.state),startedAt:b(t==null?void 0:t.started_at),state:t==null?void 0:t.state}}getPeerListSFURecording(e){let t=e==null?void 0:e.sfu;return{running:this.isRecordingRunning(t==null?void 0:t.state),startedAt:b(t==null?void 0:t.started_at),state:t==null?void 0:t.state}}updateRecordingStatus(e){var s;let t=this.store.getRoom(),i=this.isRecordingRunning(e.state);if(!t){c.w(this.TAG,`set recording status running=${i} - room not present`);return}let r;e.type==="sfu"?(t.recording.server={running:i,startedAt:i?b(e.started_at):void 0,error:this.toSdkError(e.error),state:e.state},r="SERVER_RECORDING_STATE_UPDATED"):e.type==="HLS"?(t.recording.hls=this.getHLSRecording(e),r="RECORDING_STATE_UPDATED"):(t.recording.browser={running:i,startedAt:i?b(e.started_at):void 0,error:this.toSdkError(e.error),state:e==null?void 0:e.state},r="BROWSER_RECORDING_STATE_UPDATED"),(s=this.listener)==null||s.onRoomUpdate(r,t)}updateRTMPStatus(e){var r,s;let t=this.store.getRoom(),i=this.isStreamingRunning(e.state);if(!t){c.w(this.TAG,"on policy change - room not present");return}if(!i){t.rtmp={running:i,state:e.state,error:this.toSdkError(e.error)},(r=this.listener)==null||r.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",t);return}t.rtmp={running:i,startedAt:i?b(e.started_at):void 0,state:e.state,error:this.toSdkError(e.error)},(s=this.listener)==null||s.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",t)}toSdkError(e){if(!(e!=null&&e.code))return;let t=e.message||"error in streaming/recording",i=new S(e.code,"ServerErrors","NONE",t,t);return c.e(this.TAG,"error in streaming/recording",i),i}};var Bt=class{constructor(e,t){this.store=e;this.listener=t}handleNotification(e,t){e==="on-metadata-change"&&this.handleMetadataChange(t)}handleMetadataChange(e){var i;let t=e.values.map(r=>({key:r.key,value:r.data,updatedAt:b(r.updated_at),updatedBy:r.updated_by?this.store.getPeerById(r.updated_by):void 0}));(i=this.listener)==null||i.onSessionStoreUpdate(t)}};var Vt=class{constructor(e,t,i){this.store=e;this.transport=t;this.listener=i}handleNotification(e,t){switch(e){case"on-whiteboard-update":{this.handleWhiteboardUpdate(t);break}default:break}}handleWhiteboardUpdate(e){return d(this,null,function*(){var o;let t=this.store.getLocalPeer(),i=this.store.getWhiteboard(e.id),r=e.owner===(t==null?void 0:t.peerId)||e.owner===(t==null?void 0:t.customerUserId),s=e.state==="open",a={id:e.id,title:e.title,attributes:e.attributes};if(a.open=r?i==null?void 0:i.open:s,a.owner=a.open?e.owner:void 0,!r&&a.open){let l=yield this.transport.getWhiteboard({id:e.id});a.token=l.token,a.addr=l.addr,a.permissions=l.permissions}this.store.setWhiteboard(a),(o=this.listener)==null||o.onWhiteboardUpdate(a)})}};var Wt=class{constructor(e,t,i,r,s,a){this.store=e;this.transport=i;this.listener=r;this.audioListener=s;this.connectionQualityListener=a;this.TAG="[HMSNotificationManager]";this.hasConsistentRoomStateArrived=!1;this.ignoreNotification=e=>{if(e==="peer-list")this.hasConsistentRoomStateArrived=!0;else if(e==="room-state")return this.hasConsistentRoomStateArrived;return!1};this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)};this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)};this.updateLocalPeer=({name:e,metadata:t})=>{let i=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:i,name:e,data:t})};let o=this.transport.isFlagEnabled("onDemandTracks");this.trackManager=o?new _t(this.store,t,this.transport,this.listener):new Re(this.store,t,this.listener),this.peerManager=new Dt(this.store,this.trackManager,this.listener),this.peerListManager=new Ht(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new Lt(this.store,this.listener),this.policyChangeManager=new Ot(this.store,t),this.requestManager=new Gt(this.store,this.listener),this.activeSpeakerManager=new Ct(this.store,this.listener,this.audioListener),this.connectionQualityManager=new wt(this.store,this.connectionQualityListener),this.roomUpdateManager=new Ut(this.store,this.listener),this.sessionMetadataManager=new Bt(this.store,this.listener),this.pollsManager=new Ft(this.store,this.transport,this.listener),this.whiteboardManager=new Vt(this.store,this.transport,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e,this.sessionMetadataManager.listener=e,this.pollsManager.listener=e,this.whiteboardManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var s,a;let i=e.method,r=e.params;["active-speakers","sfu-stats","on-connection-quality-update",void 0].includes(i)||c.d(this.TAG,`Received notification - ${i}`,{notification:r}),i==="sfu-stats"&&(s=window.HMS)!=null&&s.ON_SFU_STATS&&typeof((a=window.HMS)==null?void 0:a.ON_SFU_STATS)=="function"&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(i)&&(this.roomUpdateManager.handleNotification(i,r),this.peerManager.handleNotification(i,r),this.requestManager.handleNotification(i,r),this.peerListManager.handleNotification(i,r,t),this.broadcastManager.handleNotification(i,r),this.sessionMetadataManager.handleNotification(i,r),this.pollsManager.handleNotification(i,r),this.whiteboardManager.handleNotification(i,r),this.handleIsolatedMethods(i,r))}handleIsolatedMethods(e,t){switch(e){case"on-track-add":{this.trackManager.handleTrackMetadataAdd(t);break}case"on-track-update":{this.trackManager.handleTrackUpdate(t);break}case"on-track-remove":{if(!t.peer){c.d(this.TAG,`Ignoring sfu notification - ${e}`,{notification:t});return}this.trackManager.handleTrackRemovedPermanently(t);break}case"on-track-layer-update":{this.trackManager.handleTrackLayerUpdate(t);break}case"active-speakers":this.activeSpeakerManager.handleActiveSpeakers(t);break;case"on-connection-quality-update":this.connectionQualityManager.handleQualityUpdate(t);break;case"on-policy-change":this.policyChangeManager.handlePolicyChange(t);break;default:break}}};var Ce=class{constructor(e){this.TAG="[AudioContextManager]";this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){return d(this,null,function*(){this.audioContext.state==="suspended"&&(yield this.audioContext.resume(),c.d(this.TAG,"AudioContext is resumed"))})}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){this.audioContext.state!=="closed"&&this.audioContext.close().catch(e=>{c.d(this.TAG,"AudioContext close error",e.message)})}};import{EventEmitter2 as fs}from"eventemitter2";var oe=class extends fs{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}};var $t=class extends oe{constructor(){super(...arguments);this.audioElement=null;this.TAG="[PlaylistAudioManager]";this.seeked=!1}play(t){return d(this,null,function*(){return this.audioElement=this.getAudioElement(),new Promise((i,r)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=t,this.seeked=!1,this.audioElement.onerror=()=>{let s=`Error loading ${t}`;c.e(this.TAG,s),this.stop(),r(s)},this.audioElement.oncanplaythrough=()=>d(this,null,function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),i([this.track]));else{yield this.audioElement.play();let s=this.audioContextManager.getAudioTrack();this.track=s,i([s])}}catch(s){c.e(this.TAG,"Error playing audio",t,s.message),r(s)}}),this.audioElement.onseeked=()=>{this.seeked=!0}})})}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement||(this.audioElement=this.getAudioElement()),this.audioElement}stop(){var t,i,r;(t=this.audioElement)==null||t.pause(),(i=this.audioElement)==null||i.removeAttribute("src"),this.audioElement=null,(r=this.audioContextManager)==null||r.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let t=document.createElement("audio");return t.crossOrigin="anonymous",t.addEventListener("timeupdate",i=>this.emit("progress",i)),t.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new Ce(t),t}};var Kt=class extends oe{constructor(){super(...arguments);this.TAG="[PlaylistVideoManager]";this.videoElement=null;this.canvasContext=null;this.tracks=[];this.DEFAUL_FPS=24;this.seeked=!1;this.drawImage=()=>{var t,i,r;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&((r=this.canvasContext)==null||r.drawImage(this.videoElement,0,0,(t=this.canvas)==null?void 0:t.width,(i=this.canvas)==null?void 0:i.height),this.timer=setTimeout(()=>{this.drawImage()},1e3/this.DEFAUL_FPS))}}play(t){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise((i,r)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=t,this.seeked=!1,this.videoElement.onerror=()=>{let s=`Error loading ${t}`;c.e(this.TAG,s),this.stop(),r(s)},this.videoElement.oncanplaythrough=()=>d(this,null,function*(){var s,a,o;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,this.tracks.length===0){this.clearCanvasAndTracks();let l=this.canvas.captureStream();if(!l){c.e(this.TAG,"Browser does not support captureStream");return}this.videoElement.onplay=this.drawImage,yield this.audioContextManager.resumeContext(),yield this.videoElement.play();let p=this.audioContextManager.getAudioTrack();l.addTrack(p),l.getTracks().forEach(u=>{this.tracks.push(u)}),i(this.tracks)}else this.seeked?(this.seeked=!1,(o=this.canvasContext)==null||o.drawImage(this.videoElement,0,0,(s=this.canvas)==null?void 0:s.width,(a=this.canvas)==null?void 0:a.height)):(yield this.videoElement.play(),i(this.tracks))}catch(l){c.e(this.TAG,"Error playing video",t,l.message),r(l)}}),this.videoElement.onseeked=()=>{this.seeked=!0}})}getTracks(){return this.tracks.map(t=>t.id)}getElement(){return this.videoElement||(this.videoElement=this.getVideoElement()),this.videoElement}stop(){var t,i,r;(t=this.videoElement)==null||t.pause(),(i=this.videoElement)==null||i.removeAttribute("src"),this.videoElement=null,(r=this.audioContextManager)==null||r.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var t;this.tracks=[],(t=this.canvasContext)==null||t.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let t=document.createElement("video");return t.crossOrigin="anonymous",t.addEventListener("timeupdate",i=>this.emit("progress",i)),t.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new Ce(t),t}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}};var qt={audio:{list:[],currentIndex:-1,isAutoplayOn:!0},video:{list:[],currentIndex:-1,isAutoplayOn:!0}},Xe=class extends oe{constructor(t,i){super();this.sdk=t;this.eventBus=i;this.state={audio:m({},qt.audio),video:m({},qt.video)};this.TAG="[PlaylistManager]";this.handlePausePlaylist=r=>d(this,[r],function*({enabled:t,track:i}){var a;if(t)return;let s;i.source==="audioplaylist"&&(s="audio"),i.source==="videoplaylist"&&(s="video"),s&&((a=this.getElement(s))==null||a.pause())});this.addTrack=(t,i)=>d(this,null,function*(){yield this.sdk.addTrack(t,i),c.d(this.TAG,"Playlist track added",ee(t))});this.removeTrack=t=>d(this,null,function*(){yield this.sdk.removeTrack(t,!0),c.d(this.TAG,"Playlist track removed",t)});this.audioManager=new $t,this.videoManager=new Kt,this.addListeners()}getList(t="audio"){return this.state[t].list}setList(t){if(!t||t.length===0){c.w(this.TAG,"Please pass in a list of HMSPlaylistItem's");return}t.forEach(i=>{this.state[i.type].list.find(r=>r.id===i.id)||this.state[i.type].list.push(i)})}clearList(t){return d(this,null,function*(){this.isPlaying(t)&&(yield this.stop(t)),this.state[t].list=[]})}removeItem(t,i){return d(this,null,function*(){let{list:r,currentIndex:s}=this.state[i],a=r.findIndex(o=>t===o.id);return a>-1?(s===a&&this.isPlaying(i)&&(yield this.stop(i)),r.splice(a,1),!0):!1})}seek(t,i="audio"){let{currentIndex:r}=this.state[i];if(r===-1)throw h.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");let s=this.getElement(i);if(s){let a=Math.max(s.currentTime+t,0);s.currentTime=Math.min(a,s.duration)}}seekTo(t,i="audio"){let{currentIndex:r}=this.state[i];if(r===-1)throw h.PlaylistErrors.NoEntryToPlay("PLAYLIST","No item is currently playing");if(t<0)throw Error("value cannot be negative");let s=this.getElement(i);s&&(s.currentTime=Math.min(t,s.duration))}setVolume(t,i="audio"){if(t<0||t>100)throw Error("Please pass a valid number between 0-100");let r=this.getElement(i);r&&(r.volume=t*.01)}getVolume(t="audio"){let i=this.getElement(t);return i?Math.floor(i.volume*100):0}getCurrentTime(t="audio"){let i=this.getElement(t);return(i==null?void 0:i.currentTime)||0}getCurrentIndex(t="audio"){return this.state[t].currentIndex}getCurrentProgress(t="audio"){var o;let{list:i,currentIndex:r}=this.state[t],s=(o=i[r])==null?void 0:o.url,a=this.getElement(t);return!s||!a?0:Math.floor(100*(a.currentTime/a.duration))}getCurrentSelection(t="audio"){let{list:i,currentIndex:r}=this.state[t];if(r!==-1)return i[r]}isPlaying(t="audio"){let i=this.getElement(t);return!!i&&!i.paused}setIsAutoplayOn(t="audio",i){this.state[t].isAutoplayOn=i}getPlaybackRate(t="audio"){let i=this.getElement(t);return i?i.playbackRate:1}setPlaybackRate(t="audio",i){if(i<.25||i>2)throw Error("Please pass a value between 0.25 and 2.0");let r=this.getElement(t);r&&(r.playbackRate=i)}setEnabled(s,a){return d(this,arguments,function*(t,{id:i,type:r="audio"}){let l=this.state[r].list.findIndex(u=>u.id===i);if(!i||l===-1){c.w(this.TAG,"Pass a valid id");return}let p=this.state[r].list[l].url;t?yield this.play(p,r):yield this.pause(p,r),this.state[r].currentIndex=l,this.setDuration(r)})}playNext(){return d(this,arguments,function*(t="audio"){let{list:i,currentIndex:r}=this.state[t];if(r>=i.length-1)throw h.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached end of playlist");yield this.play(i[r+1].url,t),this.state[t].currentIndex=r+1,this.setDuration(t)})}playPrevious(){return d(this,arguments,function*(t="audio"){let{list:i,currentIndex:r}=this.state[t];if(r<=0)throw h.PlaylistErrors.NoEntryToPlay("PLAYLIST","Reached start of playlist");yield this.play(i[r-1].url,t),this.state[t].currentIndex=r-1,this.setDuration(t)})}stop(){return d(this,arguments,function*(t="audio"){var r;let i=t==="audio"?this.audioManager:this.videoManager;(r=i.getElement())==null||r.pause(),yield this.removeTracks(t),i.stop(),this.state[t].currentIndex=-1})}cleanup(){this.state={audio:m({},qt.audio),video:m({},qt.video)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(t){this.videoManager.on("progress",()=>{try{t({type:"video",progress:this.getCurrentProgress("video")})}catch(i){c.e(this.TAG,"Error in onProgress callback")}}),this.audioManager.on("progress",()=>{try{t({type:"audio",progress:this.getCurrentProgress("audio")})}catch(i){c.e(this.TAG,"Error in onProgress callback")}})}onNewTrackStart(t){this.on("newTrackStart",t)}onPlaylistEnded(t){this.on("playlistEnded",t)}onCurrentTrackEnded(t){this.on("currentTrackEnded",t)}getElement(t="audio"){return t==="audio"?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return d(this,arguments,function*(t="audio"){let r=(t==="audio"?this.audioManager:this.videoManager).getTracks();for(let s of r)yield this.removeTrack(s)})}play(r){return d(this,arguments,function*(t,i="audio"){let s=i==="audio"?this.audioManager:this.videoManager,a=s.getElement();if(this.isItemCurrentlyPlaying(t,i)){c.w(this.TAG,`The ${i} is currently playing`);return}if(a!=null&&a.src.includes(t))yield a.play();else{a==null||a.pause();let o=yield s.play(t);for(let l of o)yield this.addTrack(l,i==="audio"?"audioplaylist":"videoplaylist")}})}isItemCurrentlyPlaying(t,i){let r=this.getElement(i);return!!(r&&!r.paused&&r.src.includes(t))}setDuration(t="audio"){let i=this.getElement(t),{list:r,currentIndex:s}=this.state[t];r[s]&&(r[s].duration=(i==null?void 0:i.duration)||0),this.emit("newTrackStart",r[s])}pause(r){return d(this,arguments,function*(t,i="audio"){let s=this.getElement(i);s&&!s.paused&&s.src.includes(t)?(s.pause(),c.d(this.TAG,"paused url",t)):c.w(this.TAG,"The passed in url is not currently playing")})}addListeners(){this.audioManager.on("ended",()=>this.handleEnded("audio")),this.videoManager.on("ended",()=>this.handleEnded("video")),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return d(this,arguments,function*(t="audio"){let{list:i,currentIndex:r,isAutoplayOn:s}=this.state[t];r===i.length-1?(yield this.stop(t),this.emit("playlistEnded",t)):s?this.playNext(t):yield this.pause(i[r].url,t),this.emit("currentTrackEnded",i[r])})}};var jt=class{constructor(e){this.transport=e;this.observedKeys=new Set}get(e){return d(this,null,function*(){let{data:t,updated_at:i}=yield this.transport.getSessionMetadata(e);return{value:t,updatedAt:b(i)}})}set(e,t){return d(this,null,function*(){let{data:i,updated_at:r}=yield this.transport.setSessionMetadata({key:e,data:t}),s=b(r);return{value:i,updatedAt:s}})}observe(e){return d(this,null,function*(){let t=new Set(this.observedKeys);if(e.forEach(i=>this.observedKeys.add(i)),this.observedKeys.size!==t.size)try{yield this.transport.listenMetadataChange(Array.from(this.observedKeys))}catch(i){throw this.observedKeys=t,i}})}unobserve(e){return d(this,null,function*(){let t=new Set(this.observedKeys);if(this.observedKeys=new Set([...this.observedKeys].filter(i=>!e.includes(i))),this.observedKeys.size!==t.size)try{yield this.transport.listenMetadataChange(Array.from(this.observedKeys))}catch(i){throw this.observedKeys=t,i}})}};var Qt=class{constructor(e,t,i="",r="",s="https://prod-init.100ms.live/init",a=!1){this.authToken=e;this.peerId=t;this.peerName=i;this.data=r;this.endpoint=s;this.autoSubscribeVideo=a}};var _=(s=>(s[s.ConnectFailed=0]="ConnectFailed",s[s.SignalDisconnect=1]="SignalDisconnect",s[s.JoinWSMessageFailed=2]="JoinWSMessageFailed",s[s.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",s[s.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed",s))(_||{}),Er={0:[],1:[],2:[1],3:[1],4:[1]};var Le=(o=>(o.Disconnected="Disconnected",o.Connecting="Connecting",o.Joined="Joined",o.Preview="Preview",o.Failed="Failed",o.Reconnecting="Reconnecting",o.Leaving="Leaving",o))(Le||{});var Jt=class{constructor(e){this.promise=new Promise((t,i)=>{this.resolve=t,this.reject=i,e(t,i)})}};var Yt=class{constructor(e,t){this.onStateChange=e;this.sendEvent=t;this.TAG="[RetryScheduler]";this.inProgress=new Map;this.retryTaskIds=[]}schedule(o){return d(this,arguments,function*({category:e,error:t,task:i,originalState:r,maxFailedRetries:s=5,changeState:a=!0}){yield this.scheduleTask({category:e,error:t,changeState:a,task:i,originalState:r,maxFailedRetries:s})})}reset(){this.retryTaskIds.forEach(e=>clearTimeout(e)),this.retryTaskIds=[],this.inProgress.clear()}isTaskInProgress(e){return!!this.inProgress.get(e)}scheduleTask(l){return d(this,arguments,function*({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:a=5,failedRetryCount:o=0}){if(c.d(this.TAG,"schedule: ",{category:_[e],error:t}),o===0){let v=this.inProgress.get(e);if(v){c.d(this.TAG,`schedule: Already a task for ${_[e]} scheduled, waiting for its completion`),yield v.promise;return}let A=new Jt((f,G)=>{});this.inProgress.set(e,A),this.sendEvent(t,e)}let p=!1,u=Er[e];for(let v in u){let A=u[parseInt(v)];try{let f=this.inProgress.get(A);f&&(c.d(this.TAG,`schedule: Suspending retry task of ${_[e]}, waiting for ${_[A]} to recover`),yield f.promise,c.d(this.TAG,`schedule: Resuming retry task ${_[e]} as it's dependency ${_[A]} is recovered`))}catch(f){c.d(this.TAG,`schedule: Stopping retry task of ${_[e]} as it's dependency ${_[A]} failed to recover`),p=!0;break}}if(o>=a||p){if(t.description+=`. [${_[e]}] Could not recover after ${o} tries`,p&&(t.description+=` Could not recover all of it's required dependencies - [${u.map(v=>_[v]).toString()}]`),t.isTerminal=!0,this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),i)this.onStateChange("Failed",t);else throw t;return}i&&this.onStateChange("Reconnecting",t);let g=this.getDelayForRetryCount(e,o);c.d(this.TAG,`schedule: [${_[e]}] [failedRetryCount=${o}] Scheduling retry task in ${g}ms`);let T;try{T=yield this.setTimeoutPromise(r,g)}catch(v){T=!1,c.w(this.TAG,`[${_[e]}] Un-caught exception ${v.name} in retry-task, initiating retry`,v)}if(T){let v=this.inProgress.get(e);this.inProgress.delete(e),v==null||v.resolve(o),i&&this.inProgress.size===0&&this.onStateChange(s),c.d(this.TAG,`schedule: [${_[e]}] [failedRetryCount=${o}] Recovered \u267B\uFE0F`)}else yield this.scheduleTask({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:a,failedRetryCount:o+1})})}getBaseDelayForTask(e,t){return e===2?2:Math.pow(2,t)}getDelayForRetryCount(e,t){let i=this.getBaseDelayForTask(e,t),r=e===2?Math.random()*2:Math.random();return Math.round(Math.min(i+r,60)*1e3)}setTimeoutPromise(e,t){return d(this,null,function*(){return new Promise((i,r)=>{let s=window.setTimeout(()=>d(this,null,function*(){try{let a=yield e();a&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(s),1),i(a)}catch(a){r(a)}}),t);this.retryTaskIds.push(s)})})}};var Xt=class extends re{constructor(){super(100);this.localStorage=new V("hms-analytics");this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(t){super.enqueue(t),this.localStorage.set(this.storage)}dequeue(){let t=super.dequeue();return this.localStorage.set(this.storage),t}initLocalStorageQueue(){var t;(t=this.localStorage.get())==null||t.forEach(i=>{let r=new k(i);super.enqueue(r)})}};var Zt=class{constructor(){this.TAG="[AnalyticsTransport]"}sendEvent(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(t){c.w(this.TAG,"sendEvent failed",t)}}flushFailedEvents(e){var t;try{for(c.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&(((t=i.metadata)==null?void 0:t.peer.peer_id)===e||!i.metadata.peer.peer_id?this.sendSingleEvent(i):X.sendEvent(i))}}catch(i){c.w(this.TAG,"flushFailedEvents failed",i)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),c.d(this.TAG,"Sent event",e.name,e)}catch(t){throw c.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}};var ei=class extends Zt{constructor(t){super();this.transportProvider=t;this.failedEvents=new Xt}};var we=class{constructor(e,t,i,r){this.store=e;this.eventBus=t;this.sampleWindowSize=i;this.pushInterval=r;this.shouldSendEvent=!1;this.sequenceNum=1;this.stop=()=>{this.shouldSendEvent&&this.sendEvent(),this.eventBus.statsUpdate.unsubscribe(this.handleStatsUpdate.bind(this)),this.shouldSendEvent=!1};this.start()}start(){this.shouldSendEvent||(this.stop(),this.shouldSendEvent=!0,this.eventBus.statsUpdate.subscribe(this.handleStatsUpdate.bind(this)),this.startLoop().catch(e=>c.e("[StatsAnanlytics]",e.message)))}startLoop(){return d(this,null,function*(){for(;this.shouldSendEvent;)yield N(this.pushInterval*1e3),this.sendEvent()})}},_e=class{constructor({track:e,ssrc:t,rid:i,kind:r,sampleWindowSize:s}){this.samples=[];this.tempStats=[];this.track=e,this.ssrc=t,this.rid=i,this.kind=r,this.track_id=this.track.trackId,this.source=this.track.source,this.sampleWindowSize=s}push(e){this.tempStats.push(e),this.shouldCreateSample()&&(this.samples.push(this.createSample()),this.tempStats.length=0)}getLatestStat(){return this.tempStats[this.tempStats.length-1]}getFirstStat(){return this.tempStats[0]}calculateSum(e){if(typeof this.getLatestStat()[e]=="number")return this.tempStats.reduce((i,r)=>i+(r[e]||0),0)}calculateAverage(e,t=!0){let i=this.calculateSum(e),r=i!==void 0?i/this.tempStats.length:void 0;return r?t?Math.round(r):r:void 0}calculateDifferenceForSample(e){let t=Number(this.tempStats[0][e])||0;return(Number(this.getLatestStat()[e])||0)-t}calculateInstancesOfHigh(e,t){if(typeof this.getLatestStat()[e]=="number")return this.tempStats.reduce((r,s)=>r+((s[e]||0)>t?1:0),0)}},ti=(n,e)=>n&&e&&(n.frameWidth!==e.frameWidth||n.frameHeight!==e.frameHeight),ii=(n,e)=>n&&e&&n.enabled!==e.enabled,Ze=n=>Object.entries(n).filter(([,e])=>e!==void 0).reduce((e,[t,i])=>(e[t]=i,e),{});var et=class extends we{constructor(){super(...arguments);this.trackAnalytics=new Map}toAnalytics(){var r,s;let t=[],i=[];return this.trackAnalytics.forEach(a=>{a.track.type==="audio"?t.push(a.toAnalytics()):a.track.type==="video"&&i.push(a.toAnalytics())}),{audio:t,video:i,joined_at:(s=(r=this.store.getRoom())==null?void 0:r.joinedAt)==null?void 0:s.getTime(),sequence_num:this.sequenceNum++,max_window_sec:30}}sendEvent(){this.eventBus.analytics.publish(P.publishStats(this.toAnalytics()))}handleStatsUpdate(t){let i=t.getLocalTrackStats();Object.keys(i).forEach(r=>{let s=i[r],a=this.store.getLocalPeerTracks().find(o=>o.getTrackIDBeingSent()===r);Object.keys(s).forEach(o=>{var u,g,T,v,A;let l=s[o],p=a&&this.getTrackIdentifier(a==null?void 0:a.trackId,l);if(p&&this.trackAnalytics.has(p))(T=this.trackAnalytics.get(p))==null||T.push(y(m({},l),{availableOutgoingBitrate:(g=(u=t.getLocalPeerStats())==null?void 0:u.publish)==null?void 0:g.availableOutgoingBitrate}));else if(a){let f=new Di({track:a,sampleWindowSize:this.sampleWindowSize,rid:l.rid,ssrc:l.ssrc.toString(),kind:l.kind});f.push(y(m({},l),{availableOutgoingBitrate:(A=(v=t.getLocalPeerStats())==null?void 0:v.publish)==null?void 0:A.availableOutgoingBitrate})),this.trackAnalytics.set(this.getTrackIdentifier(a==null?void 0:a.trackId,l),f)}})})}getTrackIdentifier(t,i){return i.rid?`${t}:${i.rid}`:t}},Di=class extends _e{constructor(){super(...arguments);this.samples=[];this.createSample=()=>{let t=this.getLatestStat(),i=t.qualityLimitationDurations,r=i&&{bandwidth_sec:i.bandwidth,cpu_sec:i.cpu,other_sec:i.other},s=t.frameHeight?{height_px:this.getLatestStat().frameHeight,width_px:this.getLatestStat().frameWidth}:void 0,a=this.calculateAverage("jitter",!1),o=a?Math.round(a*1e3):void 0,l=this.calculateAverage("roundTripTime",!1),p=l?Math.round(l*1e3):void 0;return Ze({timestamp:Date.now(),avg_available_outgoing_bitrate_bps:this.calculateAverage("availableOutgoingBitrate"),avg_bitrate_bps:this.calculateAverage("bitrate"),avg_fps:this.calculateAverage("framesPerSecond"),total_packets_lost:this.calculateDifferenceForSample("packetsLost"),total_packets_sent:this.calculateDifferenceForSample("packetsSent"),total_packet_sent_delay_sec:parseFloat(this.calculateDifferenceForSample("totalPacketSendDelay").toFixed(4)),total_fir_count:this.calculateDifferenceForSample("firCount"),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount"),avg_jitter_ms:o,avg_round_trip_time_ms:p,total_quality_limitation:r,resolution:s})};this.shouldCreateSample=()=>{let t=this.tempStats.length,i=this.tempStats[t-1],r=this.tempStats[t-2];return t===30||ii(i,r)||i.kind==="video"&&ti(i,r)};this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}};var tt=class extends we{constructor(){super(...arguments);this.trackAnalytics=new Map}toAnalytics(){var r,s;let t=[],i=[];return this.trackAnalytics.forEach(a=>{a.track.type==="audio"?t.push(a.toAnalytics()):a.track.type==="video"&&i.push(a.toAnalytics())}),{audio:t,video:i,joined_at:(s=(r=this.store.getRoom())==null?void 0:r.joinedAt)==null?void 0:s.getTime(),sequence_num:this.sequenceNum++,max_window_sec:10}}sendEvent(){this.eventBus.analytics.publish(P.subscribeStats(this.toAnalytics()))}handleStatsUpdate(t){let i=t.getAllRemoteTracksStats();Object.keys(i).forEach(r=>{var o;let s=i[r],a=this.store.getTrackById(r);if(this.trackAnalytics.has(r))(o=this.trackAnalytics.get(r))==null||o.push(m({},s));else if(a){let l=new Oi({track:a,sampleWindowSize:this.sampleWindowSize,ssrc:s.ssrc.toString(),kind:s.kind});l.push(m({},s)),this.trackAnalytics.set(r,l)}})}},Oi=class extends _e{constructor(){super(...arguments);this.samples=[];this.createSample=()=>{let t=this.getLatestStat(),i=this.getFirstStat(),r={timestamp:Date.now(),fec_packets_discarded:this.calculateDifferenceForSample("fecPacketsDiscarded"),fec_packets_received:this.calculateDifferenceForSample("fecPacketsReceived"),total_samples_duration:this.calculateDifferenceForSample("totalSamplesDuration"),total_packets_received:this.calculateDifferenceForSample("packetsReceived"),total_packets_lost:this.calculateDifferenceForSample("packetsLost"),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount")};if(t.kind==="video")return Ze(r);{let s=(t.concealedSamples||0)-(t.silentConcealedSamples||0)-((i.concealedSamples||0)-(i.silentConcealedSamples||0));return Ze(Object.assign(r,{audio_concealed_samples:s,audio_level:this.calculateInstancesOfHigh("audioLevel",.05),audio_total_samples_received:this.calculateDifferenceForSample("totalSamplesReceived"),audio_concealment_events:this.calculateDifferenceForSample("concealmentEvents")}))}};this.shouldCreateSample=()=>{let t=this.tempStats.length,i=this.tempStats[t-1],r=this.tempStats[t-2];return t===10||ii(i,r)||i.kind==="video"&&ti(i,r)};this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}};var Te=(t=>(t[t.Publish=0]="Publish",t[t.Subscribe=1]="Subscribe",t))(Te||{});import*as it from"sdp-transform";function Pr(n,e){var r;let t=it.parse(n.sdp);if(!((r=t.origin)!=null&&r.username.startsWith("mozilla")))return n;let i=e?Array.from(e.values()):[];return t.media.forEach(s=>{var l,p,u;let a=(l=s.msid)==null?void 0:l.split(" ")[0],o=(p=i.find(g=>g.type===s.type&&g.stream_id===a))==null?void 0:p.track_id;o&&(s.msid=(u=s.msid)==null?void 0:u.replace(/\s(.+)/,` ${o}`))}),{type:n.type,sdp:it.write(t)}}function yr(n,e){var s;if(!(n!=null&&n.sdp)||!e)return;let i=it.parse(n.sdp).media.find(a=>U(a.mid)&&parseInt(a.mid)===parseInt(e));return(s=i==null?void 0:i.msid)==null?void 0:s.split(" ")[1]}function Mr(n){return n.sdp.includes("usedtx=1")?n:{type:n.type,sdp:n.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}var Z="[HMSConnection]",ve=class{constructor(e,t){this.candidates=new Array;this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return this.role===0?"PUBLISH":"SUBSCRIBE"}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return d(this,null,function*(){try{let i=yield this.nativeConnection.createOffer(t);return c.d(Z,`[role=${this.role}] createOffer offer=${JSON.stringify(i,null,1)}`),Mr(Pr(i,e))}catch(i){throw h.WebrtcErrors.CreateOfferFailed(this.action,i.message)}})}createAnswer(e=void 0){return d(this,null,function*(){try{let t=yield this.nativeConnection.createAnswer(e);return c.d(Z,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(t){throw h.WebrtcErrors.CreateAnswerFailed(this.action,t.message)}})}setLocalDescription(e){return d(this,null,function*(){try{c.d(Z,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(t){throw h.WebrtcErrors.SetLocalDescriptionFailed(this.action,t.message)}})}setRemoteDescription(e){return d(this,null,function*(){try{c.d(Z,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(t){throw h.WebrtcErrors.SetRemoteDescriptionFailed(this.action,t.message)}})}addIceCandidate(e){return d(this,null,function*(){if(this.nativeConnection.signalingState==="closed"){c.d(Z,`[role=${this.role}] addIceCandidate signalling state closed`);return}c.d(Z,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)})}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}logSelectedIceCandidatePairs(){try{(this.role===0?this.getSenders():this.getReceivers()).forEach(t=>{var r;let i=(r=t.track)==null?void 0:r.kind;if(t.transport){let s=t.transport.iceTransport,a=()=>{typeof s.getSelectedCandidatePair=="function"&&(this.selectedCandidatePair=s.getSelectedCandidatePair(),c.d(Z,`${Te[this.role]} connection`,`selected ${i||"unknown"} candidate pair`,JSON.stringify(this.selectedCandidatePair,null,2)))};typeof s.onselectedcandidatepairchange=="function"&&(s.onselectedcandidatepairchange=a),a()}})}catch(e){c.w(Z,`Error in logging selected ice candidate pair for ${Te[this.role]} connection`,e)}}removeTrack(e){this.nativeConnection.signalingState!=="closed"&&this.nativeConnection.removeTrack(e)}setMaxBitrateAndFramerate(e){return d(this,null,function*(){let t=e.settings.maxBitrate,i=e instanceof F&&e.settings.maxFramerate,r=this.getSenders().find(s=>{var a;return((a=s==null?void 0:s.track)==null?void 0:a.id)===e.getTrackIDBeingSent()});if(r){let s=r.getParameters();s.encodings.length===1&&(t&&(s.encodings[0].maxBitrate=t*1e3),i&&(s.encodings[0].maxFramerate=i)),yield r.setParameters(s)}else c.w(Z,`no sender found to setMaxBitrate for track - ${e.trackId}, sentTrackId - ${e.getTrackIDBeingSent()}`)})}getStats(){return d(this,null,function*(){return yield this.nativeConnection.getStats()})}close(){return d(this,null,function*(){this.nativeConnection.close()})}getReceivers(){return this.nativeConnection.getReceivers()}};var rt=class extends ve{constructor(t,i,r){super(0,t);this.TAG="[HMSPublishConnection]";this.observer=r,this.nativeConnection=new RTCPeerConnection(i),this.channel=this.nativeConnection.createDataChannel(lt,{protocol:"SCTP"}),this.channel.onerror=s=>c.e(this.TAG,`publish data channel onerror ${s}`,s),this.nativeConnection.onicecandidate=({candidate:s})=>{s&&t.trickle(this.role,s)},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState),this.nativeConnection.sctp&&(this.nativeConnection.sctp.transport.onstatechange=()=>{var s;this.observer.onDTLSTransportStateChange((s=this.nativeConnection.sctp)==null?void 0:s.transport.state)},this.nativeConnection.sctp.transport.onerror=s=>{var a;this.observer.onDTLSTransportError(new Error((a=s==null?void 0:s.error)==null?void 0:a.errorDetail)||"DTLS Transport failed")})}}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>d(this,null,function*(){c.d(this.TAG,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()})}};import Ps from"eventemitter2";import{v4 as ys}from"uuid";var st=class{constructor(e,t,i=""){this.TAG="[HMSDataChannel]";this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=r=>{this.observer.onMessage(r.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){c.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}};var at=class n extends ve{constructor(t,i,r,s){super(1,t);this.isFlagEnabled=r;this.TAG="[HMSSubscribeConnection]";this.remoteStreams=new Map;this.MAX_RETRIES=3;this.pendingMessageQueue=[];this.eventEmitter=new Ps({maxListeners:60});this.handlePendingApiMessages=()=>{this.eventEmitter.emit("open",!0),this.pendingMessageQueue.length>0&&(c.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach(t=>this.sendOverApiDataChannel(t)),this.pendingMessageQueue.length=0)};this.sendMessage=(t,i)=>d(this,null,function*(){var s;((s=this.apiChannel)==null?void 0:s.readyState)!=="open"&&(yield this.eventEmitter.waitFor("open"));let r;for(let a=0;a<this.MAX_RETRIES;a++){this.apiChannel.send(t),r=yield this.waitForResponse(i);let o=r.error;if(o){if(o.code===404){c.d(this.TAG,`Track not found ${i}`,{request:t,try:a+1,error:o});break}if(c.d(this.TAG,`Failed sending ${i}`,{request:t,try:a+1,error:o}),!(o.code/100===5||o.code===429))throw Error(`code=${o.code}, message=${o.message}`);let p=(2+Math.random()*2)*1e3;yield K(p)}else break}return r});this.waitForResponse=t=>d(this,null,function*(){let i=yield this.eventEmitter.waitFor("message",function(s){return s.includes(t)}),r=JSON.parse(i[0]);return c.d(this.TAG,`response for ${t} -`,JSON.stringify(r,null,2)),r});this.observer=s,this.nativeConnection=new RTCPeerConnection(i),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=t=>{t.channel.label===lt&&(this.apiChannel=new st(t.channel,{onMessage:i=>{this.eventEmitter.emit("message",i),this.observer.onApiChannelMessage(i)}},`role=${this.role}`),t.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=t=>{t.candidate!==null&&this.signal.trickle(this.role,t.candidate)},this.nativeConnection.ontrack=t=>{var p;let i=t.streams[0],r=i.id;if(!this.remoteStreams.has(r)){let u=new J(i,this);this.remoteStreams.set(r,u)}i.addEventListener("removetrack",u=>{if(u.track.id!==t.track.id)return;let g=s.tracks.findIndex(T=>{var v;return T.nativeTrack.id===u.track.id&&t.transceiver.mid===((v=T.transceiver)==null?void 0:v.mid)});if(g>=0){let T=s.tracks[g];this.observer.onTrackRemove(T),s.tracks.splice(g,1),s.tracks.length===0&&this.remoteStreams.delete(r)}});let s=this.remoteStreams.get(r),a=t.track.kind==="audio"?ae:w,o=new a(s,t.track);t.track.kind==="video"&&s.setVideoLayerLocally("none","addTrack","subscribeConnection"),o.transceiver=t.transceiver;let l=yr(this.remoteDescription,(p=t.transceiver)==null?void 0:p.mid);l&&o.setSdpTrackId(l),s.tracks.push(o),this.observer.onTrackAdd(o)}}sendOverApiDataChannel(t){this.apiChannel&&this.apiChannel.readyState==="open"?this.apiChannel.send(t):(c.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,t),this.pendingMessageQueue.push(t))}sendOverApiDataChannelWithResponse(t,i){return d(this,null,function*(){let r=ys();if(t.method==="prefer-video-track-state"&&this.isFlagEnabled("disableVideoTrackAutoUnsubscribe")&&t.params.max_spatial_layer==="none")return c.d(this.TAG,"video auto unsubscribe is disabled, request is ignored"),{id:r};let s=JSON.stringify(m({id:i||r,jsonrpc:"2.0"},t));return this.sendMessage(s,r)})}close(){return d(this,null,function*(){var t;yield H(n.prototype,this,"close").call(this),(t=this.apiChannel)==null||t.close()})}};var ai="[InitService]",nt=class{static handleError(e,t){switch(e.status){case 404:throw h.APIErrors.EndpointUnreachable("INIT",t.message||e.statusText);case 200:break;default:throw h.APIErrors.ServerErrors(t.code||e.status,"INIT",t.message||(e==null?void 0:e.statusText))}}static fetchInitConfig(a){return d(this,arguments,function*({token:e,peerId:t,userAgent:i,initEndpoint:r="https://prod-init.100ms.live",region:s=""}){c.d(ai,`fetchInitConfig: initEndpoint=${r} token=${e} peerId=${t} region=${s} `);let o=Ms(r,t,i,s);try{let l=yield fetch(o,{headers:{Authorization:`Bearer ${e}`}});try{let p=yield l.clone().json();return this.handleError(l,p),c.d(ai,`config is ${JSON.stringify(p,null,2)}`),ks(p)}catch(p){let u=yield l.text();throw c.e(ai,"json error",p.message,u),h.APIErrors.ServerErrors(l.status,"INIT",u)}}catch(l){let p=l;throw["Failed to fetch","NetworkError","ECONNRESET"].some(u=>p.message.includes(u))?h.APIErrors.EndpointUnreachable("INIT",p.message):p}})}};function Ms(n,e,t,i){try{let r=new URL("/init",n);return i&&i.trim().length>0&&r.searchParams.set("region",i.trim()),r.searchParams.set("peer_id",e),r.searchParams.set("user_agent_v2",t),r.toString()}catch(r){let s=r;throw c.e(ai,s.name,s.message),s}}function ks(n){var e;return y(m({},n),{rtcConfiguration:y(m({},n.rtcConfiguration),{iceServers:(e=n.rtcConfiguration)==null?void 0:e.ice_servers})})}import{v4 as Rs}from"uuid";var ot=class{constructor(e){this.TAG="[SIGNAL]: ";this.pongResponseTimes=new re(5);this.isJoinCompleted=!1;this.pendingTrickle=[];this.socket=null;this.callbacks=new Map;this._isConnected=!1;this.id=0;this.onCloseHandler=()=>{};this.resolvePingOnAnyResponse=()=>{this.callbacks.forEach((e,t)=>{var i;((i=e.metadata)==null?void 0:i.method)==="ping"&&(e.resolve({timestamp:Date.now()}),this.callbacks.delete(t))})};this.offlineListener=()=>{c.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")};this.onlineListener=()=>{c.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()};this.observer=e,window.addEventListener("offline",this.offlineListener),window.addEventListener("online",this.onlineListener),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setIsConnected(e,t=""){c.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e}`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.rejectPendingCalls(t),this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}internalCall(e,t){return d(this,null,function*(){var s;let i=Rs(),r={method:e,params:t,id:i,jsonrpc:"2.0"};(s=this.socket)==null||s.send(JSON.stringify(r));try{return yield new Promise((o,l)=>{this.callbacks.set(i,{resolve:o,reject:l,metadata:{method:e}})})}catch(a){if(a instanceof S)throw a;let o=a;throw h.WebsocketMethodErrors.ServerErrors(Number(o.code),ui(e),o.message)}})}notify(e,t){var r,s;let i={method:e,params:t};((r=this.socket)==null?void 0:r.readyState)===WebSocket.OPEN&&((s=this.socket)==null||s.send(JSON.stringify(i)))}open(e){return new Promise((t,i)=>{let r=!1;this.socket&&(this.socket.close(),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let s=()=>{c.e(this.TAG,"Error from websocket"),r=!0,i(h.WebSocketConnectionErrors.FailedToConnect("JOIN","Error opening websocket connection"))};this.onCloseHandler=o=>{c.w(`Websocket closed code=${o.code}`),r?this.setIsConnected(!1,`code: ${o.code}${o.code!==1e3?", unexpected websocket close":""}`):(r=!0,i(h.WebSocketConnectionErrors.AbnormalClose("JOIN",`Error opening websocket connection - websocket closed unexpectedly with code=${o.code}`)))},this.socket.addEventListener("error",s);let a=()=>{var o,l;r=!0,t(),this.setIsConnected(!0),this.id++,(o=this.socket)==null||o.removeEventListener("open",a),(l=this.socket)==null||l.removeEventListener("error",s),this.pingPongLoop(this.id)};this.socket.addEventListener("open",a),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)})}close(){return d(this,null,function*(){window.removeEventListener("offline",this.offlineListener),window.removeEventListener("online",this.onlineListener),this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")})}join(e,t,i,r,s,a,o){return d(this,null,function*(){if(!this.isConnected)throw h.WebSocketConnectionErrors.WebSocketConnectionLost("JOIN","Failed to send join over WS connection");let l={name:e,disableVidAutoSub:i,data:t,offer:o,server_sub_degrade:r,simulcast:s,onDemandTracks:a},p=yield this.internalCall("join",l);return this.isJoinCompleted=!0,this.pendingTrickle.forEach(({target:u,candidate:g})=>this.trickle(u,g)),this.pendingTrickle.length=0,c.d(this.TAG,`join: response=${JSON.stringify(p,null,1)}`),p})}trickle(e,t){this.isJoinCompleted?this.notify("trickle",{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return d(this,null,function*(){return yield this.call("offer",{desc:e,tracks:Object.fromEntries(t)})})}answer(e){this.notify("answer",{desc:e})}trackUpdate(e){this.notify("track-update",{tracks:Object.fromEntries(e)})}broadcast(e){return d(this,null,function*(){return yield this.call("broadcast",e.toSignalParams())})}leave(){this.notify("leave",{})}endRoom(e,t){return d(this,null,function*(){yield this.call("end-room",{lock:e,reason:t})})}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify("analytics",e.toSignalParams())}ping(e){let t=Date.now(),i=new Promise(s=>{setTimeout(()=>{s(Date.now()-t)},e+1)}),r=this.internalCall("ping",{timestamp:t}).then(()=>Date.now()-t).catch(()=>Date.now()-t);return Promise.race([i,r])}requestRoleChange(e){return d(this,null,function*(){yield this.call("role-change-request",e)})}requestBulkRoleChange(e){return d(this,null,function*(){yield this.call("role-change-request",e)})}acceptRoleChangeRequest(e){return d(this,null,function*(){yield this.call("role-change",e)})}requestTrackStateChange(e){return d(this,null,function*(){yield this.call("track-update-request",e)})}requestMultiTrackStateChange(e){return d(this,null,function*(){yield this.call("change-track-mute-state-request",e)})}removePeer(e){return d(this,null,function*(){yield this.call("peer-leave-request",e)})}startRTMPOrRecording(e){return d(this,null,function*(){yield this.call("rtmp-start",m({},e))})}stopRTMPAndRecording(){return d(this,null,function*(){yield this.call("rtmp-stop",{})})}startHLSStreaming(e){return d(this,null,function*(){yield this.call("hls-start",m({},e))})}stopHLSStreaming(e){return d(this,null,function*(){yield this.call("hls-stop",m({},e))})}sendHLSTimedMetadata(e){return d(this,null,function*(){yield this.call("hls-timed-metadata",m({},e))})}updatePeer(e){return d(this,null,function*(){yield this.call("peer-update",m({},e))})}getPeer(e){return d(this,null,function*(){yield this.call("get-peer",m({},e))})}joinGroup(e){return d(this,null,function*(){return yield this.call("group-join",{name:e})})}leaveGroup(e){return d(this,null,function*(){return yield this.call("group-leave",{name:e})})}addToGroup(e,t){return d(this,null,function*(){yield this.call("group-add",{name:t,peer_id:e})})}removeFromGroup(e,t){return d(this,null,function*(){yield this.call("group-remove",{name:t,peer_id:e})})}peerIterNext(e){return d(this,null,function*(){return yield this.call("peer-iter-next",e)})}findPeers(e){return d(this,null,function*(){return yield this.call("find-peer",e)})}setSessionMetadata(e){if(!this.isConnected)throw h.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("set-metadata",m({},e))}listenMetadataChange(e){if(!this.isConnected)throw h.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to observe session store key due to network disconnection");return this.call("listen-metadata-change",{keys:e})}getSessionMetadata(e){if(!this.isConnected)throw h.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("get-metadata",{key:e})}setPollInfo(e){return this.call("poll-info-set",m({},e))}getPollInfo(e){return this.call("poll-info-get",m({},e))}setPollQuestions(e){return this.call("poll-questions-set",m({},e))}startPoll(e){return this.call("poll-start",m({},e))}stopPoll(e){return this.call("poll-stop",m({},e))}getPollQuestions(e){return this.call("poll-questions-get",m({},e))}setPollResponses(e){return this.call("poll-response",m({},e))}getPollResponses(e){return this.call("poll-responses",m({},e))}getPollsList(e){return this.call("poll-list",m({},e))}getPollResult(e){return this.call("poll-result",m({},e))}createWhiteboard(e){return this.validateConnection(),this.call("whiteboard-create",m({},e))}getWhiteboard(e){return this.validateConnection(),this.call("whiteboard-get",m({},e))}fetchPollLeaderboard(e){return this.call("poll-leaderboard",m({},e))}validateConnection(){if(!this.isConnected)throw h.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL","Failed to send message due to network disconnection")}onMessageHandler(e){let t=e.data,i=JSON.parse(t);if(this.resolvePingOnAnyResponse(),i.id)this.handleResponseWithId(i);else if(i.method)this.handleResponseWithMethod(i);else throw Error(`WebSocket message has no 'method' or 'id' field, message=${i}`)}handleResponseWithId(e){let t=e,i=t.id;if(this.callbacks.has(i)){let r=this.callbacks.get(i);this.callbacks.delete(i),t.result?r.resolve(t.result):r.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case"offer":this.observer.onOffer(e.params);break;case"trickle":this.observer.onTrickle(e.params);break;case"on-error":this.observer.onServerError(h.WebsocketMethodErrors.ServerErrors(Number(e.params.code),"on-error",e.params.message));break;case"on-warning":c.w(this.TAG,e.params);break;default:this.observer.onNotification(e);break}}rejectPendingCalls(e=""){this.callbacks.forEach((t,i)=>{var r,s,a,o;((r=t.metadata)==null?void 0:r.method)!=="ping"&&(c.e(this.TAG,`rejecting pending callback ${(s=t.metadata)==null?void 0:s.method}, id=${i}`),t.reject(h.WebSocketConnectionErrors.WebSocketConnectionLost((a=t.metadata)!=null&&a.method?ui((o=t.metadata)==null?void 0:o.method):"RECONNECT_SIGNAL",e)),this.callbacks.delete(i))})}pingPongLoop(e){return d(this,null,function*(){var i,r;let t=((i=window.HMS)==null?void 0:i.PING_TIMEOUT)||12e3;if(this.isConnected){let s=yield this.ping(t);this.pongResponseTimes.enqueue(s),s>t?(c.d(this.TAG,`Pong timeout ${e}, pageHidden=${Ki()}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout(()=>this.pingPongLoop(e),((r=window.HMS)==null?void 0:r.PING_INTERVAL)||3e3)}})}call(e,t){return d(this,null,function*(){let r=h.WebsocketMethodErrors.ServerErrors(500,e,`Default ${e} error`);this.validateConnection();let s;for(s=1;s<=3;s++)try{return c.d(this.TAG,`Try number ${s} sending ${e}`,t),yield this.internalCall(e,t)}catch(a){if(r=a,c.e(this.TAG,`Failed sending ${e} try: ${s}`,{method:e,params:t,error:r}),!(parseInt(`${r.code/100}`)===5||r.code===429))break;let l=(2+Math.random()*2)*1e3;yield K(l)}throw c.e(`Sending ${e} over WS failed after ${Math.min(s,3)} retries`,{method:e,params:t,error:r}),r})}};var kr=()=>{if(!L||typeof navigator.connection=="undefined")return;let n=navigator.connection;return{downlink:n.downlink,downlinkMax:n.downlinkMax,effectiveType:n.effectiveType,rtt:n.rtt,saveData:n.saveData,type:n.type}};var M="[HMSTransport]:",ct=class{constructor(e,t,i,r,s,a){this.observer=e;this.deviceManager=t;this.store=i;this.eventBus=r;this.analyticsEventsService=s;this.analyticsTimer=a;this.state="Disconnected";this.trackStates=new Map;this.publishConnection=null;this.subscribeConnection=null;this.maxSubscribeBitrate=0;this.joinRetryCount=0;this.callbacks=new Map;this.signalObserver={onOffer:e=>d(this,null,function*(){try{if(!this.subscribeConnection)return;yield this.subscribeConnection.setRemoteDescription(e),c.d(M,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let i of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(i);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),c.d(M,"[role=SUBSCRIBE] onOffer renegotiation DONE \u2705")}catch(t){c.d(M,"[role=SUBSCRIBE] onOffer renegotiation FAILED \u274C",t),this.state="Failed";let i;t instanceof S?i=t:i=h.GenericErrors.Unknown("PUBLISH",t.message),this.observer.onFailure(i),this.eventBus.analytics.publish(P.subscribeFail(i))}}),onTrickle:e=>d(this,null,function*(){let t=e.target===0?this.publishConnection:this.subscribeConnection;t!=null&&t.remoteDescription?yield t.addIceCandidate(e.candidate):t==null||t.candidates.push(e.candidate)}),onNotification:e=>this.observer.onNotification(e),onServerError:e=>d(this,null,function*(){yield this.observer.onStateChange("Failed",e)}),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule({category:1,error:e,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:e=>d(this,null,function*(){c.d(M,"socket offline",Le[this.state]);try{this.state!=="Leaving"&&this.joinParameters&&this.retryScheduler.schedule({category:1,error:h.WebSocketConnectionErrors.WebSocketConnectionLost("RECONNECT_SIGNAL",e),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(t){console.error(t)}}),onOnline:()=>{var e;c.d(M,"socket online",Le[this.state]),this.analyticsSignalTransport.flushFailedEvents((e=this.store.getLocalPeer())==null?void 0:e.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}};this.signal=new ot(this.signalObserver);this.analyticsSignalTransport=new ei(this.signal);this.publishDtlsStateTimer=0;this.lastPublishDtlsState="new";this.publishConnectionObserver={onRenegotiationNeeded:()=>d(this,null,function*(){yield this.performPublishRenegotiation()}),onDTLSTransportStateChange:e=>{var r,s,a;if((e==="failed"?c.w.bind(c):c.d.bind(c))(M,`Publisher on dtls transport state change: ${e}`),!e||this.lastPublishDtlsState===e||(this.lastPublishDtlsState=e,this.publishDtlsStateTimer!==0&&(clearTimeout(this.publishDtlsStateTimer),this.publishDtlsStateTimer=0),e!=="connecting"&&e!=="failed"))return;let i=(a=(s=(r=this.initConfig)==null?void 0:r.config)==null?void 0:s.dtlsStateTimeouts)==null?void 0:a[e];!i||i<=0||(this.publishDtlsStateTimer=window.setTimeout(()=>{var l;let o=(l=this.publishConnection)==null?void 0:l.nativeConnection.connectionState;if(o&&e&&o===e){let p=h.WebrtcErrors.ICEFailure("PUBLISH",`DTLS transport state ${e} timeout:${i}ms`,!0);this.eventBus.analytics.publish(P.disconnect(p)),this.observer.onFailure(p)}},i))},onDTLSTransportError:e=>{c.e(M,`onDTLSTransportError ${e.name} ${e.message}`,e),this.eventBus.analytics.publish(P.disconnect(e))},onIceConnectionChange:e=>d(this,null,function*(){(e==="disconnected"?c.w.bind(c):c.d.bind(c))(M,`Publish ice connection state change: ${e}`)}),onConnectionStateChange:e=>d(this,null,function*(){var i,r,s,a,o;(e==="disconnected"?c.w.bind(c):c.d.bind(c))(M,`Publish connection state change: ${e}`),e==="connected"&&((i=this.publishConnection)==null||i.logSelectedIceCandidatePairs()),e==="disconnected"&&setTimeout(()=>{var l,p,u,g,T;((l=this.publishConnection)==null?void 0:l.connectionState)==="disconnected"&&this.handleIceConnectionFailure(0,h.WebrtcErrors.ICEDisconnected("PUBLISH",`local candidate - ${(u=(p=this.publishConnection)==null?void 0:p.selectedCandidatePair)==null?void 0:u.local.candidate}; remote candidate - ${(T=(g=this.publishConnection)==null?void 0:g.selectedCandidatePair)==null?void 0:T.remote.candidate}`))},5e3),e==="failed"&&(yield this.handleIceConnectionFailure(0,h.WebrtcErrors.ICEFailure("PUBLISH",`local candidate - ${(s=(r=this.publishConnection)==null?void 0:r.selectedCandidatePair)==null?void 0:s.local.candidate}; remote candidate - ${(o=(a=this.publishConnection)==null?void 0:a.selectedCandidatePair)==null?void 0:o.remote.candidate}`)))})};this.subscribeConnectionObserver={onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{c.d(M,"[Subscribe] onTrackAdd",`${e}`),this.observer.onTrackAdd(e)},onTrackRemove:e=>{c.d(M,"[Subscribe] onTrackRemove",`${e}`),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>d(this,null,function*(){if((e==="disconnected"?c.w.bind(c):c.d.bind(c))(M,`Subscribe ice connection state change: ${e}`),e==="connected"){let i=this.callbacks.get(Ee);this.callbacks.delete(Ee),i&&i.promise.resolve(!0)}}),onConnectionStateChange:e=>d(this,null,function*(){var i,r,s,a;(e==="disconnected"?c.w.bind(c):c.d.bind(c))(M,`Subscribe connection state change: ${e}`),e==="failed"&&(yield this.handleIceConnectionFailure(1,h.WebrtcErrors.ICEFailure("SUBSCRIBE",`local candidate - ${(r=(i=this.subscribeConnection)==null?void 0:i.selectedCandidatePair)==null?void 0:r.local.candidate}; remote candidate - ${(a=(s=this.subscribeConnection)==null?void 0:s.selectedCandidatePair)==null?void 0:a.remote.candidate}`))),e==="disconnected"&&setTimeout(()=>{var o,l,p,u,g;((o=this.subscribeConnection)==null?void 0:o.connectionState)==="disconnected"&&this.handleIceConnectionFailure(1,h.WebrtcErrors.ICEDisconnected("SUBSCRIBE",`local candidate - ${(p=(l=this.subscribeConnection)==null?void 0:l.selectedCandidatePair)==null?void 0:p.local.candidate}; remote candidate - ${(g=(u=this.subscribeConnection)==null?void 0:u.selectedCandidatePair)==null?void 0:g.remote.candidate}`))},5e3),e==="connected"&&this.handleSubscribeConnectionConnected()})};this.handleLocalRoleUpdate=i=>d(this,[i],function*({oldRole:e,newRole:t}){!this.doesRoleNeedWebRTC(e)&&this.doesRoleNeedWebRTC(t)&&(c.d(M,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation \u23F3"),this.createPeerConnections(),yield this.negotiateOnFirstPublish())});this.retryPublishIceFailedTask=()=>d(this,null,function*(){if(this.publishConnection){let e=new Promise((t,i)=>{this.callbacks.set(fe,{promise:{resolve:t,reject:i},action:"RESTART_ICE",extra:{}})});yield this.performPublishRenegotiation({iceRestart:this.publishConnection.connectionState!=="connected"}),yield e}return!0});this.retrySubscribeIceFailedTask=()=>d(this,null,function*(){if(this.subscribeConnection&&this.subscribeConnection.connectionState!=="connected"){let e=new Promise((i,r)=>{this.callbacks.set(Ee,{promise:{resolve:i,reject:r},action:"RESTART_ICE",extra:{}})}),t=new Promise(i=>{setTimeout(i,6e4,!1)});return Promise.race([e,t])}return!0});this.retrySignalDisconnectTask=()=>d(this,null,function*(){var t;c.d(M,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),this.signal.isConnected||(yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId));let e=(t=this.store.getRoom())!=null&&t.joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),e});var l,p;this.webrtcInternals=new Ke(this.store,this.eventBus,(l=this.publishConnection)==null?void 0:l.nativeConnection,(p=this.subscribeConnection)==null?void 0:p.nativeConnection);let o=(u,g)=>d(this,null,function*(){u!==this.state&&(this.state=u,yield this.observer.onStateChange(this.state,g))});this.retryScheduler=new Yt(o,this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe(u=>{var T,v;let g=((v=(T=u.getLocalPeerStats())==null?void 0:T.subscribe)==null?void 0:v.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,g)}),this.eventBus.localAudioEnabled.subscribe(({track:u})=>this.trackUpdate(u)),this.eventBus.localVideoEnabled.subscribe(({track:u})=>this.trackUpdate(u))}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var r;let t=(r=this.initConfig)==null?void 0:r.config;return((t==null?void 0:t.enabledFlags)||[]).includes(e)}preview(e,t,i,r,s=!1){return d(this,null,function*(){let a=yield this.connect(e,t,i,r,s);return this.state="Preview",this.observer.onStateChange(this.state),a})}join(e,t,i,r,s=!1){return d(this,null,function*(){c.d(M,"join: started \u23F0");try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,r,t,i,s)),this.validateNotDisconnected("connect"),this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,s),yield this.initRtcStatsMonitor(),c.d(M,"\u2705 join: Negotiated over PUBLISH connection"))}catch(a){c.e(M,`join: failed \u274C [token=${e}]`,a),this.state="Failed";let o=a;throw o.isTerminal=o.isTerminal||o.code===500,yield this.observer.onStateChange(this.state,o),o}c.d(M,"\u2705 join: successful"),this.state="Joined",this.observer.onStateChange(this.state)})}connect(e,t,i,r,s=!1){return d(this,null,function*(){this.setTransportStateForConnect(),this.joinParameters=new Qt(e,i,r.name,r.metaData,t,s);try{return yield this.internalConnect(e,t,i)}catch(a){if(a instanceof S&&([E.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,E.WebSocketConnectionErrors.FAILED_TO_CONNECT,E.WebSocketConnectionErrors.ABNORMAL_CLOSE,E.APIErrors.ENDPOINT_UNREACHABLE].includes(a.code)||a.code.toString().startsWith("5")||a.code.toString().startsWith("429"))){let l=()=>d(this,null,function*(){return yield this.internalConnect(e,t,i),!!(this.initConfig&&this.initConfig.endpoint)});yield this.retryScheduler.schedule({category:0,error:a,task:l,originalState:this.state,maxFailedRetries:5,changeState:!1})}else throw a}})}leave(e){return d(this,null,function*(){var t,i,r,s,a;this.retryScheduler.reset(),this.joinParameters=void 0,c.d(M,"leaving in transport");try{if(this.state="Leaving",(t=this.publishStatsAnalytics)==null||t.stop(),(i=this.subscribeStatsAnalytics)==null||i.stop(),(r=this.webrtcInternals)==null||r.cleanup(),yield(s=this.publishConnection)==null?void 0:s.close(),yield(a=this.subscribeConnection)==null?void 0:a.close(),e)try{this.signal.leave(),c.d(M,"signal leave done")}catch(o){c.w(M,"failed to send leave on websocket to server",o)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(o){this.eventBus.analytics.publish(P.disconnect(o)),c.e(M,"leave: FAILED \u274C",o)}finally{this.state="Disconnected",this.observer.onStateChange(this.state)}})}publish(e){return d(this,null,function*(){for(let t of e)try{yield this.publishTrack(t)}catch(i){this.eventBus.analytics.publish(P.publish({devices:this.deviceManager.getDevices(),error:i}))}})}unpublish(e){return d(this,null,function*(){for(let t of e)yield this.unpublishTrack(t)})}sendMessage(e){return d(this,null,function*(){return yield this.signal.broadcast(e)})}trackUpdate(e){let i=Array.from(this.trackStates.values()).find(r=>e.type===r.type&&e.source===r.source);if(i){let r=new ze(y(m({},i),{mute:!e.enabled}));this.trackStates.set(i.track_id,r),c.d(M,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[i.track_id,r]]))}}changeRole(e,t,i=!1){return d(this,null,function*(){yield this.signal.requestRoleChange({requested_for:e,role:t,force:i})})}changeRoleOfPeer(e,t,i){return d(this,null,function*(){yield this.signal.requestRoleChange({requested_for:e,role:t,force:i})})}changeRoleOfPeersWithRoles(e,t){return d(this,null,function*(){yield this.signal.requestBulkRoleChange({roles:e.map(i=>i.name),role:t,force:!0})})}acceptRoleChange(e){return d(this,null,function*(){var t;yield this.signal.acceptRoleChangeRequest({requested_by:(t=e.requestedBy)==null?void 0:t.peerId,role:e.role.name,token:e.token})})}endRoom(e,t){return d(this,null,function*(){yield this.signal.endRoom(e,t)})}removePeer(e,t){return d(this,null,function*(){yield this.signal.removePeer({requested_for:e,reason:t})})}startRTMPOrRecording(e){return d(this,null,function*(){var i;let t={meeting_url:e.meetingURL,record:e.record};(i=e.rtmpURLs)!=null&&i.length&&(t.rtmp_urls=e.rtmpURLs),e.resolution&&(t.resolution=e.resolution),yield this.signal.startRTMPOrRecording(t)})}stopRTMPOrRecording(){return d(this,null,function*(){yield this.signal.stopRTMPAndRecording()})}startHLSStreaming(e){return d(this,null,function*(){let t={};e&&e.variants&&e.variants.length>0&&(t.variants=e.variants.map(i=>{let r={meeting_url:i.meetingURL};return i.metadata&&(r.metadata=i.metadata),r})),e!=null&&e.recording&&(t.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield this.signal.startHLSStreaming(t)})}stopHLSStreaming(e){return d(this,null,function*(){var t;if(e){let i={variants:(t=e==null?void 0:e.variants)==null?void 0:t.map(r=>{let s={meeting_url:r.meetingURL};return r.metadata&&(s.metadata=r.metadata),s})};yield this.signal.stopHLSStreaming(i)}yield this.signal.stopHLSStreaming()})}sendHLSTimedMetadata(e){return d(this,null,function*(){if(e.length>0){let t={metadata_objs:e};yield this.signal.sendHLSTimedMetadata(t)}})}changeName(e){return d(this,null,function*(){let t=this.store.getLocalPeer();t&&t.name!==e&&(yield this.signal.updatePeer({name:e}))})}changeMetadata(e){return d(this,null,function*(){yield this.signal.updatePeer({data:e})})}getSessionMetadata(e){return this.signal.getSessionMetadata(e)}setSessionMetadata(e){return this.signal.setSessionMetadata(e)}listenMetadataChange(e){return this.signal.listenMetadataChange(e)}setPollInfo(e){return this.signal.setPollInfo(e)}fetchLeaderboard(e){return d(this,null,function*(){return this.signal.fetchPollLeaderboard(e)})}getPollInfo(e){return this.signal.getPollInfo(e)}setPollQuestions(e){return this.signal.setPollQuestions(e)}getPollQuestions(e){return this.signal.getPollQuestions(e)}startPoll(e){return this.signal.startPoll(e)}stopPoll(e){return this.signal.stopPoll(e)}setPollResponses(e){return this.signal.setPollResponses(e)}getPollResponses(e){return this.signal.getPollResponses(e)}getPollsList(e){return this.signal.getPollsList(e)}getPollResult(e){return this.signal.getPollResult(e)}getWhiteboard(e){return this.signal.getWhiteboard(e)}createWhiteboard(e){return this.signal.createWhiteboard(e)}joinGroup(e){return d(this,null,function*(){return this.signal.joinGroup(e)})}leaveGroup(e){return d(this,null,function*(){return this.signal.leaveGroup(e)})}addToGroup(e,t){return d(this,null,function*(){this.signal.addToGroup(e,t)})}removeFromGroup(e,t){return d(this,null,function*(){this.signal.removeFromGroup(e,t)})}findPeers(e){return this.signal.findPeers(e)}peerIterNext(e){return this.signal.peerIterNext(e)}changeTrackState(e){return d(this,null,function*(){yield this.signal.requestTrackStateChange(e)})}changeMultiTrackState(e){return d(this,null,function*(){yield this.signal.requestMultiTrackStateChange(e)})}publishTrack(e){return d(this,null,function*(){e.publishedTrackId=e.getTrackIDBeingSent(),c.d(M,`\u23F3 publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,`${e}`),this.trackStates.set(e.publishedTrackId,new ze(e));let t=new Promise((s,a)=>{this.callbacks.set(fe,{promise:{resolve:s,reject:a},action:"PUBLISH",extra:{}})}),i=e.stream;i.setConnection(this.publishConnection);let r=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,r),c.time(`publish-${e.trackId}-${e.type}`),yield t,c.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e),yield i.setMaxBitrateAndFramerate(e).then(()=>{c.d(M,`Setting maxBitrate=${e.settings.maxBitrate} kpbs${e instanceof F?` and maxFramerate=${e.settings.maxFramerate}`:""} for ${e.source} ${e.type} ${e.trackId}`)}).catch(s=>c.w(M,"Failed setting maxBitrate and maxFramerate",s)),e.isPublished=!0,c.d(M,`\u2705 publishTrack: trackId=${e.trackId}`,`${e}`,this.callbacks)})}unpublishTrack(e){return d(this,null,function*(){if(c.d(M,`\u23F3 unpublishTrack: trackId=${e.trackId}`,`${e}`),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let s=Array.from(this.trackStates.values()).find(a=>e.type===a.type&&e.source===a.source);s&&this.trackStates.delete(s.track_id)}let t=new Promise((r,s)=>{this.callbacks.set(fe,{promise:{resolve:r,reject:s},action:"UNPUBLISH",extra:{}})});e.stream.removeSender(e),yield t,yield e.cleanup(),this.store.removeTrack(e),c.d(M,`\u2705 unpublishTrack: trackId=${e.trackId}`,this.callbacks)})}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise(e=>{this.eventBus.policyChange.subscribeOnce(()=>e())})}createConnectionsAndNegotiateJoin(e,t=!1){return d(this,null,function*(){let i=this.doesLocalPeerNeedWebRTC();i&&this.createPeerConnections(),this.analyticsTimer.start("join_response_time"),yield this.negotiateJoinWithRetry({name:e.name,data:e.metaData,autoSubscribeVideo:t,isWebRTC:i}),this.analyticsTimer.end("join_response_time")})}createPeerConnections(){this.initConfig&&(this.publishConnection||(this.publishConnection=new rt(this.signal,this.initConfig.rtcConfiguration,this.publishConnectionObserver)),this.subscribeConnection||(this.subscribeConnection=new at(this.signal,this.initConfig.rtcConfiguration,this.isFlagEnabled.bind(this),this.subscribeConnectionObserver)))}negotiateJoinWithRetry(s){return d(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){try{yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})}catch(a){c.e(M,"Join negotiation failed \u274C",a);let o=a instanceof S?a:h.WebsocketMethodErrors.ServerErrors(500,"JOIN",`Websocket join error - ${a.message}`),l=parseInt(`${o.code/100}`)===5||[E.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,429].includes(o.code);if(o.code===410&&(o.isTerminal=!0),l){this.joinRetryCount=0,o.isTerminal=!1;let p=()=>d(this,null,function*(){return this.joinRetryCount++,yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})});yield this.retryScheduler.schedule({category:2,error:o,task:p,originalState:"Joined",maxFailedRetries:3,changeState:!1})}else throw a}})}negotiateJoin(s){return d(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){return r?yield this.negotiateJoinWebRTC({name:e,data:t,autoSubscribeVideo:i}):yield this.negotiateJoinNonWebRTC({name:e,data:t,autoSubscribeVideo:i})})}negotiateJoinWebRTC(r){return d(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i}){if(c.d(M,"\u23F3 join: Negotiating over PUBLISH connection"),!this.publishConnection)return c.e(M,"Publish peer connection not found, cannot negotiate"),!1;let s=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(s);let a=this.isFlagEnabled("subscribeDegradation"),o=this.isFlagEnabled("simulcast"),l=this.isFlagEnabled("onDemandTracks"),p=yield this.signal.join(e,t,!i,a,o,l,s);yield this.publishConnection.setRemoteDescription(p);for(let u of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(u);return this.publishConnection.initAfterJoin(),!!p})}negotiateJoinNonWebRTC(r){return d(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i}){c.d(M,"\u23F3 join: Negotiating Non-WebRTC");let s=this.isFlagEnabled("subscribeDegradation"),a=this.isFlagEnabled("simulcast"),o=this.isFlagEnabled("onDemandTracks");return!!(yield this.signal.join(e,t,!i,s,a,o))})}negotiateOnFirstPublish(){return d(this,null,function*(){if(c.d(M,"\u23F3 Negotiating offer over PUBLISH connection"),!this.publishConnection)return c.e(M,"Publish peer connection not found, cannot negotiate"),!1;let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);yield this.publishConnection.setRemoteDescription(t);for(let i of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(i);return this.publishConnection.initAfterJoin(),!!t})}performPublishRenegotiation(e){return d(this,null,function*(){c.d(M,"\u23F3 [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(fe);if(t){if(!this.publishConnection){c.e(M,"Publish peer connection not found, cannot renegotiate");return}try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),c.time("renegotiation-offer-exchange");let r=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(fe),c.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(r),t.promise.resolve(!0),c.d(M,"[role=PUBLISH] onRenegotiationNeeded DONE \u2705")}catch(i){let r;i instanceof S?r=i:r=h.GenericErrors.Unknown("PUBLISH",i.message),t.promise.reject(r),c.d(M,"[role=PUBLISH] onRenegotiationNeeded FAILED \u274C")}}})}handleIceConnectionFailure(e,t){return d(this,null,function*(){this.retryScheduler.isTaskInProgress(0?3:4)||(e===0?this.retryScheduler.schedule({category:3,error:t,task:this.retryPublishIceFailedTask,originalState:"Joined"}):this.retryScheduler.schedule({category:4,error:t,task:this.retrySubscribeIceFailedTask,originalState:"Joined",maxFailedRetries:1}))})}internalConnect(e,t,i){return d(this,null,function*(){var s;c.d(M,"connect: started \u23F0");let r=new Date;try{this.analyticsTimer.start("init_response_time"),this.initConfig=yield nt.fetchInitConfig({token:e,peerId:i,userAgent:this.store.getUserAgent(),initEndpoint:t});let a=this.store.getRoom();return a&&(a.effectsKey=(s=this.initConfig.config.vb)==null?void 0:s.effectsKey,a.isEffectsEnabled=this.isFlagEnabled("effectsSDKEnabled")),this.analyticsTimer.end("init_response_time"),X.setWebsocketEndpoint(this.initConfig.endpoint),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),this.observer.onConnected(),this.store.setSimulcastEnabled(this.isFlagEnabled("simulcast")),c.d(M,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(a){throw this.state!=="Reconnecting"&&this.eventBus.analytics.publish(P.connect(a,this.getAdditionalAnalyticsProperties(),r,new Date,t)),c.e(M,"\u274C internal connect: failed",a),a}})}validateNotDisconnected(e){if(this.state==="Disconnected")throw c.w(M,"aborting join as transport state is disconnected"),h.GenericErrors.ValidationFailed(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return d(this,null,function*(){if(!this.initConfig)throw h.APIErrors.InitConfigNotAvailable("INIT","Init Config not found");c.d(M,"\u23F3 internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent_v2",this.store.getUserAgent()),i.searchParams.set("protocol_version",Vi),i.searchParams.set("protocol_spec",Wi),this.endpoint=i.toString(),this.analyticsTimer.start("ws_connect_time"),yield this.signal.open(this.endpoint),this.analyticsTimer.end("ws_connect_time"),this.analyticsTimer.start("on_policy_change_time"),this.analyticsTimer.start("room_state_time"),c.d(M,"\u2705 internal connect: connected to ws endpoint")})}initRtcStatsMonitor(){return d(this,null,function*(){var e,t,i;(i=this.webrtcInternals)==null||i.setPeerConnections({publish:(e=this.publishConnection)==null?void 0:e.nativeConnection,subscribe:(t=this.subscribeConnection)==null?void 0:t.nativeConnection}),this.initStatsAnalytics()})}initStatsAnalytics(){var e,t;this.isFlagEnabled("publishStats")&&(this.publishStatsAnalytics=new et(this.store,this.eventBus,this.getValueFromInitConfig("publishStats","maxSampleWindowSize",30),this.getValueFromInitConfig("publishStats","maxSamplePushInterval",300)),(e=this.getWebrtcInternals())==null||e.start()),this.isFlagEnabled("subscribeStats")&&(this.subscribeStatsAnalytics=new tt(this.store,this.eventBus,this.getValueFromInitConfig("subscribeStats","maxSampleWindowSize",10),this.getValueFromInitConfig("subscribeStats","maxSamplePushInterval",60)),(t=this.getWebrtcInternals())==null||t.start())}getValueFromInitConfig(e,t,i){var r,s;return((s=(r=this.initConfig)==null?void 0:r.config[e])==null?void 0:s[t])||i}doesRoleNeedWebRTC(e){var r,s;if(!this.isFlagEnabled("nonWebRTCDisableOffer"))return!0;let t=!!(e.publishParams.allowed&&((r=e.publishParams.allowed)==null?void 0:r.length)>0),i=!!(e.subscribeParams.subscribeToRoles&&((s=e.subscribeParams.subscribeToRoles)==null?void 0:s.length)>0);return t||i}doesLocalPeerNeedWebRTC(){var t;let e=(t=this.store.getLocalPeer())==null?void 0:t.role;return e?this.doesRoleNeedWebRTC(e):!0}handleSubscribeConnectionConnected(){var t;(t=this.subscribeConnection)==null||t.logSelectedIceCandidatePairs();let e=this.callbacks.get(Ee);this.callbacks.delete(Ee),e&&e.promise.resolve(!0)}setTransportStateForConnect(){if(this.state==="Failed"&&(this.state="Disconnected"),this.state!=="Disconnected"&&this.state!=="Reconnecting")throw h.WebsocketMethodErrors.AlreadyJoined("JOIN",`Cannot join a meeting in ${this.state} state`);this.state==="Disconnected"&&(this.state="Connecting",this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let i=this.getAdditionalAnalyticsProperties(),r;switch(t){case 0:r=P.connect(e,i);break;case 1:r=P.disconnect(e,i);break;case 2:r=P.join({error:e,time:this.analyticsTimer.getTimeTaken("join_time"),init_response_time:this.analyticsTimer.getTimeTaken("init_response_time"),ws_connect_time:this.analyticsTimer.getTimeTaken("ws_connect_time"),on_policy_change_time:this.analyticsTimer.getTimeTaken("on_policy_change_time"),local_audio_track_time:this.analyticsTimer.getTimeTaken("local_audio_track_time"),local_video_track_time:this.analyticsTimer.getTimeTaken("local_video_track_time"),retries_join:this.joinRetryCount});break;case 3:r=P.publish({error:e});break;case 4:r=P.subscribeFail(e);break}this.eventBus.analytics.publish(r)}getSubscribeConnection(){return this.subscribeConnection}getAdditionalAnalyticsProperties(){var a,o,l,p,u,g,T,v;let e=kr(),t=typeof document!="undefined"&&document.hidden,i=this.store.getRemoteVideoTracks().filter(A=>A.degraded).length,r=(p=(l=(o=(a=this.getWebrtcInternals())==null?void 0:a.getCurrentStats())==null?void 0:o.getLocalPeerStats())==null?void 0:l.publish)==null?void 0:p.bitrate,s=(v=(T=(g=(u=this.getWebrtcInternals())==null?void 0:u.getCurrentStats())==null?void 0:g.getLocalPeerStats())==null?void 0:T.subscribe)==null?void 0:v.bitrate;return{network_info:e,document_hidden:t,num_degraded_tracks:i,bitrate:{publish:r,subscribe:s},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}};var br=(n,e,t)=>d(void 0,null,function*(){let r=Error("something went wrong during fetch");for(let s=0;s<4;s++)try{let a=yield fetch(n,e),o=yield a.clone().json();if(t&&t.length&&!a.ok&&t.includes(o.code))throw h.APIErrors.ServerErrors(o.code,"GET_TOKEN",o.message,!1);return a}catch(a){r=a}throw["Failed to fetch","NetworkError"].some(s=>r.message.includes(s))?h.APIErrors.EndpointUnreachable("GET_TOKEN",r.message):r});function ni(n){if(!n||n.length===0)throw h.APIErrors.InvalidTokenFormat("INIT","Token cannot be an empty string or undefined or null");let e=n.split(".");if(e.length!==3)throw h.APIErrors.InvalidTokenFormat("INIT","Expected 3 '.' separate fields - header, payload and signature respectively");let t=atob(e[1]);try{let i=JSON.parse(t);return{roomId:i.room_id,userId:i.user_id,role:i.role}}catch(i){throw h.APIErrors.InvalidTokenFormat("INIT",`couldn't parse to json - ${i.message}`)}}var Ir={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,isPreviewCalled:!1,isJoinInProgress:!1,deviceManagersInitialised:!1},Rr=class{constructor(){this.TAG="[HMSSdk]:";this.transportState="Disconnected";this.analyticsTimer=new mt;this.sdkState=m({},Ir);this.playlistSettings={video:{bitrate:ci},audio:{bitrate:di}};this.handleAutoplayError=e=>{var t,i;(i=(t=this.errorListener)==null?void 0:t.onError)==null||i.call(t,e)};this.observer={onNotification:e=>{var t;if(e.method==="on-peer-leave-request"){this.handlePeerLeaveRequest(e.params);return}switch(e.method){case"on-policy-change":this.analyticsTimer.end("on_policy_change_time");break;case"peer-list":this.analyticsTimer.end("peer_list_time"),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled);break;case"room-state":this.analyticsTimer.end("room_state_time");break;default:}(t=this.notificationManager)==null||t.handleNotification(e,this.sdkState.isReconnecting)},onConnected:()=>{this.initNotificationManager()},onTrackAdd:e=>{var t;(t=this.notificationManager)==null||t.handleTrackAdd(e)},onTrackRemove:e=>{var t;(t=this.notificationManager)==null||t.handleTrackRemove(e)},onFailure:e=>{var t;(t=this.errorListener)==null||t.onError(e)},onStateChange:(e,t)=>d(this,null,function*(){var r,s;let i=a=>d(this,null,function*(){var o,l;yield this.internalLeave(!0,a),!this.sdkState.isPreviewInProgress&&!this.sdkState.isJoinInProgress&&((l=(o=this.errorListener)==null?void 0:o.onError)==null||l.call(o,a)),this.sdkState.isReconnecting=!1});switch(e){case"Preview":case"Joined":this.initNotificationManager(),this.transportState==="Reconnecting"&&((r=this.listener)==null||r.onReconnected());break;case"Failed":yield i(t);break;case"Reconnecting":this.sdkState.isReconnecting=!0,(s=this.listener)==null||s.onReconnecting(t);break}this.transportState=e,c.d(this.TAG,"Transport State Change",this.transportState)})};this.handlePeerLeaveRequest=e=>{var r;let t=e.requested_by?this.store.getPeerById(e.requested_by):void 0,i={roomEnded:e.room_end,reason:e.reason,requestedBy:t};(r=this.listener)==null||r.onRemovedFromRoom(i),this.internalLeave(!1)};this.handleDeviceChange=e=>{var t,i,r,s,a,o;if(c.d(this.TAG,"Device Change event",e),(i=(t=this.deviceChangeListener)==null?void 0:t.onDeviceChange)==null||i.call(t,e),e.error&&e.type){let l=e.type.includes("audio")?(r=this.localPeer)==null?void 0:r.audioTrack:(s=this.localPeer)==null?void 0:s.videoTrack;(a=this.errorListener)==null||a.onError(e.error),[E.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,E.TracksErrors.DEVICE_IN_USE,E.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&l&&(l.setEnabled(!1),(o=this.listener)==null||o.onTrackUpdate(2,l,this.localPeer))}};this.handleAudioPluginError=e=>{var t;c.e(this.TAG,"Audio Plugin Error event",e),(t=this.errorListener)==null||t.onError(e)};this.handleLocalRoleUpdate=i=>d(this,[i],function*({oldRole:e,newRole:t}){var r;yield this.transport.handleLocalRoleUpdate({oldRole:e,newRole:t}),yield(r=this.roleChangeManager)==null?void 0:r.handleLocalPeerRoleUpdate({oldRole:e,newRole:t})});this.sendAudioPresenceFailed=()=>{let e=h.TracksErrors.NoAudioDetected("PREVIEW");c.w(this.TAG,"Audio Presence Failure",this.transportState,e)};this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(P.join(y(m({error:t},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("join_time"),is_preview_called:e,retries_join:this.transport.joinRetryCount})))};this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(P.preview(y(m({error:e},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("preview_time")})))};this.sendAnalyticsEvent=e=>{this.analyticsEventsService.queue(e).flush()}}initNotificationManager(){this.notificationManager||(this.notificationManager=new Wt(this.store,this.eventBus,this.transport,this.listener,this.audioListener))}initStoreAndManagers(){var e;if(this.sdkState.isInitialised){(e=this.notificationManager)==null||e.setListener(this.listener),this.audioSinkManager.setListener(this.listener),this.interactivityCenter.setListener(this.listener);return}this.sdkState.isInitialised=!0,this.store=new je,this.eventBus=new Rt,this.wakeLockManager=new At,this.networkTestManager=new kt(this.eventBus,this.listener),this.playlistManager=new Xe(this,this.eventBus),this.deviceManager=new Je(this.store,this.eventBus),this.audioSinkManager=new Qe(this.store,this.deviceManager,this.eventBus),this.audioOutput=new It(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new Y(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new bt(this.store),this.transport=new ct(this.observer,this.deviceManager,this.store,this.eventBus,this.analyticsEventsService,this.analyticsTimer),this.sessionStore=new jt(this.transport),this.interactivityCenter=new Ye(this.transport,this.store,this.listener),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError)}validateJoined(e){if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION",`Not connected - ${e}`)}sendHLSAnalytics(e){this.sendAnalyticsEvent(P.hlsPlayerError(e))}refreshDevices(){return d(this,null,function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)})}getWebrtcInternals(){var e;return(e=this.transport)==null?void 0:e.getWebrtcInternals()}getSessionStore(){return this.sessionStore}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return(e=this.store.getRoom())==null?void 0:e.recording}getRTMPState(){var e;return(e=this.store.getRoom())==null?void 0:e.rtmp}getHLSState(){var e;return(e=this.store.getRoom())==null?void 0:e.hls}getTemplateAppData(){return this.store.getTemplateAppData()}getInteractivityCenter(){return this.interactivityCenter}getPeerListIterator(e){return new ut(this.transport,this.store,e)}updatePlaylistSettings(e){e.video&&Object.assign(this.playlistSettings.video,e.video),e.audio&&Object.assign(this.playlistSettings.audio,e.audio)}get localPeer(){var e;return(e=this.store)==null?void 0:e.getLocalPeer()}preview(e,t){return d(this,null,function*(){if(mi(),hi(),this.sdkState.isPreviewInProgress)return Promise.reject(h.GenericErrors.PreviewAlreadyInProgress("PREVIEW","Preview already called"));if(["Joined","Reconnecting"].includes(this.transportState))return this.midCallPreview(e.asRole,e.settings);this.analyticsTimer.start("preview_time"),this.setUpPreview(e,t),e.alwaysRequestPermissions&&this.localTrackManager.requestPermissions().then(()=>d(this,null,function*(){yield this.initDeviceManagers()}));let i=!1,r=!1,s=setTimeout(()=>{var a,o;(!i||!r)&&((o=(a=this.listener)==null?void 0:a.onNetworkQuality)==null||o.call(a,-1))},3e3);return new Promise((a,o)=>{let l=()=>d(this,null,function*(){var T;if(this.localPeer){let v=e.asRole&&this.store.getPolicyForRole(e.asRole);this.localPeer.asRole=v||this.localPeer.role}let u=yield this.localTrackManager.getTracksToPublish(e.settings);u.forEach(v=>this.setLocalPeerTrack(v)),(T=this.localPeer)!=null&&T.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end("preview_time");let g=this.store.getRoom();g&&t.onPreview(g,u),this.sendPreviewAnalyticsEvent(),a()}),p=u=>{var g;this.analyticsTimer.end("preview_time"),u&&((g=this.errorListener)==null||g.onError(u)),this.sendPreviewAnalyticsEvent(u),this.sdkState.isPreviewInProgress=!1,o(u)};this.eventBus.policyChange.subscribeOnce(l),this.eventBus.leave.subscribeOnce(p),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe).then(u=>{var g;i=!0,clearTimeout(s),u&&e.captureNetworkQualityInPreview&&this.networkTestManager.start((g=u.config)==null?void 0:g.networkHealth).then(()=>{r=!0})}).catch(p)})})}midCallPreview(e,t){return d(this,null,function*(){var s,a;if(!this.localPeer||this.transportState!=="Joined")throw h.GenericErrors.NotConnected("VALIDATION","Not connected - midCallPreview");let i=e&&this.store.getPolicyForRole(e);if(!i)throw h.GenericErrors.InvalidRole("PREVIEW",`role ${e} does not exist in policy`);this.localPeer.asRole=i;let r=yield this.localTrackManager.getTracksToPublish(t);r.forEach(o=>this.setLocalPeerTrack(o)),(s=this.localPeer)!=null&&s.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),(a=this.listener)==null||a.onPreview(this.store.getRoom(),r)})}cancelMidCallPreview(){return d(this,null,function*(){var e,t,i;if((!this.localPeer||!this.localPeer.isInPreview())&&c.w(this.TAG,"Cannot cancel mid call preview as preview is not in progress"),(e=this.localPeer)!=null&&e.asRole&&this.localPeer.role){let r=this.localPeer.asRole,s=this.localPeer.role;delete this.localPeer.asRole,yield(t=this.roleChangeManager)==null?void 0:t.diffRolesAndPublishTracks({oldRole:r,newRole:s}),(i=this.listener)==null||i.onPeerUpdate(8,this.localPeer)}})}join(e,t){return d(this,null,function*(){var l,p,u,g,T,v;if(mi(),hi(),this.sdkState.isPreviewInProgress)throw h.GenericErrors.NotReady("JOIN","Preview is in progress, can't join");this.analyticsTimer.start("join_time"),this.sdkState.isJoinInProgress=!0;let{roomId:i,userId:r,role:s}=ni(e.authToken),a=((p=(l=this.localPeer)==null?void 0:l.asRole)==null?void 0:p.name)||((g=(u=this.localPeer)==null?void 0:u.role)==null?void 0:g.name);(T=this.networkTestManager)==null||T.stop(),this.listener=t,this.commonSetup(e,i,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),ie.resumeContext();let o=this.store.getConfig();o!=null&&o.autoManageWakeLock&&this.wakeLockManager.acquireLock(),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(s),this.localPeer.customerUserId=r,this.localPeer.metadata=e.metaData,delete this.localPeer.asRole):this.createAndAddLocalPeerToStore(e,s,r),this.roleChangeManager=new qe(this.store,this.transport,this.deviceManager,this.getAndPublishTracks.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),c.d(this.TAG,`\u23F3 Joining room ${i}`),c.time(`join-room-${i}`);try{yield this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData},e.initEndpoint,e.autoVideoSubscribe),c.d(this.TAG,`\u2705 Joined room ${i}`),this.analyticsTimer.start("peer_list_time"),yield this.notifyJoin(),this.sdkState.isJoinInProgress=!1,yield this.publish(e.settings,a)}catch(A){throw this.analyticsTimer.end("join_time"),this.sdkState.isJoinInProgress=!1,(v=this.listener)==null||v.onError(A),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled,A),c.e(this.TAG,"Unable to join room",A),A}c.timeEnd(`join-room-${i}`)})}stringifyMetadata(e){e.metaData&&typeof e.metaData!="string"?e.metaData=JSON.stringify(e.metaData):e.metaData||(e.metaData="")}cleanup(){var e,t,i;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.analyticsTimer.cleanup(),D.cleanup(),this.playlistManager.cleanup(),(e=this.wakeLockManager)==null||e.cleanup(),Y.cleanup(),this.notificationManager=void 0,c.cleanup(),this.sdkState=m({},Ir),this.localPeer&&((t=this.localPeer.audioTrack)==null||t.cleanup(),this.localPeer.audioTrack=void 0,(i=this.localPeer.videoTrack)==null||i.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanup(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.handleLocalRoleUpdate)}leave(e){return this.internalLeave(e)}internalLeave(e=!0,t){return d(this,null,function*(){var r,s,a;let i=(r=this.store)==null?void 0:r.getRoom();if(i){for(;(this.sdkState.isPreviewInProgress||this.sdkState.isJoinInProgress)&&!(t!=null&&t.isTerminal);)yield K(100);let o=i.id;(s=this.networkTestManager)==null||s.stop(),this.eventBus.leave.publish(t),c.d(this.TAG,`\u23F3 Leaving room ${o}`),yield(a=this.transport)==null?void 0:a.leave(e),this.cleanup(),c.d(this.TAG,`\u2705 Left room ${o}`)}})}getAuthTokenByRoomCode(e,t){return d(this,null,function*(){let i=(t||{}).endpoint||"https://auth.100ms.live/v2/token";this.analyticsTimer.start("GET_TOKEN");let r=yield br(i,{method:"POST",body:JSON.stringify({code:e.roomCode,user_id:e.userId})},[429,500,501,502,503,504,505,506,507,508,509,510,511]),s=yield r.json();if(this.analyticsTimer.end("GET_TOKEN"),!r.ok)throw h.APIErrors.ServerErrors(s.code,"GET_TOKEN",s.message,!1);let{token:a}=s;if(!a)throw Error(s.message);return a})}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){return this.store.getPeers()}getPeerMap(){return this.store.getPeerMap()}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return d(this,null,function*(){return yield this.sendMessageInternal({message:e,type:t})})}sendGroupMessage(e,t,i){return d(this,null,function*(){let r=this.store.getKnownRoles();if((t.filter(a=>r[a.name])||[]).length===0)throw h.GenericErrors.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})})}sendDirectMessage(e,t,i){return d(this,null,function*(){var a,o;if(((a=this.localPeer)==null?void 0:a.peerId)===t)throw h.GenericErrors.ValidationFailed("Cannot send message to self");let r=!!((o=this.store.getRoom())!=null&&o.large_room_optimization),s=this.store.getPeerById(t);if(!s)if(r){let{peers:l}=yield this.transport.findPeers({peers:[t],limit:1});if(l.length===0)throw h.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);s=B(l[0],this.store)}else throw h.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);return yield this.sendMessageInternal({message:e,recipientPeer:s,type:i})})}sendMessageInternal(s){return d(this,arguments,function*({recipientRoles:e,recipientPeer:t,type:i="chat",message:r}){if(r.replace(/\u200b/g," ").trim()==="")throw c.w(this.TAG,"sendMessage","Ignoring empty message send"),h.GenericErrors.ValidationFailed("Empty message not allowed");let a=new ce({sender:this.localPeer,type:i,message:r,recipientPeer:t,recipientRoles:e,time:new Date});c.d(this.TAG,"Sending Message: ",a);let o=yield this.transport.sendMessage(a);return a.time=new Date(o.timestamp),a.id=o.message_id,a})}startScreenShare(e,t){return d(this,null,function*(){var o,l,p;let i=this.store.getPublishParams();if(!i)return;let{allowed:r}=i;if(!(r&&r.includes("screen"))){c.e(this.TAG,`Role ${(o=this.localPeer)==null?void 0:o.role} cannot share screen`);return}if((p=(l=this.localPeer)==null?void 0:l.auxiliaryTracks)!=null&&p.find(u=>u.source==="screen"))throw Error("Cannot share multiple screens");let a=yield this.getScreenshareTracks(e,t);if(!this.localPeer){c.d(this.TAG,"Screenshared when not connected"),a.forEach(u=>{u.cleanup()});return}yield this.transport.publish(a),a.forEach(u=>{var g,T,v;u.peerId=(g=this.localPeer)==null?void 0:g.peerId,(T=this.localPeer)==null||T.auxiliaryTracks.push(u),(v=this.listener)==null||v.onTrackUpdate(0,u,this.localPeer)})})}stopEndedScreenshare(e){return d(this,null,function*(){c.d(this.TAG,"\u2705 Screenshare ended natively"),yield this.stopScreenShare(),e()})}stopScreenShare(){return d(this,null,function*(){var t;c.d(this.TAG,"\u2705 Screenshare ended from app");let e=(t=this.localPeer)==null?void 0:t.auxiliaryTracks.filter(i=>i.source==="screen");if(e)for(let i of e)yield this.removeTrack(i.trackId)})}addTrack(e,t="regular"){return d(this,null,function*(){var p,u,g,T;if(!e){c.w(this.TAG,"Please pass a valid MediaStreamTrack");return}if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find(v=>v.trackId===e.id))return;let r=e.kind,s=new MediaStream([e]),a=new ne(s),o=r==="audio"?Se:F,l=new o(a,e,t,this.eventBus);this.setPlaylistSettings({track:e,hmsTrack:l,source:t}),yield(p=this.transport)==null?void 0:p.publish([l]),l.peerId=(u=this.localPeer)==null?void 0:u.peerId,(g=this.localPeer)==null||g.auxiliaryTracks.push(l),(T=this.listener)==null||T.onTrackUpdate(0,l,this.localPeer)})}removeTrack(e,t=!1){return d(this,null,function*(){var r;if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot removeTrack");let i=this.localPeer.auxiliaryTracks.findIndex(s=>s.trackId===e);if(i>-1){let s=this.localPeer.auxiliaryTracks[i];s.isPublished?yield this.transport.unpublish([s]):yield s.cleanup(),t||this.stopPlaylist(s),this.localPeer.auxiliaryTracks.splice(i,1),(r=this.listener)==null||r.onTrackUpdate(1,s,this.localPeer)}else c.w(this.TAG,`No track found for ${e}`)})}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){c.level=e}addAudioListener(e){var t;this.audioListener=e,(t=this.notificationManager)==null||t.setAudioListener(e)}addConnectionQualityListener(e){var t;(t=this.notificationManager)==null||t.setConnectionQualityListener(e)}changeRole(e,t,i=!1){return d(this,null,function*(){var r;yield(r=this.transport)==null?void 0:r.changeRoleOfPeer(e,t,i)})}changeRoleOfPeer(e,t,i=!1){return d(this,null,function*(){var r;yield(r=this.transport)==null?void 0:r.changeRoleOfPeer(e,t,i)})}changeRoleOfPeersWithRoles(e,t){return d(this,null,function*(){var i;e.length<=0||!t||(yield(i=this.transport)==null?void 0:i.changeRoleOfPeersWithRoles(e,t))})}acceptChangeRole(e){return d(this,null,function*(){var t;yield(t=this.transport)==null?void 0:t.acceptRoleChange(e)})}endRoom(e,t){return d(this,null,function*(){var i;if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot end room");yield(i=this.transport)==null?void 0:i.endRoom(e,t),yield this.leave()})}removePeer(e,t){return d(this,null,function*(){var i;if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot remove peer");yield(i=this.transport)==null?void 0:i.removePeer(e,t)})}startRTMPOrRecording(e){return d(this,null,function*(){var t;if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start streaming or recording");yield(t=this.transport)==null?void 0:t.startRTMPOrRecording(e)})}stopRTMPAndRecording(){return d(this,null,function*(){var e;if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop streaming or recording");yield(e=this.transport)==null?void 0:e.stopRTMPOrRecording()})}startHLSStreaming(e){return d(this,null,function*(){var t;if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot start HLS streaming");yield(t=this.transport)==null?void 0:t.startHLSStreaming(e)})}stopHLSStreaming(e){return d(this,null,function*(){var t;if(!this.localPeer)throw h.GenericErrors.NotConnected("VALIDATION","No local peer present, cannot stop HLS streaming");yield(t=this.transport)==null?void 0:t.stopHLSStreaming(e)})}sendHLSTimedMetadata(e){return d(this,null,function*(){var t;this.validateJoined("sendHLSTimedMetadata"),yield(t=this.transport)==null?void 0:t.sendHLSTimedMetadata(e)})}changeName(e){return d(this,null,function*(){var t,i;this.validateJoined("changeName"),yield(t=this.transport)==null?void 0:t.changeName(e),(i=this.notificationManager)==null||i.updateLocalPeer({name:e})})}changeMetadata(e){return d(this,null,function*(){var t,i;this.validateJoined("changeMetadata"),yield(t=this.transport)==null?void 0:t.changeMetadata(e),(i=this.notificationManager)==null||i.updateLocalPeer({metadata:e})})}setSessionMetadata(e){return d(this,null,function*(){yield this.transport.setSessionMetadata({key:"default",data:e})})}getSessionMetadata(){return d(this,null,function*(){return(yield this.transport.getSessionMetadata("default")).data})}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return d(this,null,function*(){var r;if(e.type==="video"&&e.source!=="regular"){c.w(this.TAG,"Muting non-regular video tracks is currently not supported");return}if(e.enabled===t){c.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);return}if(!this.store.getTrackById(e.trackId))throw h.GenericErrors.ValidationFailed("No track found for change track state",e);let i=this.store.getPeerByTrackId(e.trackId);if(!i)throw h.GenericErrors.ValidationFailed("No peer found for change track state",e);yield(r=this.transport)==null?void 0:r.changeTrackState({requested_for:i.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})})}changeMultiTrackState(e){return d(this,null,function*(){var a;if(typeof e.enabled!="boolean")throw h.GenericErrors.ValidationFailed("Pass a boolean for enabled");let{enabled:t,roles:i,type:r,source:s}=e;yield(a=this.transport)==null?void 0:a.changeMultiTrackState({value:!t,type:r,source:s,roles:i==null?void 0:i.map(o=>o==null?void 0:o.name)})})}raiseLocalPeerHand(){return d(this,null,function*(){this.validateJoined("raiseLocalPeerHand"),yield this.transport.joinGroup(Q)})}lowerLocalPeerHand(){return d(this,null,function*(){this.validateJoined("lowerLocalPeerHand"),yield this.transport.leaveGroup(Q)})}raiseRemotePeerHand(e){return d(this,null,function*(){yield this.transport.addToGroup(e,Q)})}lowerRemotePeerHand(e){return d(this,null,function*(){yield this.transport.removeFromGroup(e,Q)})}setFrameworkInfo(e){this.frameworkInfo=m(m({},this.frameworkInfo),e)}attachVideo(e,t){return d(this,null,function*(){let i=this.store.getConfig();i!=null&&i.autoManageVideo?e.attach(t):yield e.addSink(t)})}detachVideo(e,t){return d(this,null,function*(){let i=this.store.getConfig();i!=null&&i.autoManageVideo?e.detach(t):yield e.removeSink(t)})}publish(e,t){return d(this,null,function*(){var i,r,s;if([this.store.getPublishParams(),!this.sdkState.published,!ue].every(a=>!!a)){let a=t&&t!==((r=(i=this.localPeer)==null?void 0:i.role)==null?void 0:r.name)?()=>{var o;return(o=this.roleChangeManager)==null?void 0:o.diffRolesAndPublishTracks({oldRole:this.store.getPolicyForRole(t),newRole:this.localPeer.role})}:()=>this.getAndPublishTracks(e);yield(s=a==null?void 0:a())==null?void 0:s.catch(o=>{var l;c.e(this.TAG,"Error in publish",o),(l=this.listener)==null||l.onError(o)})}})}getAndPublishTracks(e){return d(this,null,function*(){var i,r;let t=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(t),(r=(i=this.localPeer)==null?void 0:i.audioTrack)==null||r.initAudioLevelMonitor(),this.sdkState.published=!0})}setAndPublishTracks(e){return d(this,null,function*(){var t;for(let i of e)yield this.transport.publish([i]),this.setLocalPeerTrack(i),(t=this.listener)==null||t.onTrackUpdate(0,i,this.localPeer);yield this.initDeviceManagers()})}setLocalPeerTrack(e){var t;switch(e.peerId=(t=this.localPeer)==null?void 0:t.peerId,e.type){case"audio":this.localPeer.audioTrack=e;break;case"video":this.localPeer.videoTrack=e;break}}initDeviceManagers(){return d(this,null,function*(){var e,t,i,r,s;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),(yield this.deviceManager.updateOutputDevice((t=(e=this.store.getConfig())==null?void 0:e.settings)==null?void 0:t.audioOutputDeviceId))||(yield this.deviceManager.updateOutputDevice((r=(i=D.getSelection())==null?void 0:i.audioOutput)==null?void 0:r.deviceId)),this.audioSinkManager.init((s=this.store.getConfig())==null?void 0:s.audioSinkElementId))})}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanup(),this.audioSinkManager.cleanup()}initPreviewTrackAudioLevelMonitor(){var t;let e=(t=this.localPeer)==null?void 0:t.audioTrack;e==null||e.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe(i=>{var s;let r=i&&i.track.trackId===(e==null?void 0:e.trackId)?[{audioLevel:i.audioLevel,peer:this.localPeer,track:e}]:[];this.store.updateSpeakers(r),(s=this.audioListener)==null||s.onAudioLevelUpdate(r)}),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var i;let e=this.store.getLocalPeer(),t=this.store.getRoom();if(!t){c.w(this.TAG,"notify join - room not present");return}if(t.joinedAt=new Date,e&&(e.joinedAt=t.joinedAt),e!=null&&e.role){this.analyticsTimer.end("join_time"),(i=this.listener)==null||i.onJoin(t);return}return new Promise((r,s)=>{this.eventBus.policyChange.subscribeOnce(()=>{var a;this.analyticsTimer.end("join_time"),(a=this.listener)==null||a.onJoin(t),r()}),this.eventBus.leave.subscribeOnce(a=>{s(a)})})}setUpPreview(e,t){this.listener=t,this.sdkState.isPreviewCalled=!0,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:r,role:s}=ni(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.createAndAddLocalPeerToStore(e,s,r,e.asRole)}setPlaylistSettings(r){return d(this,arguments,function*({track:e,hmsTrack:t,source:i}){var s,a;if(i==="videoplaylist"){let o={};if(e.kind==="audio")o.maxBitrate=((s=this.playlistSettings.audio)==null?void 0:s.bitrate)||di;else{o.maxBitrate=((a=this.playlistSettings.video)==null?void 0:a.bitrate)||ci;let{width:l,height:p}=e.getSettings();o.width=l,o.height=p}yield t.setSettings(o)}else i==="audioplaylist"&&(yield t.setSettings({maxBitrate:64}))})}createAndAddLocalPeerToStore(e,t,i,r){let s=this.store.getPolicyForRole(t),a=r?this.store.getPolicyForRole(r):void 0,o=new Oe({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:s,asRole:a||s});this.store.addPeer(o)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.errorListener=i,this.deviceChangeListener=i,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.getRoom()||this.store.setRoom(new De(t))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return d(this,null,function*(){let[i,r]=yield this.localTrackManager.getLocalScreen(t),s=()=>{this.stopEndedScreenshare(e)},a=[];if(t!=null&&t.audioOnly){if(i.nativeTrack.stop(),!r)throw h.TracksErrors.NothingToReturn("TRACK","Select share audio when sharing screen","No audio found");a.push(r),r.nativeTrack.addEventListener("ended",s)}else a.push(i),i.nativeTrack.addEventListener("ended",s),r&&a.push(r);return a})}stopPlaylist(e){e.source==="audioplaylist"?this.playlistManager.stop("audio"):e.source==="videoplaylist"&&this.playlistManager.stop("video")}};export{ss as DeviceType,pt as ENV,rr as HMSAudioCodec,ie as HMSAudioContextHandler,Xi as HMSAudioPluginType,Fe as HMSAudioPluginsManager,Me as HMSAudioTrack,S as HMSException,sr as HMSFacingMode,Se as HMSLocalAudioTrack,ne as HMSLocalStream,F as HMSLocalVideoTrack,Ur as HMSLogLevel,pe as HMSMediaStream,ut as HMSPeerListIterator,Ge as HMSPeerUpdate,Ei as HMSPlaylistType,gt as HMSPluginUnsupportedTypes,ar as HMSPollQuestionType,nr as HMSPollStates,vi as HMSPollsUpdate,is as HMSRecordingState,ae as HMSRemoteAudioTrack,J as HMSRemoteStream,w as HMSRemoteVideoTrack,tr as HMSRoomUpdate,Rr as HMSSdk,ke as HMSSimulcastLayer,rs as HMSStreamingState,te as HMSTrack,he as HMSTrackType,se as HMSTrackUpdate,ir as HMSVideoCodec,ki as HMSVideoPluginCanvasContextType,Mi as HMSVideoPluginType,We as HMSVideoPluginsManager,be as HMSVideoTrack,Ke as HMSWebrtcInternals,$e as HMSWebrtcStats,to as getLocalDevices,eo as getLocalScreen,er as getLocalStream,L as isBrowser,li as isIOS,ht as isMobile,ue as isNode,Ki as isPageHidden,na as isSupported,le as parsedUserAgent,fi as simulcastMapping,Il as validateDeviceAV};
//# sourceMappingURL=index.js.map
